#include "mydriver.h"
#include "filehandling.c"
#define WRITE_DIRECT 1
#define STRSAFE_NO_DEPRECATE
#include <ntstrsafe.h>
//#include <ntintsafe.h>



//typedef NTSTATUS (*PSLOOKUPPROCESSBYPROCESSID)(HANDLE,PEPROCESS);
//typedef NTSTATUS (*ZWQUERYINFORMATIONPROCESS)(HANDLE,ULONG,PVOID,ULONG,PULONG);



//PSLOOKUPPROCESSBYPROCESSID PsLookupProcessByProcessId;

//Compiler Directives
#pragma alloc_text(INIT, DriverEntry)
#pragma alloc_text(PAGE, MyDriver_Unload)
#pragma alloc_text(PAGE, MyDriver_UnSupportedFunction)
#pragma alloc_text(PAGE, getPIDByThreadHandle)
#pragma alloc_text(PAGE, getFilenameByHandle)



#define DELAY_ONE_MICROSECOND   (-10)
#define DELAY_ONE_MILLISECOND   (DELAY_ONE_MICROSECOND * 1000)
#define DELAY_ONE_SECOND        (DELAY_ONE_MILLISECOND * 1000)

//typedef NTSTATUS (*ZWQUERYINFORMATIONTHREAD)(HANDLE,ULONG,PVOID,ULONG,PULONG);
typedef NTSTATUS (*ZWQUERYINFORMATIONPROCESS)(HANDLE,PROCESSINFOCLASS,PVOID,ULONG,PULONG);
typedef NTSTATUS (*ZwQueryInformationFilePtr)(HANDLE, PIO_STATUS_BLOCK,PVOID,ULONG,FILE_INFORMATION_CLASS);

//ZWQUERYINFORMATIONTHREAD ZwQueryInformationThread;
ZWQUERYINFORMATIONPROCESS ZwQueryInformationProcess;




/* Declaration of KeServiceDescriptorTable, which is exported by ntoskrnl.exe. */
__declspec(dllimport) SST KeServiceDescriptorTable; 
UINT32 *systemCallTable;



/* 
 * Variables to store old references to system calls
 */
//ZwSetValueKeyPtr oldZwSetValueKey;
ZwQuerySystemInformationPtr oldZwQuerySystemInformation = NULL;
//ZwOpenProcessPtr oldZwOpenProcess;
//ZwWriteVirtualMemoryPtr oldZwWriteVirtualMemory;
//ZwDebugActiveProcessPtr oldZwDebugActiveProcess;
//ZwCreateSectionPtr oldZwCreateSection;
//ZwCreateProcessPtr oldZwCreateProcess;
//ZwCreateProcessExPtr oldZwCreateProcessEx;
//ZwCreateThreadExPtr oldZwCreateThreadEx;
ZwMapViewOfSectionPtr oldZwMapViewOfSection;
ZwSetContextThreadPtr oldZwSetContextThread;
//ZwSystemDebugControlPtr oldZwSystemDebugControl;
//ZwOpenFilePtr oldZwOpenFile;
//ZwCreateFilePtr oldZwCreateFile;
ZwReadFilePtr oldZwReadFile;
//ZwDeleteFilePtr oldZwDeleteFile;
//ZwSetInformationFilePtr oldZwSetInformationFile;
//ZwCreateMutantPtr oldZwCreateMutant;
ZwDeviceIoControlFilePtr oldZwDeviceIoControlFile;
//ZwTerminateProcessPtr oldZwTerminateProcess;
//ZwLoadDriverPtr oldZwLoadDriver;
ZwDelayExecutionPtr oldZwDelayExecution;
//ZwQueryValueKeyPtr oldZwQueryValueKey;
//ZwQueryAttributesFilePtr oldZwQueryAttributesFile;
//ZwAcceptConnectPortPtr oldZwAcceptConnectPort;
ZwWaitForSingleObjectPtr oldZwWaitForSingleObject;
ZwReplyWaitReceivePortPtr oldZwReplyWaitReceivePort;
ZwRequestWaitReplyPortPtr oldZwRequestWaitReplyPort;
ZwClosePtr oldZwClose;
ZwSetEventPtr oldZwSetEvent;
ZwOpenThreadTokenPtr oldZwOpenThreadToken;
ZwOpenThreadTokenExPtr oldZwOpenThreadTokenEx;
ZwOpenKeyPtr oldZwOpenKey;
ZwAllocateVirtualMemoryPtr oldZwAllocateVirtualMemory;
ZwProtectVirtualMemoryPtr oldZwProtectVirtualMemory;
ZwQueryInformationTokenPtr oldZwQueryInformationToken;
ZwEnumerateKeyPtr oldZwEnumerateKey;
ZwFlushInstructionCachePtr oldZwFlushInstructionCache;
ZwQuerySecurityObjectPtr oldZwQuerySecurityObject;
ZwQueryDefaultLocalePtr oldZwQueryDefaultLocale;
ZwQuerySystemTimePtr oldZwQuerySystemTime;
ZwOpenSectionPtr oldZwOpenSection;
ZwSetInformationProcessPtr oldZwSetInformationProcess;
ZwQueryInformationProcessPtr oldZwQueryInformationProcess;
ZwGetContextThreadPtr oldZwGetContextThread;
ZwCreateProfilePtr oldZwCreateProfile;
ZwStartProfilePtr oldZwStartProfile;
ZwAccessCheckPtr oldZwAccessCheck;
ZwAccessCheckAndAuditAlarmPtr oldZwAccessCheckAndAuditAlarm;
ZwSetSystemInformationPtr oldZwSetSystemInformation;
ZwGetPlugPlayEventPtr oldZwGetPlugPlayEvent;
ZwPlugPlayControlPtr oldZwPlugPlayControl;
ZwLockVirtualMemoryPtr oldZwLockVirtualMemory;
ZwUnlockVirtualMemoryPtr oldZwUnlockVirtualMemory;
ZwFlushVirtualMemoryPtr oldZwFlushVirtualMemory;
ZwAllocateUserPhysicalPagesPtr oldZwAllocateUserPhysicalPages;
ZwFreeUserPhysicalPagesPtr oldZwFreeUserPhysicalPages;
ZwMapUserPhysicalPagesPtr oldZwMapUserPhysicalPages;
ZwMapUserPhysicalPagesScatterPtr oldZwMapUserPhysicalPagesScatter;
ZwGetWriteWatchPtr oldZwGetWriteWatch;
ZwResetWriteWatchPtr oldZwResetWriteWatch;
ZwFreeVirtualMemoryPtr oldZwFreeVirtualMemory;
ZwQueryVirtualMemoryPtr oldZwQueryVirtualMemory;
ZwReadVirtualMemoryPtr oldZwReadVirtualMemory;
ZwWriteVirtualMemoryPtr oldZwWriteVirtualMemory;
ZwCreateFilePtr oldZwCreateFile;
ZwOpenFilePtr oldZwOpenFile;
ZwDeleteFilePtr oldZwDeleteFile;
ZwFlushBuffersFilePtr oldZwFlushBuffersFile;
ZwCancelIoFilePtr oldZwCancelIoFile;
ZwWriteFilePtr oldZwWriteFile;
ZwReadFileScatterPtr oldZwReadFileScatter;
ZwWriteFileGatherPtr oldZwWriteFileGather;
ZwLockFilePtr oldZwLockFile;
ZwUnlockFilePtr oldZwUnlockFile;
ZwFsControlFilePtr oldZwFsControlFile;
ZwNotifyChangeDirectoryFilePtr oldZwNotifyChangeDirectoryFile;
ZwQueryEaFilePtr oldZwQueryEaFile;
ZwSetEaFilePtr oldZwSetEaFile;
ZwCreateNamedPipeFilePtr oldZwCreateNamedPipeFile;
ZwCreateMailslotFilePtr oldZwCreateMailslotFile;
ZwQueryVolumeInformationFilePtr oldZwQueryVolumeInformationFile;
ZwSetVolumeInformationFilePtr oldZwSetVolumeInformationFile;
ZwQueryQuotaInformationFilePtr oldZwQueryQuotaInformationFile;
ZwSetQuotaInformationFilePtr oldZwSetQuotaInformationFile;
ZwQueryAttributesFilePtr oldZwQueryAttributesFile;
ZwQueryFullAttributesFilePtr oldZwQueryFullAttributesFile;
ZwQueryInformationFilePtr oldZwQueryInformationFile;
ZwSetInformationFilePtr oldZwSetInformationFile;
ZwQueryDirectoryFilePtr oldZwQueryDirectoryFile;
ZwCreateKeyPtr oldZwCreateKey;
ZwDeleteKeyPtr oldZwDeleteKey;
ZwFlushKeyPtr oldZwFlushKey;
ZwSaveKeyPtr oldZwSaveKey;
ZwSaveKeyExPtr oldZwSaveKeyEx;
ZwSaveMergedKeysPtr oldZwSaveMergedKeys;
ZwRestoreKeyPtr oldZwRestoreKey;
ZwLoadKeyPtr oldZwLoadKey;
ZwLoadKey2Ptr oldZwLoadKey2;
ZwUnloadKeyPtr oldZwUnloadKey;
ZwUnloadKeyExPtr oldZwUnloadKeyEx;
ZwQueryOpenSubKeysPtr oldZwQueryOpenSubKeys;
ZwReplaceKeyPtr oldZwReplaceKey;
ZwSetInformationKeyPtr oldZwSetInformationKey;
ZwQueryKeyPtr oldZwQueryKey;
ZwNotifyChangeKeyPtr oldZwNotifyChangeKey;
ZwNotifyChangeMultipleKeysPtr oldZwNotifyChangeMultipleKeys;
ZwDeleteValueKeyPtr oldZwDeleteValueKey;
ZwSetValueKeyPtr oldZwSetValueKey;
ZwQueryValueKeyPtr oldZwQueryValueKey;
ZwEnumerateValueKeyPtr oldZwEnumerateValueKey;
ZwQueryMultipleValueKeyPtr oldZwQueryMultipleValueKey;
ZwInitializeRegistryPtr oldZwInitializeRegistry;
ZwCreatePortPtr oldZwCreatePort;
ZwCreateWaitablePortPtr oldZwCreateWaitablePort;
ZwConnectPortPtr oldZwConnectPort;
ZwSecureConnectPortPtr oldZwSecureConnectPort;
ZwListenPortPtr oldZwListenPort;
ZwAcceptConnectPortPtr oldZwAcceptConnectPort;
ZwCompleteConnectPortPtr oldZwCompleteConnectPort;
ZwRequestPortPtr oldZwRequestPort;
ZwReplyPortPtr oldZwReplyPort;
ZwReplyWaitReplyPortPtr oldZwReplyWaitReplyPort;
ZwReplyWaitReceivePortExPtr oldZwReplyWaitReceivePortEx;
ZwReadRequestDataPtr oldZwReadRequestData;
ZwWriteRequestDataPtr oldZwWriteRequestData;
ZwQueryInformationPortPtr oldZwQueryInformationPort;
ZwImpersonateClientOfPortPtr oldZwImpersonateClientOfPort;
ZwCreateProcessPtr oldZwCreateProcess;
ZwCreateProcessExPtr oldZwCreateProcessEx;
ZwOpenProcessPtr oldZwOpenProcess;
ZwTerminateProcessPtr oldZwTerminateProcess;
ZwCreateThreadPtr oldZwCreateThread;
ZwOpenThreadPtr oldZwOpenThread;
ZwTerminateThreadPtr oldZwTerminateThread;
ZwQueryInformationThreadPtr oldZwQueryInformationThread;
ZwSetInformationThreadPtr oldZwSetInformationThread;
ZwSuspendThreadPtr oldZwSuspendThread;
ZwResumeThreadPtr oldZwResumeThread;
ZwQueueApcThreadPtr oldZwQueueApcThread;
ZwTestAlertPtr oldZwTestAlert;
ZwAlertThreadPtr oldZwAlertThread;
ZwAlertResumeThreadPtr oldZwAlertResumeThread;
ZwRegisterThreadTerminatePortPtr oldZwRegisterThreadTerminatePort;
ZwImpersonateThreadPtr oldZwImpersonateThread;
ZwImpersonateAnonymousTokenPtr oldZwImpersonateAnonymousToken;
ZwQuerySystemEnvironmentValuePtr oldZwQuerySystemEnvironmentValue;
ZwQuerySystemEnvironmentValueExPtr oldZwQuerySystemEnvironmentValueEx;
ZwSetSystemEnvironmentValuePtr oldZwSetSystemEnvironmentValue;
ZwSetSystemEnvironmentValueExPtr oldZwSetSystemEnvironmentValueEx;
ZwShutdownSystemPtr oldZwShutdownSystem;
ZwSystemDebugControlPtr oldZwSystemDebugControl;
ZwQueryObjectPtr oldZwQueryObject;
ZwSetInformationObjectPtr oldZwSetInformationObject;
ZwDuplicateObjectPtr oldZwDuplicateObject;
ZwMakeTemporaryObjectPtr oldZwMakeTemporaryObject;
ZwSetSecurityObjectPtr oldZwSetSecurityObject;
ZwCreateDirectoryObjectPtr oldZwCreateDirectoryObject;
ZwOpenDirectoryObjectPtr oldZwOpenDirectoryObject;
ZwQueryDirectoryObjectPtr oldZwQueryDirectoryObject;
ZwCreateSymbolicLinkObjectPtr oldZwCreateSymbolicLinkObject;
ZwOpenSymbolicLinkObjectPtr oldZwOpenSymbolicLinkObject;
ZwQuerySymbolicLinkObjectPtr oldZwQuerySymbolicLinkObject;
ZwCreateSectionPtr oldZwCreateSection;
ZwQuerySectionPtr oldZwQuerySection;
ZwExtendSectionPtr oldZwExtendSection;
ZwUnmapViewOfSectionPtr oldZwUnmapViewOfSection;
ZwAreMappedFilesTheSamePtr oldZwAreMappedFilesTheSame;
ZwCreateJobObjectPtr oldZwCreateJobObject;
ZwOpenJobObjectPtr oldZwOpenJobObject;
ZwTerminateJobObjectPtr oldZwTerminateJobObject;
ZwAssignProcessToJobObjectPtr oldZwAssignProcessToJobObject;
ZwQueryInformationJobObjectPtr oldZwQueryInformationJobObject;
ZwSetInformationJobObjectPtr oldZwSetInformationJobObject;
ZwCreateTokenPtr oldZwCreateToken;
ZwOpenProcessTokenPtr oldZwOpenProcessToken;
ZwOpenProcessTokenExPtr oldZwOpenProcessTokenEx;
ZwDuplicateTokenPtr oldZwDuplicateToken;
ZwFilterTokenPtr oldZwFilterToken;
ZwAdjustPrivilegesTokenPtr oldZwAdjustPrivilegesToken;
ZwAdjustGroupsTokenPtr oldZwAdjustGroupsToken;
ZwSetInformationTokenPtr oldZwSetInformationToken;
ZwSignalAndWaitForSingleObjectPtr oldZwSignalAndWaitForSingleObject;
ZwWaitForMultipleObjectsPtr oldZwWaitForMultipleObjects;
ZwCreateTimerPtr oldZwCreateTimer;
ZwOpenTimerPtr oldZwOpenTimer;
ZwCancelTimerPtr oldZwCancelTimer;
ZwSetTimerPtr oldZwSetTimer;
ZwQueryTimerPtr oldZwQueryTimer;
ZwCreateEventPtr oldZwCreateEvent;
ZwOpenEventPtr oldZwOpenEvent;
ZwPulseEventPtr oldZwPulseEvent;
ZwResetEventPtr oldZwResetEvent;
ZwClearEventPtr oldZwClearEvent;
ZwQueryEventPtr oldZwQueryEvent;
ZwCreateSemaphorePtr oldZwCreateSemaphore;
ZwOpenSemaphorePtr oldZwOpenSemaphore;
ZwReleaseSemaphorePtr oldZwReleaseSemaphore;
ZwQuerySemaphorePtr oldZwQuerySemaphore;
ZwCreateMutantPtr oldZwCreateMutant;
ZwOpenMutantPtr oldZwOpenMutant;
ZwReleaseMutantPtr oldZwReleaseMutant;
ZwQueryMutantPtr oldZwQueryMutant;
ZwCreateIoCompletionPtr oldZwCreateIoCompletion;
ZwOpenIoCompletionPtr oldZwOpenIoCompletion;
ZwSetIoCompletionPtr oldZwSetIoCompletion;
ZwRemoveIoCompletionPtr oldZwRemoveIoCompletion;
ZwQueryIoCompletionPtr oldZwQueryIoCompletion;
ZwCreateEventPairPtr oldZwCreateEventPair;
ZwOpenEventPairPtr oldZwOpenEventPair;
ZwWaitLowEventPairPtr oldZwWaitLowEventPair;
ZwWaitHighEventPairPtr oldZwWaitHighEventPair;
ZwSetLowWaitHighEventPairPtr oldZwSetLowWaitHighEventPair;
ZwSetHighWaitLowEventPairPtr oldZwSetHighWaitLowEventPair;
ZwSetLowEventPairPtr oldZwSetLowEventPair;
ZwSetHighEventPairPtr oldZwSetHighEventPair;
ZwSetSystemTimePtr oldZwSetSystemTime;
ZwQueryPerformanceCounterPtr oldZwQueryPerformanceCounter;
ZwSetTimerResolutionPtr oldZwSetTimerResolution;
ZwQueryTimerResolutionPtr oldZwQueryTimerResolution;
ZwYieldExecutionPtr oldZwYieldExecution;
ZwSetIntervalProfilePtr oldZwSetIntervalProfile;
ZwQueryIntervalProfilePtr oldZwQueryIntervalProfile;
ZwStopProfilePtr oldZwStopProfile;
ZwPrivilegeCheckPtr oldZwPrivilegeCheck;
ZwPrivilegeObjectAuditAlarmPtr oldZwPrivilegeObjectAuditAlarm;
ZwPrivilegedServiceAuditAlarmPtr oldZwPrivilegedServiceAuditAlarm;
ZwAccessCheckByTypePtr oldZwAccessCheckByType;
ZwAccessCheckByTypeAndAuditAlarmPtr oldZwAccessCheckByTypeAndAuditAlarm;
ZwAccessCheckByTypeResultListPtr oldZwAccessCheckByTypeResultList;
ZwAccessCheckByTypeResultListAndAuditAlarmPtr oldZwAccessCheckByTypeResultListAndAuditAlarm;
ZwAccessCheckByTypeResultListAndAuditAlarmByHandlePtr oldZwAccessCheckByTypeResultListAndAuditAlarmByHandle;
ZwOpenObjectAuditAlarmPtr oldZwOpenObjectAuditAlarm;
ZwCloseObjectAuditAlarmPtr oldZwCloseObjectAuditAlarm;
ZwDeleteObjectAuditAlarmPtr oldZwDeleteObjectAuditAlarm;
ZwRequestWakeupLatencyPtr oldZwRequestWakeupLatency;
ZwRequestDeviceWakeupPtr oldZwRequestDeviceWakeup;
ZwCancelDeviceWakeupRequestPtr oldZwCancelDeviceWakeupRequest;
ZwIsSystemResumeAutomaticPtr oldZwIsSystemResumeAutomatic;
ZwSetThreadExecutionStatePtr oldZwSetThreadExecutionState;
ZwGetDevicePowerStatePtr oldZwGetDevicePowerState;
ZwSetSystemPowerStatePtr oldZwSetSystemPowerState;
ZwInitiatePowerActionPtr oldZwInitiatePowerAction;
ZwPowerInformationPtr oldZwPowerInformation;
ZwRaiseExceptionPtr oldZwRaiseException;
//ZwContinuePtr oldZwContinue;
ZwCallbackReturnPtr oldZwCallbackReturn;
ZwLoadDriverPtr oldZwLoadDriver;
ZwUnloadDriverPtr oldZwUnloadDriver;
ZwFlushWriteBufferPtr oldZwFlushWriteBuffer;
ZwSetDefaultLocalePtr oldZwSetDefaultLocale;
ZwQueryDefaultUILanguagePtr oldZwQueryDefaultUILanguage;
ZwSetDefaultUILanguagePtr oldZwSetDefaultUILanguage;
ZwQueryInstallUILanguagePtr oldZwQueryInstallUILanguage;
ZwAllocateLocallyUniqueIdPtr oldZwAllocateLocallyUniqueId;
ZwAllocateUuidsPtr oldZwAllocateUuids;
ZwSetUuidSeedPtr oldZwSetUuidSeed;
ZwRaiseHardErrorPtr oldZwRaiseHardError;
ZwSetDefaultHardErrorPortPtr oldZwSetDefaultHardErrorPort;
ZwDisplayStringPtr oldZwDisplayString;
ZwCreatePagingFilePtr oldZwCreatePagingFile;
ZwAddAtomPtr oldZwAddAtom;
ZwFindAtomPtr oldZwFindAtom;
ZwDeleteAtomPtr oldZwDeleteAtom;
ZwQueryInformationAtomPtr oldZwQueryInformationAtom;
ZwSetLdtEntriesPtr oldZwSetLdtEntries;
ZwVdmControlPtr oldZwVdmControl;
NtSetBootEntryOrderPtr oldNtSetBootEntryOrder;
NtCompactKeysPtr oldNtCompactKeys;
NtCompareTokensPtr oldNtCompareTokens;
NtCompressKeyPtr oldNtCompressKey;
NtCreateDebugObjectPtr oldNtCreateDebugObject;
NtCreateJobSetPtr oldNtCreateJobSet;
NtDebugActiveProcessPtr oldNtDebugActiveProcess;
NtDebugContinuePtr oldNtDebugContinue;
NtEnumerateSystemEnvironmentValuesExPtr oldNtEnumerateSystemEnvironmentValuesEx;
NtIsProcessInJobPtr oldNtIsProcessInJob;
NtLockProductActivationKeysPtr oldNtLockProductActivationKeys;
NtLockRegistryKeyPtr oldNtLockRegistryKey;
NtMakePermanentObjectPtr oldNtMakePermanentObject;
NtDeleteBootEntryPtr oldNtDeleteBootEntry;
NtQueryDebugFilterStatePtr oldNtQueryDebugFilterState;
NtRemoveProcessDebugPtr oldNtRemoveProcessDebug;
NtRenameKeyPtr oldNtRenameKey;
NtResumeProcessPtr oldNtResumeProcess;
NtSetDebugFilterStatePtr oldNtSetDebugFilterState;
NtSetEventBoostPriorityPtr oldNtSetEventBoostPriority;
NtSetInformationDebugObjectPtr oldNtSetInformationDebugObject;
NtSuspendProcessPtr oldNtSuspendProcess;
NtTraceEventPtr oldNtTraceEvent;
NtTranslateFilePathPtr oldNtTranslateFilePath;
NtWaitForDebugEventPtr oldNtWaitForDebugEvent;
NtCreateKeyedEventPtr oldNtCreateKeyedEvent;
NtOpenKeyedEventPtr oldNtOpenKeyedEvent;
NtReleaseKeyedEventPtr oldNtReleaseKeyedEvent;
NtWaitForKeyedEventPtr oldNtWaitForKeyedEvent;
NtQueryPortInformationProcessPtr oldNtQueryPortInformationProcess;
//VARIABLES_HERE

LARGE_INTEGER timeHiddenUser;
LARGE_INTEGER timeHiddenKernel;

UINT32 globalSetter = 0;
UINT32 counter = 0;
PDEVICE_OBJECT buddyDevice = NULL;

/*
 * Disable the WP bit in CR0 register.
 */
void DisableWP() {
	__asm {
		push edx;
		mov edx, cr0;
		and edx, 0xFFFEFFFF;
		mov cr0, edx;
		pop edx;
	}
}

/*
 * Enable the WP bit in CR0 register.
 */
void EnableWP() {
	__asm {
		push edx;
		mov edx, cr0;
		or edx, 0x00010000;
		mov cr0, edx;
		pop edx;
	}
}

DWORD getSSDTIndex(BYTE* address) {
	BYTE* addressOfIndex;
	DWORD indexValue;
	
	addressOfIndex = address + 1;
	indexValue = *((PULONG)addressOfIndex);
	return(indexValue);
}

/*
 * A function that hooks the 'syscall' function in SSDT without index
 */
BYTE* hookSSDTWithIndex(DWORD apiCall, BYTE* hookaddr, DWORD* callTable) {
	
	PLONG target;
	DWORD indexValue;
	indexValue = apiCall;
	target = (PLONG) &(callTable[indexValue]);
	return ((BYTE*)InterlockedExchange(target,(LONG)hookaddr));
}

/*
 * A function that hooks the 'syscall' function in SSDT.
 */
BYTE* hookSSDT(BYTE* apiCall, BYTE* hookaddr, DWORD* callTable) {
	
	PLONG target;
	DWORD indexValue;
	indexValue = getSSDTIndex(apiCall);
	target = (PLONG) &(callTable[indexValue]);
	return ((BYTE*)InterlockedExchange(target,(LONG)hookaddr));
	/* local variables */
	//UINT32 index;
	//PLONG ssdt;
	//PLONG target;
	
	/* disable WP bit in CR0 to enable writing to SSDT */
	//DisableWP();
	//DbgPrint("The WP flag in CR0 has been disabled.\r\n");
	
	/* identify the address of SSDT table */
	//ssdt = KeServiceDescriptorTable.ServiceTable;
	//DbgPrint("The system call address is %x.\r\n", syscall);
	//DbgPrint("The hook function address is %x.\r\n", hookaddr);
	//DbgPrint("The address of the SSDT is: %x.\r\n", ssdt);
	
	/* identify 'syscall' index into the SSDT table */
	//index = *((PULONG)(syscall + 0x1));
	//DbgPrint("The index into the SSDT table is: %d.\r\n", index);
	
	/* get the address of the service routine in SSDT */
	//target = (PLONG)&(ssdt[index]);
	//DbgPrint("The address of the SSDT routine to be hooked is: %x.\r\n", target);
	
	/* hook the service routine in SSDT */
	//return (PULONG)InterlockedExchange(target, *hookaddr);
}


/*
 * Hook Function.
 */
NTSTATUS Hook_ZwQuerySystemInformation(ULONG SystemInformationClass, PVOID SystemInformation, ULONG SystemInformationLength, PULONG ReturnLength) { 
	/* local variables */
	NTSTATUS status;
	
	/* calling new instructions */
    DbgPrint("ZwQuerySystemInformation hook called.\r\n"); 
	
	/* calling old function */
    status = oldZwQuerySystemInformation(SystemInformationClass, SystemInformation, SystemInformationLength, ReturnLength);
	if(!NT_SUCCESS(status)) {
		DbgPrint("The call to original ZwQuerySystemInformation did not succeed.\r\n");
	}
	return status;
}  

NTSTATUS newZwQuerySystemInformation 
(
	IN ULONG SystemInformationClass,
	IN PVOID SystemInformation,
	IN ULONG SystemInformationLength,
	OUT PULONG ReturnLength
)
{
	NTSTATUS ntStatus;
	WCHAR processName[150] = {0};
	WCHAR fullString[950] = {0};
	
	UNICODE_STRING uProcessName = {0};
	UNICODE_STRING uFullString = {0};
	counter+=1;
	
	uProcessName.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcessName.Length = 0;
	uFullString.Length = 0;
	
	RtlInitEmptyUnicodeString(&uProcessName, processName, sizeof(processName));
	RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(fullString));
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcessName);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySystemInformation,ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcessName);
	RtlAppendUnicodeToString(&uFullString, L"\r\n");
	
	RtlInitEmptyUnicodeString(&uProcessName, processName, sizeof(processName));
	RtlAppendUnicodeToString(&uProcessName, L"\\SystemRoot\\d\\ZwQuerySystemInformation.txt");
	driverWriteFile(&uFullString, &uProcessName);
	ntStatus = ((ZwQuerySystemInformationPtr)(oldZwQuerySystemInformation))
	(
		SystemInformationClass,
		SystemInformation,
		SystemInformationLength,
		ReturnLength
	);
	
	/** HIDE A PROCESS
	PSYSTEM_PROCESS_INFO cSPI; //current SYSTEM_PROCESS_INFO
	PSYSTEM_PROCESS_INFO pSPI; //previous SYSTEM_PROCESS_INFO
	//DbgPrint("[ZwQuerySystemInformation] newZwQuerySystemInformation called");
	ntStatus = ((ZwQuerySystemInformationPtr)(oldZwQuerySystemInformation))
	(
		SystemInformationClass,
		SystemInformation,
		SystemInformationLength,
		ReturnLength
	);
	if(!NT_SUCCESS(ntStatus)){ return(ntStatus);}
	
	if (SystemInformationClass == SystemProcessorPerformanceInformation) {
		PSYSTEM_PROCESSOR_PERFORMANCE_INFO timeObject;
		LONGLONG extraTime;
		
		timeObject = (PSYSTEM_PROCESSOR_PERFORMANCE_INFO)SystemInformation;
		
		extraTime = timeHiddenUser.QuadPart + timeHiddenKernel.QuadPart;
		(*timeObject).IdleTime.QuadPart = (*timeObject).IdleTime.QuadPart + extraTime;
	}
	
	if (SystemInformationClass != SystemProcessInformation) {return(ntStatus);}
	
	cSPI = (PSYSTEM_PROCESS_INFO)SystemInformation;
	pSPI = NULL;
	
	while (cSPI!=NULL) {
		if((*cSPI).ProcessName.Buffer == NULL) {
			//Null process name == System Idle Process (inject hidden task time)
			(*cSPI).UserTime.QuadPart = (*cSPI).UserTime.QuadPart + timeHiddenUser.QuadPart;
			(*cSPI).KernelTime.QuadPart = (*cSPI).KernelTime.QuadPart + timeHiddenKernel.QuadPart;
			
			timeHiddenKernel.QuadPart = 0;
			timeHiddenUser.QuadPart = 0;
		}
		else {
			if(memcmp((*cSPI).ProcessName.Buffer, L"calc.exe", 10)==0) {
				//must hide this process
				//first, track time used by hidden process
				timeHiddenUser.QuadPart = timeHiddenUser.QuadPart + (*cSPI).UserTime.QuadPart;
				timeHiddenKernel.QuadPart = timeHiddenKernel.QuadPart + (*cSPI).KernelTime.QuadPart;
				
				if(pSPI!=NULL) {
					//current element is not the first element in the array
					if((*cSPI).NextEntryOffset==0) {
						//current entry is the last in the array
						(*pSPI).NextEntryOffset = 0;
					}
					else {
						(*pSPI).NextEntryOffset = (*pSPI).NextEntryOffset + (*cSPI).NextEntryOffset;
					}
				}
				else {
					//current element is the first element in the array
					if((*cSPI).NextEntryOffset==0) {
						//the array consists of a single hidden entry 
						//set to NULL so invoker doesn't see it
						SystemInformation = NULL;
						
					}
					else {
						//hidden task is first array element
						//simply increment pointer to hide task
						(BYTE *)SystemInformation = ((BYTE*)SystemInformation) + (*cSPI).NextEntryOffset;
					}
				}
			}
		}
		pSPI = cSPI;
		if((*cSPI).NextEntryOffset != 0) {
			(BYTE*)cSPI = ((BYTE*)cSPI) + (*cSPI).NextEntryOffset;
		}
		else { cSPI = NULL;}
	}
	*/
	return ntStatus;
}


/*
 * DriverEntry: entry point for drivers.
 */
NTSTATUS DriverEntry(PDRIVER_OBJECT  pDriverObject, PUNICODE_STRING  pRegistryPath) {

    NTSTATUS NtStatus = STATUS_SUCCESS;
    unsigned int uiIndex = 0;
    PDEVICE_OBJECT pDeviceObject = NULL;
	PFILE_OBJECT fObject = NULL;
    UNICODE_STRING usDriverName, usDosDeviceName;
	UNICODE_STRING function;
	UNICODE_STRING buddyName;
	//log files
	UNICODE_STRING registryFile;
	UNICODE_STRING threadFile;
	UNICODE_STRING openProcessFile;
	UNICODE_STRING querySystemFile;
	UNICODE_STRING virtualMemoryFile;
	//UNICODE_STRING readVirtualMemoryFile;
	UNICODE_STRING debugActiveProcessFile;
	UNICODE_STRING createSectionFile;
	UNICODE_STRING createProcessFile;
	UNICODE_STRING createProcessExFile;
	UNICODE_STRING queueApcThreadFile;
	UNICODE_STRING createThreadFile;
	UNICODE_STRING createThreadExFile;
	UNICODE_STRING mapViewSectionFile;
	UNICODE_STRING ZwSetContextThreadFile;
	UNICODE_STRING ZwReadFileFile;
	UNICODE_STRING ZwDeviceIoControlFileFile;
	UNICODE_STRING ZwDelayExecutionFile;
	UNICODE_STRING ZwWaitForSingleObjectFile;
	UNICODE_STRING ZwReplyWaitReceivePortFile;
	UNICODE_STRING ZwRequestWaitReplyPortFile;
	UNICODE_STRING ZwCloseFile;
	UNICODE_STRING ZwSetEventFile;
	UNICODE_STRING ZwOpenThreadTokenFile;
	UNICODE_STRING ZwOpenThreadTokenExFile;
	UNICODE_STRING ZwOpenKeyFile;
	UNICODE_STRING ZwAllocateVirtualMemoryFile;
	UNICODE_STRING ZwProtectVirtualMemoryFile;
	UNICODE_STRING ZwQueryInformationTokenFile;
	UNICODE_STRING ZwEnumerateKeyFile;
	UNICODE_STRING ZwFlushInstructionCacheFile;
	UNICODE_STRING ZwQuerySecurityObjectFile;
	UNICODE_STRING ZwQueryDefaultLocaleFile;
	UNICODE_STRING ZwQuerySystemTimeFile;
	UNICODE_STRING ZwOpenSectionFile;
	UNICODE_STRING ZwSetInformationProcessFile;
	UNICODE_STRING ZwQueryInformationProcessFile;
	UNICODE_STRING ZwGetContextThreadFile;
	UNICODE_STRING ZwCreateProfileFile;
	UNICODE_STRING ZwStartProfileFile;
	UNICODE_STRING ZwAccessCheckFile;
	UNICODE_STRING ZwAccessCheckAndAuditAlarmFile;
	UNICODE_STRING ZwSetSystemInformationFile;
	UNICODE_STRING ZwGetPlugPlayEventFile;
	UNICODE_STRING ZwPlugPlayControlFile;
	UNICODE_STRING ZwLockVirtualMemoryFile;
	UNICODE_STRING ZwUnlockVirtualMemoryFile;
	UNICODE_STRING ZwFlushVirtualMemoryFile;
	UNICODE_STRING ZwAllocateUserPhysicalPagesFile;
	UNICODE_STRING ZwFreeUserPhysicalPagesFile;
	UNICODE_STRING ZwMapUserPhysicalPagesFile;
	UNICODE_STRING ZwMapUserPhysicalPagesScatterFile;
	UNICODE_STRING ZwGetWriteWatchFile;
	UNICODE_STRING ZwResetWriteWatchFile;
	UNICODE_STRING ZwFreeVirtualMemoryFile;
	UNICODE_STRING ZwQueryVirtualMemoryFile;
	UNICODE_STRING ZwReadVirtualMemoryFile;
	UNICODE_STRING ZwWriteVirtualMemoryFile;
	UNICODE_STRING ZwCreateFileFile;
	UNICODE_STRING ZwOpenFileFile;
	UNICODE_STRING ZwDeleteFileFile;
	UNICODE_STRING ZwFlushBuffersFileFile;
	UNICODE_STRING ZwCancelIoFileFile;
	UNICODE_STRING ZwWriteFileFile;
	UNICODE_STRING ZwReadFileScatterFile;
	UNICODE_STRING ZwWriteFileGatherFile;
	UNICODE_STRING ZwLockFileFile;
	UNICODE_STRING ZwUnlockFileFile;
	UNICODE_STRING ZwFsControlFileFile;
	UNICODE_STRING ZwNotifyChangeDirectoryFileFile;
	UNICODE_STRING ZwQueryEaFileFile;
	UNICODE_STRING ZwSetEaFileFile;
	UNICODE_STRING ZwCreateNamedPipeFileFile;
	UNICODE_STRING ZwCreateMailslotFileFile;
	UNICODE_STRING ZwQueryVolumeInformationFileFile;
	UNICODE_STRING ZwSetVolumeInformationFileFile;
	UNICODE_STRING ZwQueryQuotaInformationFileFile;
	UNICODE_STRING ZwSetQuotaInformationFileFile;
	UNICODE_STRING ZwQueryAttributesFileFile;
	UNICODE_STRING ZwQueryFullAttributesFileFile;
	UNICODE_STRING ZwQueryInformationFileFile;
	UNICODE_STRING ZwSetInformationFileFile;
	UNICODE_STRING ZwQueryDirectoryFileFile;
	UNICODE_STRING ZwCreateKeyFile;
	UNICODE_STRING ZwDeleteKeyFile;
	UNICODE_STRING ZwFlushKeyFile;
	UNICODE_STRING ZwSaveKeyFile;
	UNICODE_STRING ZwSaveKeyExFile;
	UNICODE_STRING ZwSaveMergedKeysFile;
	UNICODE_STRING ZwRestoreKeyFile;
	UNICODE_STRING ZwLoadKeyFile;
	UNICODE_STRING ZwLoadKey2File;
	UNICODE_STRING ZwUnloadKeyFile;
	UNICODE_STRING ZwUnloadKeyExFile;
	UNICODE_STRING ZwQueryOpenSubKeysFile;
	UNICODE_STRING ZwReplaceKeyFile;
	UNICODE_STRING ZwSetInformationKeyFile;
	UNICODE_STRING ZwQueryKeyFile;
	UNICODE_STRING ZwNotifyChangeKeyFile;
	UNICODE_STRING ZwNotifyChangeMultipleKeysFile;
	UNICODE_STRING ZwDeleteValueKeyFile;
	UNICODE_STRING ZwSetValueKeyFile;
	UNICODE_STRING ZwQueryValueKeyFile;
	UNICODE_STRING ZwEnumerateValueKeyFile;
	UNICODE_STRING ZwQueryMultipleValueKeyFile;
	UNICODE_STRING ZwInitializeRegistryFile;
	UNICODE_STRING ZwCreatePortFile;
	UNICODE_STRING ZwCreateWaitablePortFile;
	UNICODE_STRING ZwConnectPortFile;
	UNICODE_STRING ZwSecureConnectPortFile;
	UNICODE_STRING ZwListenPortFile;
	UNICODE_STRING ZwAcceptConnectPortFile;
	UNICODE_STRING ZwCompleteConnectPortFile;
	UNICODE_STRING ZwRequestPortFile;
	UNICODE_STRING ZwReplyPortFile;
	UNICODE_STRING ZwReplyWaitReplyPortFile;
	UNICODE_STRING ZwReplyWaitReceivePortExFile;
	UNICODE_STRING ZwReadRequestDataFile;
	UNICODE_STRING ZwWriteRequestDataFile;
	UNICODE_STRING ZwQueryInformationPortFile;
	UNICODE_STRING ZwImpersonateClientOfPortFile;
	UNICODE_STRING ZwCreateProcessFile;
	UNICODE_STRING ZwCreateProcessExFile;
	UNICODE_STRING ZwOpenProcessFile;
	UNICODE_STRING ZwTerminateProcessFile;
	UNICODE_STRING ZwCreateThreadFile;
	UNICODE_STRING ZwOpenThreadFile;
	UNICODE_STRING ZwTerminateThreadFile;
	UNICODE_STRING ZwQueryInformationThreadFile;
	UNICODE_STRING ZwSetInformationThreadFile;
	UNICODE_STRING ZwSuspendThreadFile;
	UNICODE_STRING ZwResumeThreadFile;
	UNICODE_STRING ZwQueueApcThreadFile;
	UNICODE_STRING ZwTestAlertFile;
	UNICODE_STRING ZwAlertThreadFile;
	UNICODE_STRING ZwAlertResumeThreadFile;
	UNICODE_STRING ZwRegisterThreadTerminatePortFile;
	UNICODE_STRING ZwImpersonateThreadFile;
	UNICODE_STRING ZwImpersonateAnonymousTokenFile;
	UNICODE_STRING ZwQuerySystemEnvironmentValueFile;
	UNICODE_STRING ZwQuerySystemEnvironmentValueExFile;
	UNICODE_STRING ZwSetSystemEnvironmentValueFile;
	UNICODE_STRING ZwSetSystemEnvironmentValueExFile;
	UNICODE_STRING ZwShutdownSystemFile;
	UNICODE_STRING ZwSystemDebugControlFile;
	UNICODE_STRING ZwQueryObjectFile;
	UNICODE_STRING ZwSetInformationObjectFile;
	UNICODE_STRING ZwDuplicateObjectFile;
	UNICODE_STRING ZwMakeTemporaryObjectFile;
	UNICODE_STRING ZwSetSecurityObjectFile;
	UNICODE_STRING ZwCreateDirectoryObjectFile;
	UNICODE_STRING ZwOpenDirectoryObjectFile;
	UNICODE_STRING ZwQueryDirectoryObjectFile;
	UNICODE_STRING ZwCreateSymbolicLinkObjectFile;
	UNICODE_STRING ZwOpenSymbolicLinkObjectFile;
	UNICODE_STRING ZwQuerySymbolicLinkObjectFile;
	UNICODE_STRING ZwCreateSectionFile;
	UNICODE_STRING ZwQuerySectionFile;
	UNICODE_STRING ZwExtendSectionFile;
	UNICODE_STRING ZwUnmapViewOfSectionFile;
	UNICODE_STRING ZwAreMappedFilesTheSameFile;
	UNICODE_STRING ZwCreateJobObjectFile;
	UNICODE_STRING ZwOpenJobObjectFile;
	UNICODE_STRING ZwTerminateJobObjectFile;
	UNICODE_STRING ZwAssignProcessToJobObjectFile;
	UNICODE_STRING ZwQueryInformationJobObjectFile;
	UNICODE_STRING ZwSetInformationJobObjectFile;
	UNICODE_STRING ZwCreateTokenFile;
	UNICODE_STRING ZwOpenProcessTokenFile;
	UNICODE_STRING ZwOpenProcessTokenExFile;
	UNICODE_STRING ZwDuplicateTokenFile;
	UNICODE_STRING ZwFilterTokenFile;
	UNICODE_STRING ZwAdjustPrivilegesTokenFile;
	UNICODE_STRING ZwAdjustGroupsTokenFile;
	UNICODE_STRING ZwSetInformationTokenFile;
	UNICODE_STRING ZwSignalAndWaitForSingleObjectFile;
	UNICODE_STRING ZwWaitForMultipleObjectsFile;
	UNICODE_STRING ZwCreateTimerFile;
	UNICODE_STRING ZwOpenTimerFile;
	UNICODE_STRING ZwCancelTimerFile;
	UNICODE_STRING ZwSetTimerFile;
	UNICODE_STRING ZwQueryTimerFile;
	UNICODE_STRING ZwCreateEventFile;
	UNICODE_STRING ZwOpenEventFile;
	UNICODE_STRING ZwPulseEventFile;
	UNICODE_STRING ZwResetEventFile;
	UNICODE_STRING ZwClearEventFile;
	UNICODE_STRING ZwQueryEventFile;
	UNICODE_STRING ZwCreateSemaphoreFile;
	UNICODE_STRING ZwOpenSemaphoreFile;
	UNICODE_STRING ZwReleaseSemaphoreFile;
	UNICODE_STRING ZwQuerySemaphoreFile;
	UNICODE_STRING ZwCreateMutantFile;
	UNICODE_STRING ZwOpenMutantFile;
	UNICODE_STRING ZwReleaseMutantFile;
	UNICODE_STRING ZwQueryMutantFile;
	UNICODE_STRING ZwCreateIoCompletionFile;
	UNICODE_STRING ZwOpenIoCompletionFile;
	UNICODE_STRING ZwSetIoCompletionFile;
	UNICODE_STRING ZwRemoveIoCompletionFile;
	UNICODE_STRING ZwQueryIoCompletionFile;
	UNICODE_STRING ZwCreateEventPairFile;
	UNICODE_STRING ZwOpenEventPairFile;
	UNICODE_STRING ZwWaitLowEventPairFile;
	UNICODE_STRING ZwWaitHighEventPairFile;
	UNICODE_STRING ZwSetLowWaitHighEventPairFile;
	UNICODE_STRING ZwSetHighWaitLowEventPairFile;
	UNICODE_STRING ZwSetLowEventPairFile;
	UNICODE_STRING ZwSetHighEventPairFile;
	UNICODE_STRING ZwSetSystemTimeFile;
	UNICODE_STRING ZwQueryPerformanceCounterFile;
	UNICODE_STRING ZwSetTimerResolutionFile;
	UNICODE_STRING ZwQueryTimerResolutionFile;
	UNICODE_STRING ZwYieldExecutionFile;
	UNICODE_STRING ZwSetIntervalProfileFile;
	UNICODE_STRING ZwQueryIntervalProfileFile;
	UNICODE_STRING ZwStopProfileFile;
	UNICODE_STRING ZwPrivilegeCheckFile;
	UNICODE_STRING ZwPrivilegeObjectAuditAlarmFile;
	UNICODE_STRING ZwPrivilegedServiceAuditAlarmFile;
	UNICODE_STRING ZwAccessCheckByTypeFile;
	UNICODE_STRING ZwAccessCheckByTypeAndAuditAlarmFile;
	UNICODE_STRING ZwAccessCheckByTypeResultListFile;
	UNICODE_STRING ZwAccessCheckByTypeResultListAndAuditAlarmFile;
	UNICODE_STRING ZwAccessCheckByTypeResultListAndAuditAlarmByHandleFile;
	UNICODE_STRING ZwOpenObjectAuditAlarmFile;
	UNICODE_STRING ZwCloseObjectAuditAlarmFile;
	UNICODE_STRING ZwDeleteObjectAuditAlarmFile;
	UNICODE_STRING ZwRequestWakeupLatencyFile;
	UNICODE_STRING ZwRequestDeviceWakeupFile;
	UNICODE_STRING ZwCancelDeviceWakeupRequestFile;
	UNICODE_STRING ZwIsSystemResumeAutomaticFile;
	UNICODE_STRING ZwSetThreadExecutionStateFile;
	UNICODE_STRING ZwGetDevicePowerStateFile;
	UNICODE_STRING ZwSetSystemPowerStateFile;
	UNICODE_STRING ZwInitiatePowerActionFile;
	UNICODE_STRING ZwPowerInformationFile;
	UNICODE_STRING ZwRaiseExceptionFile;
	//UNICODE_STRING ZwContinueFile;
	UNICODE_STRING ZwCallbackReturnFile;
	UNICODE_STRING ZwLoadDriverFile;
	UNICODE_STRING ZwUnloadDriverFile;
	UNICODE_STRING ZwFlushWriteBufferFile;
	UNICODE_STRING ZwSetDefaultLocaleFile;
	UNICODE_STRING ZwQueryDefaultUILanguageFile;
	UNICODE_STRING ZwSetDefaultUILanguageFile;
	UNICODE_STRING ZwQueryInstallUILanguageFile;
	UNICODE_STRING ZwAllocateLocallyUniqueIdFile;
	UNICODE_STRING ZwAllocateUuidsFile;
	UNICODE_STRING ZwSetUuidSeedFile;
	UNICODE_STRING ZwRaiseHardErrorFile;
	UNICODE_STRING ZwSetDefaultHardErrorPortFile;
	UNICODE_STRING ZwDisplayStringFile;
	UNICODE_STRING ZwCreatePagingFileFile;
	UNICODE_STRING ZwAddAtomFile;
	UNICODE_STRING ZwFindAtomFile;
	UNICODE_STRING ZwDeleteAtomFile;
	UNICODE_STRING ZwQueryInformationAtomFile;
	UNICODE_STRING ZwSetLdtEntriesFile;
	UNICODE_STRING ZwVdmControlFile;
	UNICODE_STRING NtSetBootEntryOrderFile;
	UNICODE_STRING NtCompactKeysFile;
	UNICODE_STRING NtCompareTokensFile;
	UNICODE_STRING NtCompressKeyFile;
	UNICODE_STRING NtCreateDebugObjectFile;
	UNICODE_STRING NtCreateJobSetFile;
	UNICODE_STRING NtDebugActiveProcessFile;
	UNICODE_STRING NtDebugContinueFile;
	UNICODE_STRING NtEnumerateSystemEnvironmentValuesExFile;
	UNICODE_STRING NtIsProcessInJobFile;
	UNICODE_STRING NtLockProductActivationKeysFile;
	UNICODE_STRING NtLockRegistryKeyFile;
	UNICODE_STRING NtMakePermanentObjectFile;
	UNICODE_STRING NtDeleteBootEntryFile;
	UNICODE_STRING NtQueryDebugFilterStateFile;
	UNICODE_STRING NtRemoveProcessDebugFile;
	UNICODE_STRING NtRenameKeyFile;
	UNICODE_STRING NtResumeProcessFile;
	UNICODE_STRING NtSetDebugFilterStateFile;
	UNICODE_STRING NtSetEventBoostPriorityFile;
	UNICODE_STRING NtSetInformationDebugObjectFile;
	UNICODE_STRING NtSuspendProcessFile;
	UNICODE_STRING NtTraceEventFile;
	UNICODE_STRING NtTranslateFilePathFile;
	UNICODE_STRING NtWaitForDebugEventFile;
	UNICODE_STRING NtCreateKeyedEventFile;
	UNICODE_STRING NtOpenKeyedEventFile;
	UNICODE_STRING NtReleaseKeyedEventFile;
	UNICODE_STRING NtWaitForKeyedEventFile;
	UNICODE_STRING NtQueryPortInformationProcessFile;
	//FILE_STRINGS_HERE
	
	RtlInitUnicodeString(&registryFile, L"\\SystemRoot\\d\\example.txt");
	RtlInitUnicodeString(&threadFile, L"\\SystemRoot\\d\\thread.txt");
	RtlInitUnicodeString(&openProcessFile, L"\\SystemRoot\\d\\ZwOpenProcess.txt");
	RtlInitUnicodeString(&querySystemFile, L"\\SystemRoot\\d\\ZwQuerySystemInformation.txt");
	RtlInitUnicodeString(&virtualMemoryFile, L"\\SystemRoot\\d\\ZwWriteVirtualMemory.txt");
	RtlInitUnicodeString(&debugActiveProcessFile, L"\\SystemRoot\\d\\ZwDebugActiveProcess.txt");
	RtlInitUnicodeString(&createSectionFile, L"\\SystemRoot\\d\\ZwCreateSection.txt");
	RtlInitUnicodeString(&createProcessFile, L"\\SystemRoot\\d\\ZwCreateProcess.txt");
	RtlInitUnicodeString(&createProcessExFile, L"\\SystemRoot\\d\\ZwCreateProcessEx.txt");
	RtlInitUnicodeString(&createThreadExFile, L"\\SystemRoot\\d\\ZwCreateThreadEx.txt");
	RtlInitUnicodeString(&mapViewSectionFile, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlInitUnicodeString(&ZwSetContextThreadFile, L"\\SystemRoot\\d\\ZwSetContextThread.txt");
	RtlInitUnicodeString(&ZwOpenFileFile, L"\\SystemRoot\\d\\ZwOpenFile.txt");
	RtlInitUnicodeString(&ZwCreateFileFile, L"\\SystemRoot\\d\\ZwCreateFile.txt");
	RtlInitUnicodeString(&ZwReadFileFile, L"\\SystemRoot\\d\\ZwReadFile.txt");
	RtlInitUnicodeString(&ZwDeleteFileFile, L"\\SystemRoot\\d\\ZwDeleteFile.txt");
	RtlInitUnicodeString(&ZwSetInformationFileFile, L"\\SystemRoot\\d\\ZwSetInformationFile.txt");
	RtlInitUnicodeString(&ZwDeviceIoControlFileFile, L"\\SystemRoot\\d\\ZwDeviceIoControlFile.txt");
	RtlInitUnicodeString(&ZwTerminateProcessFile, L"\\SystemRoot\\d\\ZwTerminateProcess.txt");
	RtlInitUnicodeString(&ZwLoadDriverFile, L"\\SystemRoot\\d\\ZwLoadDriver.txt");
	RtlInitUnicodeString(&ZwDelayExecutionFile, L"\\SystemRoot\\d\\ZwDelayExecution.txt");
	RtlInitUnicodeString(&ZwQueryValueKeyFile, L"\\SystemRoot\\d\\ZwQueryValueKey.txt");
	RtlInitUnicodeString(&ZwQueryAttributesFileFile, L"\\SystemRoot\\d\\ZwQueryAttributesFile.txt");
	RtlInitUnicodeString(&ZwAcceptConnectPortFile, L"\\SystemRoot\\d\\ZwAcceptConnectPort.txt");
	RtlInitUnicodeString(&ZwWaitForSingleObjectFile, L"\\SystemRoot\\d\\ZwWaitForSingleObject.txt");
	RtlInitUnicodeString(&ZwReplyWaitReceivePortFile, L"\\SystemRoot\\d\\ZwReplyWaitReceivePort.txt");
	RtlInitUnicodeString(&ZwRequestWaitReplyPortFile, L"\\SystemRoot\\d\\ZwRequestWaitReplyPort.txt");
	RtlInitUnicodeString(&ZwCloseFile, L"\\SystemRoot\\d\\ZwClose.txt");
	RtlInitUnicodeString(&ZwSetEventFile, L"\\SystemRoot\\d\\ZwSetEvent.txt");
	RtlInitUnicodeString(&ZwOpenThreadTokenFile, L"\\SystemRoot\\d\\ZwOpenThreadToken.txt");
	RtlInitUnicodeString(&ZwOpenThreadTokenExFile, L"\\SystemRoot\\d\\ZwOpenThreadTokenEx.txt");
	RtlInitUnicodeString(&ZwOpenKeyFile, L"\\SystemRoot\\d\\ZwOpenKey.txt");
	RtlInitUnicodeString(&ZwAllocateVirtualMemoryFile, L"\\SystemRoot\\d\\ZwAllocateVirtualMemory.txt");
	RtlInitUnicodeString(&ZwProtectVirtualMemoryFile, L"\\SystemRoot\\d\\ZwProtectVirtualMemory.txt");
	RtlInitUnicodeString(&ZwQueryInformationTokenFile, L"\\SystemRoot\\d\\ZwQueryInformationToken.txt");
	RtlInitUnicodeString(&ZwEnumerateKeyFile, L"\\SystemRoot\\d\\ZwEnumerateKey.txt");
	RtlInitUnicodeString(&ZwFlushInstructionCacheFile, L"\\SystemRoot\\d\\ZwFlushInstructionCache.txt");
	RtlInitUnicodeString(&ZwQuerySecurityObjectFile, L"\\SystemRoot\\d\\ZwQuerySecurityObject.txt");
	RtlInitUnicodeString(&ZwQueryDefaultLocaleFile, L"\\SystemRoot\\d\\ZwQueryDefaultLocale.txt");
	RtlInitUnicodeString(&ZwQuerySystemTimeFile, L"\\SystemRoot\\d\\ZwQuerySystemTime.txt");
	RtlInitUnicodeString(&ZwOpenSectionFile, L"\\SystemRoot\\d\\ZwOpenSection.txt");
	RtlInitUnicodeString(&ZwSetInformationProcessFile, L"\\SystemRoot\\d\\ZwSetInformationProcess.txt");
	RtlInitUnicodeString(&ZwQueryInformationProcessFile, L"\\SystemRoot\\d\\ZwQueryInformationProcess.txt");
	RtlInitUnicodeString(&ZwGetContextThreadFile, L"\\SystemRoot\\d\\ZwGetContextThread.txt");
	RtlInitUnicodeString(&ZwCreateProfileFile, L"\\SystemRoot\\d\\ZwCreateProfile.txt");
	RtlInitUnicodeString(&ZwStartProfileFile, L"\\SystemRoot\\d\\ZwStartProfile.txt");
	RtlInitUnicodeString(&ZwAccessCheckFile, L"\\SystemRoot\\d\\ZwAccessCheck.txt");
	RtlInitUnicodeString(&ZwAccessCheckAndAuditAlarmFile, L"\\SystemRoot\\d\\ZwAccessCheckAndAuditAlarm.txt");
	RtlInitUnicodeString(&ZwSetSystemInformationFile, L"\\SystemRoot\\d\\ZwSetSystemInformation.txt");
	RtlInitUnicodeString(&ZwGetPlugPlayEventFile, L"\\SystemRoot\\d\\ZwGetPlugPlayEvent.txt");
	RtlInitUnicodeString(&ZwPlugPlayControlFile, L"\\SystemRoot\\d\\ZwPlugPlayControl.txt");
	RtlInitUnicodeString(&ZwLockVirtualMemoryFile, L"\\SystemRoot\\d\\ZwLockVirtualMemory.txt");
	RtlInitUnicodeString(&ZwUnlockVirtualMemoryFile, L"\\SystemRoot\\d\\ZwUnlockVirtualMemory.txt");
	RtlInitUnicodeString(&ZwFlushVirtualMemoryFile, L"\\SystemRoot\\d\\ZwFlushVirtualMemory.txt");
	RtlInitUnicodeString(&ZwAllocateUserPhysicalPagesFile, L"\\SystemRoot\\d\\ZwAllocateUserPhysicalPages.txt");
	RtlInitUnicodeString(&ZwFreeUserPhysicalPagesFile, L"\\SystemRoot\\d\\ZwFreeUserPhysicalPages.txt");
	RtlInitUnicodeString(&ZwMapUserPhysicalPagesFile, L"\\SystemRoot\\d\\ZwMapUserPhysicalPages.txt");
	RtlInitUnicodeString(&ZwMapUserPhysicalPagesScatterFile, L"\\SystemRoot\\d\\ZwMapUserPhysicalPagesScatter.txt");
	RtlInitUnicodeString(&ZwGetWriteWatchFile, L"\\SystemRoot\\d\\ZwGetWriteWatch.txt");
	RtlInitUnicodeString(&ZwResetWriteWatchFile, L"\\SystemRoot\\d\\ZwResetWriteWatch.txt");
	RtlInitUnicodeString(&ZwFreeVirtualMemoryFile, L"\\SystemRoot\\d\\ZwFreeVirtualMemory.txt");
	RtlInitUnicodeString(&ZwQueryVirtualMemoryFile, L"\\SystemRoot\\d\\ZwQueryVirtualMemory.txt");
	RtlInitUnicodeString(&ZwReadVirtualMemoryFile, L"\\SystemRoot\\d\\ZwReadVirtualMemory.txt");
	RtlInitUnicodeString(&ZwWriteVirtualMemoryFile, L"\\SystemRoot\\d\\ZwWriteVirtualMemory.txt");
	RtlInitUnicodeString(&ZwCreateFileFile, L"\\SystemRoot\\d\\ZwCreateFile.txt");
	RtlInitUnicodeString(&ZwOpenFileFile, L"\\SystemRoot\\d\\ZwOpenFile.txt");
	RtlInitUnicodeString(&ZwDeleteFileFile, L"\\SystemRoot\\d\\ZwDeleteFile.txt");
	RtlInitUnicodeString(&ZwFlushBuffersFileFile, L"\\SystemRoot\\d\\ZwFlushBuffersFile.txt");
	RtlInitUnicodeString(&ZwCancelIoFileFile, L"\\SystemRoot\\d\\ZwCancelIoFile.txt");
	RtlInitUnicodeString(&ZwWriteFileFile, L"\\SystemRoot\\d\\ZwWriteFile.txt");
	RtlInitUnicodeString(&ZwReadFileScatterFile, L"\\SystemRoot\\d\\ZwReadFileScatter.txt");
	RtlInitUnicodeString(&ZwWriteFileGatherFile, L"\\SystemRoot\\d\\ZwWriteFileGather.txt");
	RtlInitUnicodeString(&ZwLockFileFile, L"\\SystemRoot\\d\\ZwLockFile.txt");
	RtlInitUnicodeString(&ZwUnlockFileFile, L"\\SystemRoot\\d\\ZwUnlockFile.txt");
	RtlInitUnicodeString(&ZwFsControlFileFile, L"\\SystemRoot\\d\\ZwFsControlFile.txt");
	RtlInitUnicodeString(&ZwNotifyChangeDirectoryFileFile, L"\\SystemRoot\\d\\ZwNotifyChangeDirectoryFile.txt");
	RtlInitUnicodeString(&ZwQueryEaFileFile, L"\\SystemRoot\\d\\ZwQueryEaFile.txt");
	RtlInitUnicodeString(&ZwSetEaFileFile, L"\\SystemRoot\\d\\ZwSetEaFile.txt");
	RtlInitUnicodeString(&ZwCreateNamedPipeFileFile, L"\\SystemRoot\\d\\ZwCreateNamedPipeFile.txt");
	RtlInitUnicodeString(&ZwCreateMailslotFileFile, L"\\SystemRoot\\d\\ZwCreateMailslotFile.txt");
	RtlInitUnicodeString(&ZwQueryVolumeInformationFileFile, L"\\SystemRoot\\d\\ZwQueryVolumeInformationFile.txt");
	RtlInitUnicodeString(&ZwSetVolumeInformationFileFile, L"\\SystemRoot\\d\\ZwSetVolumeInformationFile.txt");
	RtlInitUnicodeString(&ZwQueryQuotaInformationFileFile, L"\\SystemRoot\\d\\ZwQueryQuotaInformationFile.txt");
	RtlInitUnicodeString(&ZwSetQuotaInformationFileFile, L"\\SystemRoot\\d\\ZwSetQuotaInformationFile.txt");
	RtlInitUnicodeString(&ZwQueryAttributesFileFile, L"\\SystemRoot\\d\\ZwQueryAttributesFile.txt");
	RtlInitUnicodeString(&ZwQueryFullAttributesFileFile, L"\\SystemRoot\\d\\ZwQueryFullAttributesFile.txt");
	RtlInitUnicodeString(&ZwQueryInformationFileFile, L"\\SystemRoot\\d\\ZwQueryInformationFile.txt");
	RtlInitUnicodeString(&ZwSetInformationFileFile, L"\\SystemRoot\\d\\ZwSetInformationFile.txt");
	RtlInitUnicodeString(&ZwQueryDirectoryFileFile, L"\\SystemRoot\\d\\ZwQueryDirectoryFile.txt");
	RtlInitUnicodeString(&ZwCreateKeyFile, L"\\SystemRoot\\d\\ZwCreateKey.txt");
	RtlInitUnicodeString(&ZwDeleteKeyFile, L"\\SystemRoot\\d\\ZwDeleteKey.txt");
	RtlInitUnicodeString(&ZwFlushKeyFile, L"\\SystemRoot\\d\\ZwFlushKey.txt");
	RtlInitUnicodeString(&ZwSaveKeyFile, L"\\SystemRoot\\d\\ZwSaveKey.txt");
	RtlInitUnicodeString(&ZwSaveKeyExFile, L"\\SystemRoot\\d\\ZwSaveKeyEx.txt");
	RtlInitUnicodeString(&ZwSaveMergedKeysFile, L"\\SystemRoot\\d\\ZwSaveMergedKeys.txt");
	RtlInitUnicodeString(&ZwRestoreKeyFile, L"\\SystemRoot\\d\\ZwRestoreKey.txt");
	RtlInitUnicodeString(&ZwLoadKeyFile, L"\\SystemRoot\\d\\ZwLoadKey.txt");
	RtlInitUnicodeString(&ZwLoadKey2File, L"\\SystemRoot\\d\\ZwLoadKey2.txt");
	RtlInitUnicodeString(&ZwUnloadKeyFile, L"\\SystemRoot\\d\\ZwUnloadKey.txt");
	RtlInitUnicodeString(&ZwUnloadKeyExFile, L"\\SystemRoot\\d\\ZwUnloadKeyEx.txt");
	RtlInitUnicodeString(&ZwQueryOpenSubKeysFile, L"\\SystemRoot\\d\\ZwQueryOpenSubKeys.txt");
	RtlInitUnicodeString(&ZwReplaceKeyFile, L"\\SystemRoot\\d\\ZwReplaceKey.txt");
	RtlInitUnicodeString(&ZwSetInformationKeyFile, L"\\SystemRoot\\d\\ZwSetInformationKey.txt");
	RtlInitUnicodeString(&ZwQueryKeyFile, L"\\SystemRoot\\d\\ZwQueryKey.txt");
	RtlInitUnicodeString(&ZwNotifyChangeKeyFile, L"\\SystemRoot\\d\\ZwNotifyChangeKey.txt");
	RtlInitUnicodeString(&ZwNotifyChangeMultipleKeysFile, L"\\SystemRoot\\d\\ZwNotifyChangeMultipleKeys.txt");
	RtlInitUnicodeString(&ZwDeleteValueKeyFile, L"\\SystemRoot\\d\\ZwDeleteValueKey.txt");
	RtlInitUnicodeString(&ZwSetValueKeyFile, L"\\SystemRoot\\d\\ZwSetValueKey.txt");
	RtlInitUnicodeString(&ZwQueryValueKeyFile, L"\\SystemRoot\\d\\ZwQueryValueKey.txt");
	RtlInitUnicodeString(&ZwEnumerateValueKeyFile, L"\\SystemRoot\\d\\ZwEnumerateValueKey.txt");
	RtlInitUnicodeString(&ZwQueryMultipleValueKeyFile, L"\\SystemRoot\\d\\ZwQueryMultipleValueKey.txt");
	RtlInitUnicodeString(&ZwInitializeRegistryFile, L"\\SystemRoot\\d\\ZwInitializeRegistry.txt");
	RtlInitUnicodeString(&ZwCreatePortFile, L"\\SystemRoot\\d\\ZwCreatePort.txt");
	RtlInitUnicodeString(&ZwCreateWaitablePortFile, L"\\SystemRoot\\d\\ZwCreateWaitablePort.txt");
	RtlInitUnicodeString(&ZwConnectPortFile, L"\\SystemRoot\\d\\ZwConnectPort.txt");
	RtlInitUnicodeString(&ZwSecureConnectPortFile, L"\\SystemRoot\\d\\ZwSecureConnectPort.txt");
	RtlInitUnicodeString(&ZwListenPortFile, L"\\SystemRoot\\d\\ZwListenPort.txt");
	RtlInitUnicodeString(&ZwAcceptConnectPortFile, L"\\SystemRoot\\d\\ZwAcceptConnectPort.txt");
	RtlInitUnicodeString(&ZwCompleteConnectPortFile, L"\\SystemRoot\\d\\ZwCompleteConnectPort.txt");
	RtlInitUnicodeString(&ZwRequestPortFile, L"\\SystemRoot\\d\\ZwRequestPort.txt");
	RtlInitUnicodeString(&ZwReplyPortFile, L"\\SystemRoot\\d\\ZwReplyPort.txt");
	RtlInitUnicodeString(&ZwReplyWaitReplyPortFile, L"\\SystemRoot\\d\\ZwReplyWaitReplyPort.txt");
	RtlInitUnicodeString(&ZwReplyWaitReceivePortExFile, L"\\SystemRoot\\d\\ZwReplyWaitReceivePortEx.txt");
	RtlInitUnicodeString(&ZwReadRequestDataFile, L"\\SystemRoot\\d\\ZwReadRequestData.txt");
	RtlInitUnicodeString(&ZwWriteRequestDataFile, L"\\SystemRoot\\d\\ZwWriteRequestData.txt");
	RtlInitUnicodeString(&ZwQueryInformationPortFile, L"\\SystemRoot\\d\\ZwQueryInformationPort.txt");
	RtlInitUnicodeString(&ZwImpersonateClientOfPortFile, L"\\SystemRoot\\d\\ZwImpersonateClientOfPort.txt");
	RtlInitUnicodeString(&ZwCreateProcessFile, L"\\SystemRoot\\d\\ZwCreateProcess.txt");
	RtlInitUnicodeString(&ZwCreateProcessExFile, L"\\SystemRoot\\d\\ZwCreateProcessEx.txt");
	RtlInitUnicodeString(&ZwOpenProcessFile, L"\\SystemRoot\\d\\ZwOpenProcess.txt");
	RtlInitUnicodeString(&ZwTerminateProcessFile, L"\\SystemRoot\\d\\ZwTerminateProcess.txt");
	RtlInitUnicodeString(&ZwCreateThreadFile, L"\\SystemRoot\\d\\ZwCreateThread.txt");
	RtlInitUnicodeString(&ZwOpenThreadFile, L"\\SystemRoot\\d\\ZwOpenThread.txt");
	RtlInitUnicodeString(&ZwTerminateThreadFile, L"\\SystemRoot\\d\\ZwTerminateThread.txt");
	RtlInitUnicodeString(&ZwQueryInformationThreadFile, L"\\SystemRoot\\d\\ZwQueryInformationThread.txt");
	RtlInitUnicodeString(&ZwSetInformationThreadFile, L"\\SystemRoot\\d\\ZwSetInformationThread.txt");
	RtlInitUnicodeString(&ZwSuspendThreadFile, L"\\SystemRoot\\d\\ZwSuspendThread.txt");
	RtlInitUnicodeString(&ZwResumeThreadFile, L"\\SystemRoot\\d\\ZwResumeThread.txt");
	RtlInitUnicodeString(&ZwQueueApcThreadFile, L"\\SystemRoot\\d\\ZwQueueApcThread.txt");
	RtlInitUnicodeString(&ZwTestAlertFile, L"\\SystemRoot\\d\\ZwTestAlert.txt");
	RtlInitUnicodeString(&ZwAlertThreadFile, L"\\SystemRoot\\d\\ZwAlertThread.txt");
	RtlInitUnicodeString(&ZwAlertResumeThreadFile, L"\\SystemRoot\\d\\ZwAlertResumeThread.txt");
	RtlInitUnicodeString(&ZwRegisterThreadTerminatePortFile, L"\\SystemRoot\\d\\ZwRegisterThreadTerminatePort.txt");
	RtlInitUnicodeString(&ZwImpersonateThreadFile, L"\\SystemRoot\\d\\ZwImpersonateThread.txt");
	RtlInitUnicodeString(&ZwImpersonateAnonymousTokenFile, L"\\SystemRoot\\d\\ZwImpersonateAnonymousToken.txt");
	RtlInitUnicodeString(&ZwQuerySystemEnvironmentValueFile, L"\\SystemRoot\\d\\ZwQuerySystemEnvironmentValue.txt");
	RtlInitUnicodeString(&ZwQuerySystemEnvironmentValueExFile, L"\\SystemRoot\\d\\ZwQuerySystemEnvironmentValueEx.txt");
	RtlInitUnicodeString(&ZwSetSystemEnvironmentValueFile, L"\\SystemRoot\\d\\ZwSetSystemEnvironmentValue.txt");
	RtlInitUnicodeString(&ZwSetSystemEnvironmentValueExFile, L"\\SystemRoot\\d\\ZwSetSystemEnvironmentValueEx.txt");
	RtlInitUnicodeString(&ZwShutdownSystemFile, L"\\SystemRoot\\d\\ZwShutdownSystem.txt");
	RtlInitUnicodeString(&ZwSystemDebugControlFile, L"\\SystemRoot\\d\\ZwSystemDebugControl.txt");
	RtlInitUnicodeString(&ZwQueryObjectFile, L"\\SystemRoot\\d\\ZwQueryObject.txt");
	RtlInitUnicodeString(&ZwSetInformationObjectFile, L"\\SystemRoot\\d\\ZwSetInformationObject.txt");
	RtlInitUnicodeString(&ZwDuplicateObjectFile, L"\\SystemRoot\\d\\ZwDuplicateObject.txt");
	RtlInitUnicodeString(&ZwMakeTemporaryObjectFile, L"\\SystemRoot\\d\\ZwMakeTemporaryObject.txt");
	RtlInitUnicodeString(&ZwSetSecurityObjectFile, L"\\SystemRoot\\d\\ZwSetSecurityObject.txt");
	RtlInitUnicodeString(&ZwCreateDirectoryObjectFile, L"\\SystemRoot\\d\\ZwCreateDirectoryObject.txt");
	RtlInitUnicodeString(&ZwOpenDirectoryObjectFile, L"\\SystemRoot\\d\\ZwOpenDirectoryObject.txt");
	RtlInitUnicodeString(&ZwQueryDirectoryObjectFile, L"\\SystemRoot\\d\\ZwQueryDirectoryObject.txt");
	RtlInitUnicodeString(&ZwCreateSymbolicLinkObjectFile, L"\\SystemRoot\\d\\ZwCreateSymbolicLinkObject.txt");
	RtlInitUnicodeString(&ZwOpenSymbolicLinkObjectFile, L"\\SystemRoot\\d\\ZwOpenSymbolicLinkObject.txt");
	RtlInitUnicodeString(&ZwQuerySymbolicLinkObjectFile, L"\\SystemRoot\\d\\ZwQuerySymbolicLinkObject.txt");
	RtlInitUnicodeString(&ZwCreateSectionFile, L"\\SystemRoot\\d\\ZwCreateSection.txt");
	RtlInitUnicodeString(&ZwQuerySectionFile, L"\\SystemRoot\\d\\ZwQuerySection.txt");
	RtlInitUnicodeString(&ZwExtendSectionFile, L"\\SystemRoot\\d\\ZwExtendSection.txt");
	RtlInitUnicodeString(&ZwUnmapViewOfSectionFile, L"\\SystemRoot\\d\\ZwUnmapViewOfSection.txt");
	RtlInitUnicodeString(&ZwAreMappedFilesTheSameFile, L"\\SystemRoot\\d\\ZwAreMappedFilesTheSame.txt");
	RtlInitUnicodeString(&ZwCreateJobObjectFile, L"\\SystemRoot\\d\\ZwCreateJobObject.txt");
	RtlInitUnicodeString(&ZwOpenJobObjectFile, L"\\SystemRoot\\d\\ZwOpenJobObject.txt");
	RtlInitUnicodeString(&ZwTerminateJobObjectFile, L"\\SystemRoot\\d\\ZwTerminateJobObject.txt");
	RtlInitUnicodeString(&ZwAssignProcessToJobObjectFile, L"\\SystemRoot\\d\\ZwAssignProcessToJobObject.txt");
	RtlInitUnicodeString(&ZwQueryInformationJobObjectFile, L"\\SystemRoot\\d\\ZwQueryInformationJobObject.txt");
	RtlInitUnicodeString(&ZwSetInformationJobObjectFile, L"\\SystemRoot\\d\\ZwSetInformationJobObject.txt");
	RtlInitUnicodeString(&ZwCreateTokenFile, L"\\SystemRoot\\d\\ZwCreateToken.txt");
	RtlInitUnicodeString(&ZwOpenProcessTokenFile, L"\\SystemRoot\\d\\ZwOpenProcessToken.txt");
	RtlInitUnicodeString(&ZwOpenProcessTokenExFile, L"\\SystemRoot\\d\\ZwOpenProcessTokenEx.txt");
	RtlInitUnicodeString(&ZwDuplicateTokenFile, L"\\SystemRoot\\d\\ZwDuplicateToken.txt");
	RtlInitUnicodeString(&ZwFilterTokenFile, L"\\SystemRoot\\d\\ZwFilterToken.txt");
	RtlInitUnicodeString(&ZwAdjustPrivilegesTokenFile, L"\\SystemRoot\\d\\ZwAdjustPrivilegesToken.txt");
	RtlInitUnicodeString(&ZwAdjustGroupsTokenFile, L"\\SystemRoot\\d\\ZwAdjustGroupsToken.txt");
	RtlInitUnicodeString(&ZwSetInformationTokenFile, L"\\SystemRoot\\d\\ZwSetInformationToken.txt");
	RtlInitUnicodeString(&ZwSignalAndWaitForSingleObjectFile, L"\\SystemRoot\\d\\ZwSignalAndWaitForSingleObject.txt");
	RtlInitUnicodeString(&ZwWaitForMultipleObjectsFile, L"\\SystemRoot\\d\\ZwWaitForMultipleObjects.txt");
	RtlInitUnicodeString(&ZwCreateTimerFile, L"\\SystemRoot\\d\\ZwCreateTimer.txt");
	RtlInitUnicodeString(&ZwOpenTimerFile, L"\\SystemRoot\\d\\ZwOpenTimer.txt");
	RtlInitUnicodeString(&ZwCancelTimerFile, L"\\SystemRoot\\d\\ZwCancelTimer.txt");
	RtlInitUnicodeString(&ZwSetTimerFile, L"\\SystemRoot\\d\\ZwSetTimer.txt");
	RtlInitUnicodeString(&ZwQueryTimerFile, L"\\SystemRoot\\d\\ZwQueryTimer.txt");
	RtlInitUnicodeString(&ZwCreateEventFile, L"\\SystemRoot\\d\\ZwCreateEvent.txt");
	RtlInitUnicodeString(&ZwOpenEventFile, L"\\SystemRoot\\d\\ZwOpenEvent.txt");
	RtlInitUnicodeString(&ZwPulseEventFile, L"\\SystemRoot\\d\\ZwPulseEvent.txt");
	RtlInitUnicodeString(&ZwResetEventFile, L"\\SystemRoot\\d\\ZwResetEvent.txt");
	RtlInitUnicodeString(&ZwClearEventFile, L"\\SystemRoot\\d\\ZwClearEvent.txt");
	RtlInitUnicodeString(&ZwQueryEventFile, L"\\SystemRoot\\d\\ZwQueryEvent.txt");
	RtlInitUnicodeString(&ZwCreateSemaphoreFile, L"\\SystemRoot\\d\\ZwCreateSemaphore.txt");
	RtlInitUnicodeString(&ZwOpenSemaphoreFile, L"\\SystemRoot\\d\\ZwOpenSemaphore.txt");
	RtlInitUnicodeString(&ZwReleaseSemaphoreFile, L"\\SystemRoot\\d\\ZwReleaseSemaphore.txt");
	RtlInitUnicodeString(&ZwQuerySemaphoreFile, L"\\SystemRoot\\d\\ZwQuerySemaphore.txt");
	RtlInitUnicodeString(&ZwCreateMutantFile, L"\\SystemRoot\\d\\ZwCreateMutant.txt");
	RtlInitUnicodeString(&ZwOpenMutantFile, L"\\SystemRoot\\d\\ZwOpenMutant.txt");
	RtlInitUnicodeString(&ZwReleaseMutantFile, L"\\SystemRoot\\d\\ZwReleaseMutant.txt");
	RtlInitUnicodeString(&ZwQueryMutantFile, L"\\SystemRoot\\d\\ZwQueryMutant.txt");
	RtlInitUnicodeString(&ZwCreateIoCompletionFile, L"\\SystemRoot\\d\\ZwCreateIoCompletion.txt");
	RtlInitUnicodeString(&ZwOpenIoCompletionFile, L"\\SystemRoot\\d\\ZwOpenIoCompletion.txt");
	RtlInitUnicodeString(&ZwSetIoCompletionFile, L"\\SystemRoot\\d\\ZwSetIoCompletion.txt");
	RtlInitUnicodeString(&ZwRemoveIoCompletionFile, L"\\SystemRoot\\d\\ZwRemoveIoCompletion.txt");
	RtlInitUnicodeString(&ZwQueryIoCompletionFile, L"\\SystemRoot\\d\\ZwQueryIoCompletion.txt");
	RtlInitUnicodeString(&ZwCreateEventPairFile, L"\\SystemRoot\\d\\ZwCreateEventPair.txt");
	RtlInitUnicodeString(&ZwOpenEventPairFile, L"\\SystemRoot\\d\\ZwOpenEventPair.txt");
	RtlInitUnicodeString(&ZwWaitLowEventPairFile, L"\\SystemRoot\\d\\ZwWaitLowEventPair.txt");
	RtlInitUnicodeString(&ZwWaitHighEventPairFile, L"\\SystemRoot\\d\\ZwWaitHighEventPair.txt");
	RtlInitUnicodeString(&ZwSetLowWaitHighEventPairFile, L"\\SystemRoot\\d\\ZwSetLowWaitHighEventPair.txt");
	RtlInitUnicodeString(&ZwSetHighWaitLowEventPairFile, L"\\SystemRoot\\d\\ZwSetHighWaitLowEventPair.txt");
	RtlInitUnicodeString(&ZwSetLowEventPairFile, L"\\SystemRoot\\d\\ZwSetLowEventPair.txt");
	RtlInitUnicodeString(&ZwSetHighEventPairFile, L"\\SystemRoot\\d\\ZwSetHighEventPair.txt");
	RtlInitUnicodeString(&ZwSetSystemTimeFile, L"\\SystemRoot\\d\\ZwSetSystemTime.txt");
	RtlInitUnicodeString(&ZwQueryPerformanceCounterFile, L"\\SystemRoot\\d\\ZwQueryPerformanceCounter.txt");
	RtlInitUnicodeString(&ZwSetTimerResolutionFile, L"\\SystemRoot\\d\\ZwSetTimerResolution.txt");
	RtlInitUnicodeString(&ZwQueryTimerResolutionFile, L"\\SystemRoot\\d\\ZwQueryTimerResolution.txt");
	RtlInitUnicodeString(&ZwYieldExecutionFile, L"\\SystemRoot\\d\\ZwYieldExecution.txt");
	RtlInitUnicodeString(&ZwSetIntervalProfileFile, L"\\SystemRoot\\d\\ZwSetIntervalProfile.txt");
	RtlInitUnicodeString(&ZwQueryIntervalProfileFile, L"\\SystemRoot\\d\\ZwQueryIntervalProfile.txt");
	RtlInitUnicodeString(&ZwStopProfileFile, L"\\SystemRoot\\d\\ZwStopProfile.txt");
	RtlInitUnicodeString(&ZwPrivilegeCheckFile, L"\\SystemRoot\\d\\ZwPrivilegeCheck.txt");
	RtlInitUnicodeString(&ZwPrivilegeObjectAuditAlarmFile, L"\\SystemRoot\\d\\ZwPrivilegeObjectAuditAlarm.txt");
	RtlInitUnicodeString(&ZwPrivilegedServiceAuditAlarmFile, L"\\SystemRoot\\d\\ZwPrivilegedServiceAuditAlarm.txt");
	RtlInitUnicodeString(&ZwAccessCheckByTypeFile, L"\\SystemRoot\\d\\ZwAccessCheckByType.txt");
	RtlInitUnicodeString(&ZwAccessCheckByTypeAndAuditAlarmFile, L"\\SystemRoot\\d\\ZwAccessCheckByTypeAndAuditAlarm.txt");
	RtlInitUnicodeString(&ZwAccessCheckByTypeResultListFile, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultList.txt");
	RtlInitUnicodeString(&ZwAccessCheckByTypeResultListAndAuditAlarmFile, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultListAndAuditAlarm.txt");
	RtlInitUnicodeString(&ZwAccessCheckByTypeResultListAndAuditAlarmByHandleFile, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultListAndAuditAlarmByHandle.txt");
	RtlInitUnicodeString(&ZwOpenObjectAuditAlarmFile, L"\\SystemRoot\\d\\ZwOpenObjectAuditAlarm.txt");
	RtlInitUnicodeString(&ZwCloseObjectAuditAlarmFile, L"\\SystemRoot\\d\\ZwCloseObjectAuditAlarm.txt");
	RtlInitUnicodeString(&ZwDeleteObjectAuditAlarmFile, L"\\SystemRoot\\d\\ZwDeleteObjectAuditAlarm.txt");
	RtlInitUnicodeString(&ZwRequestWakeupLatencyFile, L"\\SystemRoot\\d\\ZwRequestWakeupLatency.txt");
	RtlInitUnicodeString(&ZwRequestDeviceWakeupFile, L"\\SystemRoot\\d\\ZwRequestDeviceWakeup.txt");
	RtlInitUnicodeString(&ZwCancelDeviceWakeupRequestFile, L"\\SystemRoot\\d\\ZwCancelDeviceWakeupRequest.txt");
	RtlInitUnicodeString(&ZwIsSystemResumeAutomaticFile, L"\\SystemRoot\\d\\ZwIsSystemResumeAutomatic.txt");
	RtlInitUnicodeString(&ZwSetThreadExecutionStateFile, L"\\SystemRoot\\d\\ZwSetThreadExecutionState.txt");
	RtlInitUnicodeString(&ZwGetDevicePowerStateFile, L"\\SystemRoot\\d\\ZwGetDevicePowerState.txt");
	RtlInitUnicodeString(&ZwSetSystemPowerStateFile, L"\\SystemRoot\\d\\ZwSetSystemPowerState.txt");
	RtlInitUnicodeString(&ZwInitiatePowerActionFile, L"\\SystemRoot\\d\\ZwInitiatePowerAction.txt");
	RtlInitUnicodeString(&ZwPowerInformationFile, L"\\SystemRoot\\d\\ZwPowerInformation.txt");
	RtlInitUnicodeString(&ZwRaiseExceptionFile, L"\\SystemRoot\\d\\ZwRaiseException.txt");
	//RtlInitUnicodeString(&ZwContinueFile, L"\\SystemRoot\\d\\ZwContinue.txt");
	RtlInitUnicodeString(&ZwCallbackReturnFile, L"\\SystemRoot\\d\\ZwCallbackReturn.txt");
	RtlInitUnicodeString(&ZwLoadDriverFile, L"\\SystemRoot\\d\\ZwLoadDriver.txt");
	RtlInitUnicodeString(&ZwUnloadDriverFile, L"\\SystemRoot\\d\\ZwUnloadDriver.txt");
	RtlInitUnicodeString(&ZwFlushWriteBufferFile, L"\\SystemRoot\\d\\ZwFlushWriteBuffer.txt");
	RtlInitUnicodeString(&ZwSetDefaultLocaleFile, L"\\SystemRoot\\d\\ZwSetDefaultLocale.txt");
	RtlInitUnicodeString(&ZwQueryDefaultUILanguageFile, L"\\SystemRoot\\d\\ZwQueryDefaultUILanguage.txt");
	RtlInitUnicodeString(&ZwSetDefaultUILanguageFile, L"\\SystemRoot\\d\\ZwSetDefaultUILanguage.txt");
	RtlInitUnicodeString(&ZwQueryInstallUILanguageFile, L"\\SystemRoot\\d\\ZwQueryInstallUILanguage.txt");
	RtlInitUnicodeString(&ZwAllocateLocallyUniqueIdFile, L"\\SystemRoot\\d\\ZwAllocateLocallyUniqueId.txt");
	RtlInitUnicodeString(&ZwAllocateUuidsFile, L"\\SystemRoot\\d\\ZwAllocateUuids.txt");
	RtlInitUnicodeString(&ZwSetUuidSeedFile, L"\\SystemRoot\\d\\ZwSetUuidSeed.txt");
	RtlInitUnicodeString(&ZwRaiseHardErrorFile, L"\\SystemRoot\\d\\ZwRaiseHardError.txt");
	RtlInitUnicodeString(&ZwSetDefaultHardErrorPortFile, L"\\SystemRoot\\d\\ZwSetDefaultHardErrorPort.txt");
	RtlInitUnicodeString(&ZwDisplayStringFile, L"\\SystemRoot\\d\\ZwDisplayString.txt");
	RtlInitUnicodeString(&ZwCreatePagingFileFile, L"\\SystemRoot\\d\\ZwCreatePagingFile.txt");
	RtlInitUnicodeString(&ZwAddAtomFile, L"\\SystemRoot\\d\\ZwAddAtom.txt");
	RtlInitUnicodeString(&ZwFindAtomFile, L"\\SystemRoot\\d\\ZwFindAtom.txt");
	RtlInitUnicodeString(&ZwDeleteAtomFile, L"\\SystemRoot\\d\\ZwDeleteAtom.txt");
	RtlInitUnicodeString(&ZwQueryInformationAtomFile, L"\\SystemRoot\\d\\ZwQueryInformationAtom.txt");
	RtlInitUnicodeString(&ZwSetLdtEntriesFile, L"\\SystemRoot\\d\\ZwSetLdtEntries.txt");
	RtlInitUnicodeString(&ZwVdmControlFile, L"\\SystemRoot\\d\\ZwVdmControl.txt");
	RtlInitUnicodeString(&NtSetBootEntryOrderFile, L"\\SystemRoot\\d\\NtSetBootEntryOrder.txt");
	RtlInitUnicodeString(&NtCompactKeysFile, L"\\SystemRoot\\d\\NtCompactKeys.txt");
	RtlInitUnicodeString(&NtCompareTokensFile, L"\\SystemRoot\\d\\NtCompareTokens.txt");
	RtlInitUnicodeString(&NtCompressKeyFile, L"\\SystemRoot\\d\\NtCompressKey.txt");
	RtlInitUnicodeString(&NtCreateDebugObjectFile, L"\\SystemRoot\\d\\NtCreateDebugObject.txt");
	RtlInitUnicodeString(&NtCreateJobSetFile, L"\\SystemRoot\\d\\NtCreateJobSet.txt");
	RtlInitUnicodeString(&NtDebugActiveProcessFile, L"\\SystemRoot\\d\\NtDebugActiveProcess.txt");
	RtlInitUnicodeString(&NtDebugContinueFile, L"\\SystemRoot\\d\\NtDebugContinue.txt");
	RtlInitUnicodeString(&NtEnumerateSystemEnvironmentValuesExFile, L"\\SystemRoot\\d\\NtEnumerateSystemEnvironmentValuesEx.txt");
	RtlInitUnicodeString(&NtIsProcessInJobFile, L"\\SystemRoot\\d\\NtIsProcessInJob.txt");
	RtlInitUnicodeString(&NtLockProductActivationKeysFile, L"\\SystemRoot\\d\\NtLockProductActivationKeys.txt");
	RtlInitUnicodeString(&NtLockRegistryKeyFile, L"\\SystemRoot\\d\\NtLockRegistryKey.txt");
	RtlInitUnicodeString(&NtMakePermanentObjectFile, L"\\SystemRoot\\d\\NtMakePermanentObject.txt");
	RtlInitUnicodeString(&NtDeleteBootEntryFile, L"\\SystemRoot\\d\\NtDeleteBootEntry.txt");
	RtlInitUnicodeString(&NtQueryDebugFilterStateFile, L"\\SystemRoot\\d\\NtQueryDebugFilterState.txt");
	RtlInitUnicodeString(&NtRemoveProcessDebugFile, L"\\SystemRoot\\d\\NtRemoveProcessDebug.txt");
	RtlInitUnicodeString(&NtRenameKeyFile, L"\\SystemRoot\\d\\NtRenameKey.txt");
	RtlInitUnicodeString(&NtResumeProcessFile, L"\\SystemRoot\\d\\NtResumeProcess.txt");
	RtlInitUnicodeString(&NtSetDebugFilterStateFile, L"\\SystemRoot\\d\\NtSetDebugFilterState.txt");
	RtlInitUnicodeString(&NtSetEventBoostPriorityFile, L"\\SystemRoot\\d\\NtSetEventBoostPriority.txt");
	RtlInitUnicodeString(&NtSetInformationDebugObjectFile, L"\\SystemRoot\\d\\NtSetInformationDebugObject.txt");
	RtlInitUnicodeString(&NtSuspendProcessFile, L"\\SystemRoot\\d\\NtSuspendProcess.txt");
	RtlInitUnicodeString(&NtTraceEventFile, L"\\SystemRoot\\d\\NtTraceEvent.txt");
	RtlInitUnicodeString(&NtTranslateFilePathFile, L"\\SystemRoot\\d\\NtTranslateFilePath.txt");
	RtlInitUnicodeString(&NtWaitForDebugEventFile, L"\\SystemRoot\\d\\NtWaitForDebugEvent.txt");
	RtlInitUnicodeString(&NtCreateKeyedEventFile, L"\\SystemRoot\\d\\NtCreateKeyedEvent.txt");
	RtlInitUnicodeString(&NtOpenKeyedEventFile, L"\\SystemRoot\\d\\NtOpenKeyedEvent.txt");
	RtlInitUnicodeString(&NtReleaseKeyedEventFile, L"\\SystemRoot\\d\\NtReleaseKeyedEvent.txt");
	RtlInitUnicodeString(&NtWaitForKeyedEventFile, L"\\SystemRoot\\d\\NtWaitForKeyedEvent.txt");
	RtlInitUnicodeString(&NtQueryPortInformationProcessFile, L"\\SystemRoot\\d\\NtQueryPortInformationProcess.txt");
	//INIT_FILE_STRINGS_HERE
	
    DbgPrint("DriverEntry Called \r\n");

    RtlInitUnicodeString(&usDriverName, L"\\Device\\MyDriver");
    RtlInitUnicodeString(&usDosDeviceName, L"\\DosDevices\\MyDriver"); 

    NtStatus = IoCreateDevice(pDriverObject, 0, &usDriverName, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &pDeviceObject);

    if(NtStatus == STATUS_SUCCESS) {
        /* MajorFunction: is a list of function pointers for entry points into the driver. */
        for(uiIndex = 0; uiIndex < IRP_MJ_MAXIMUM_FUNCTION; uiIndex++)
             pDriverObject->MajorFunction[uiIndex] = MyDriver_UnSupportedFunction;

			 
		/* DriverUnload is required to be able to dynamically unload the driver. */
        pDriverObject->DriverUnload =  MyDriver_Unload; 
        pDeviceObject->Flags |= 0;
		pDeviceObject->Flags &= (~DO_DEVICE_INITIALIZING);
		
        /* Create a Symbolic Link to the device. MyDriver -> \Device\MyDriver */
        IoCreateSymbolicLink(&usDosDeviceName, &usDriverName);
		DisableWP();
		
		/* hook SSDT */
		//driverCreateFile(&registryFile);
		//driverCreateFile(&threadFile);
		//driverCreateFile(&openProcessFile);
		driverCreateFile(&querySystemFile);
		//driverCreateFile(&virtualMemoryFile);
		//driverCreateFile(&debugActiveProcessFile);
		//driverCreateFile(&createSectionFile);
		//driverCreateFile(&createProcessFile);
		//driverCreateFile(&createProcessExFile);
		//driverCreateFile(&queueApcThreadFile);
		//driverCreateFile(&createThreadFile);
		//driverCreateFile(&createThreadExFile);
		driverCreateFile(&mapViewSectionFile);
		driverCreateFile(&ZwSetContextThreadFile);
		//driverCreateFile(&ZwSystemDebugControlFile);
		//driverCreateFile(&ZwOpenFileFile);
		//driverCreateFile(&ZwCreateFileFile);
		driverCreateFile(&ZwReadFileFile);
		//driverCreateFile(&ZwDeleteFileFile);
		//driverCreateFile(&ZwSetInformationFileFile);
		//driverCreateFile(&ZwCreateMutantFile);
		driverCreateFile(&ZwDeviceIoControlFileFile);
		//driverCreateFile(&ZwTerminateProcessFile);
		//driverCreateFile(&ZwLoadDriverFile);
		driverCreateFile(&ZwDelayExecutionFile);
		//driverCreateFile(&ZwQueryValueKeyFile);
		//driverCreateFile(&ZwQueryAttributesFileFile);
		//driverCreateFile(&ZwAcceptConnectPortFile);
		driverCreateFile(&ZwWaitForSingleObjectFile);
		driverCreateFile(&ZwReplyWaitReceivePortFile);
		driverCreateFile(&ZwRequestWaitReplyPortFile);
		driverCreateFile(&ZwCloseFile);
		driverCreateFile(&ZwSetEventFile);
		driverCreateFile(&ZwOpenThreadTokenFile);
		driverCreateFile(&ZwOpenThreadTokenExFile);
		driverCreateFile(&ZwOpenKeyFile);
		driverCreateFile(&ZwAllocateVirtualMemoryFile);
		driverCreateFile(&ZwProtectVirtualMemoryFile);
		driverCreateFile(&ZwQueryInformationTokenFile);
		driverCreateFile(&ZwEnumerateKeyFile);
		driverCreateFile(&ZwFlushInstructionCacheFile);
		driverCreateFile(&ZwQuerySecurityObjectFile);
		driverCreateFile(&ZwQueryDefaultLocaleFile);
		driverCreateFile(&ZwQuerySystemTimeFile);
		driverCreateFile(&ZwOpenSectionFile);
		driverCreateFile(&ZwSetInformationProcessFile);
		driverCreateFile(&ZwQueryInformationProcessFile);
		driverCreateFile(&ZwGetContextThreadFile);
		driverCreateFile(&ZwCreateProfileFile);
		driverCreateFile(&ZwStartProfileFile);
		driverCreateFile(&ZwAccessCheckFile);
		driverCreateFile(&ZwAccessCheckAndAuditAlarmFile);
		driverCreateFile(&ZwSetSystemInformationFile);
		driverCreateFile(&ZwGetPlugPlayEventFile);
		driverCreateFile(&ZwPlugPlayControlFile);
		driverCreateFile(&ZwLockVirtualMemoryFile);
		driverCreateFile(&ZwUnlockVirtualMemoryFile);
		driverCreateFile(&ZwFlushVirtualMemoryFile);
		driverCreateFile(&ZwAllocateUserPhysicalPagesFile);
		driverCreateFile(&ZwFreeUserPhysicalPagesFile);
		driverCreateFile(&ZwMapUserPhysicalPagesFile);
		driverCreateFile(&ZwMapUserPhysicalPagesScatterFile);
		driverCreateFile(&ZwGetWriteWatchFile);
		driverCreateFile(&ZwResetWriteWatchFile);
		driverCreateFile(&ZwFreeVirtualMemoryFile);
		driverCreateFile(&ZwQueryVirtualMemoryFile);
		driverCreateFile(&ZwReadVirtualMemoryFile);
		driverCreateFile(&ZwWriteVirtualMemoryFile);
		driverCreateFile(&ZwCreateFileFile);
		driverCreateFile(&ZwOpenFileFile);
		driverCreateFile(&ZwDeleteFileFile);
		driverCreateFile(&ZwFlushBuffersFileFile);
		driverCreateFile(&ZwCancelIoFileFile);
		driverCreateFile(&ZwWriteFileFile);
		driverCreateFile(&ZwReadFileScatterFile);
		driverCreateFile(&ZwWriteFileGatherFile);
		driverCreateFile(&ZwLockFileFile);
		driverCreateFile(&ZwUnlockFileFile);
		driverCreateFile(&ZwFsControlFileFile);
		driverCreateFile(&ZwNotifyChangeDirectoryFileFile);
		driverCreateFile(&ZwQueryEaFileFile);
		driverCreateFile(&ZwSetEaFileFile);
		driverCreateFile(&ZwCreateNamedPipeFileFile);
		driverCreateFile(&ZwCreateMailslotFileFile);
		driverCreateFile(&ZwQueryVolumeInformationFileFile);
		driverCreateFile(&ZwSetVolumeInformationFileFile);
		driverCreateFile(&ZwQueryQuotaInformationFileFile);
		driverCreateFile(&ZwSetQuotaInformationFileFile);
		driverCreateFile(&ZwQueryAttributesFileFile);
		driverCreateFile(&ZwQueryFullAttributesFileFile);
		driverCreateFile(&ZwQueryInformationFileFile);
		driverCreateFile(&ZwSetInformationFileFile);
		driverCreateFile(&ZwQueryDirectoryFileFile);
		driverCreateFile(&ZwCreateKeyFile);
		driverCreateFile(&ZwDeleteKeyFile);
		driverCreateFile(&ZwFlushKeyFile);
		driverCreateFile(&ZwSaveKeyFile);
		driverCreateFile(&ZwSaveKeyExFile);
		driverCreateFile(&ZwSaveMergedKeysFile);
		driverCreateFile(&ZwRestoreKeyFile);
		driverCreateFile(&ZwLoadKeyFile);
		driverCreateFile(&ZwLoadKey2File);
		driverCreateFile(&ZwUnloadKeyFile);
		driverCreateFile(&ZwUnloadKeyExFile);
		driverCreateFile(&ZwQueryOpenSubKeysFile);
		driverCreateFile(&ZwReplaceKeyFile);
		driverCreateFile(&ZwSetInformationKeyFile);
		driverCreateFile(&ZwQueryKeyFile);
		driverCreateFile(&ZwNotifyChangeKeyFile);
		driverCreateFile(&ZwNotifyChangeMultipleKeysFile);
		driverCreateFile(&ZwDeleteValueKeyFile);
		driverCreateFile(&ZwSetValueKeyFile);
		driverCreateFile(&ZwQueryValueKeyFile);
		driverCreateFile(&ZwEnumerateValueKeyFile);
		driverCreateFile(&ZwQueryMultipleValueKeyFile);
		driverCreateFile(&ZwInitializeRegistryFile);
		driverCreateFile(&ZwCreatePortFile);
		driverCreateFile(&ZwCreateWaitablePortFile);
		driverCreateFile(&ZwConnectPortFile);
		driverCreateFile(&ZwSecureConnectPortFile);
		driverCreateFile(&ZwListenPortFile);
		driverCreateFile(&ZwAcceptConnectPortFile);
		driverCreateFile(&ZwCompleteConnectPortFile);
		driverCreateFile(&ZwRequestPortFile);
		driverCreateFile(&ZwReplyPortFile);
		driverCreateFile(&ZwReplyWaitReplyPortFile);
		driverCreateFile(&ZwReplyWaitReceivePortExFile);
		driverCreateFile(&ZwReadRequestDataFile);
		driverCreateFile(&ZwWriteRequestDataFile);
		driverCreateFile(&ZwQueryInformationPortFile);
		driverCreateFile(&ZwImpersonateClientOfPortFile);
		driverCreateFile(&ZwCreateProcessFile);
		driverCreateFile(&ZwCreateProcessExFile);
		driverCreateFile(&ZwOpenProcessFile);
		driverCreateFile(&ZwTerminateProcessFile);
		driverCreateFile(&ZwCreateThreadFile);
		driverCreateFile(&ZwOpenThreadFile);
		driverCreateFile(&ZwTerminateThreadFile);
		driverCreateFile(&ZwQueryInformationThreadFile);
		driverCreateFile(&ZwSetInformationThreadFile);
		driverCreateFile(&ZwSuspendThreadFile);
		driverCreateFile(&ZwResumeThreadFile);
		driverCreateFile(&ZwQueueApcThreadFile);
		driverCreateFile(&ZwTestAlertFile);
		driverCreateFile(&ZwAlertThreadFile);
		driverCreateFile(&ZwAlertResumeThreadFile);
		driverCreateFile(&ZwRegisterThreadTerminatePortFile);
		driverCreateFile(&ZwImpersonateThreadFile);
		driverCreateFile(&ZwImpersonateAnonymousTokenFile);
		driverCreateFile(&ZwQuerySystemEnvironmentValueFile);
		driverCreateFile(&ZwQuerySystemEnvironmentValueExFile);
		driverCreateFile(&ZwSetSystemEnvironmentValueFile);
		driverCreateFile(&ZwSetSystemEnvironmentValueExFile);
		driverCreateFile(&ZwShutdownSystemFile);
		driverCreateFile(&ZwSystemDebugControlFile);
		driverCreateFile(&ZwQueryObjectFile);
		driverCreateFile(&ZwSetInformationObjectFile);
		driverCreateFile(&ZwDuplicateObjectFile);
		driverCreateFile(&ZwMakeTemporaryObjectFile);
		driverCreateFile(&ZwSetSecurityObjectFile);
		driverCreateFile(&ZwCreateDirectoryObjectFile);
		driverCreateFile(&ZwOpenDirectoryObjectFile);
		driverCreateFile(&ZwQueryDirectoryObjectFile);
		driverCreateFile(&ZwCreateSymbolicLinkObjectFile);
		driverCreateFile(&ZwOpenSymbolicLinkObjectFile);
		driverCreateFile(&ZwQuerySymbolicLinkObjectFile);
		driverCreateFile(&ZwCreateSectionFile);
		driverCreateFile(&ZwQuerySectionFile);
		driverCreateFile(&ZwExtendSectionFile);
		driverCreateFile(&ZwUnmapViewOfSectionFile);
		driverCreateFile(&ZwAreMappedFilesTheSameFile);
		driverCreateFile(&ZwCreateJobObjectFile);
		driverCreateFile(&ZwOpenJobObjectFile);
		driverCreateFile(&ZwTerminateJobObjectFile);
		driverCreateFile(&ZwAssignProcessToJobObjectFile);
		driverCreateFile(&ZwQueryInformationJobObjectFile);
		driverCreateFile(&ZwSetInformationJobObjectFile);
		driverCreateFile(&ZwCreateTokenFile);
		driverCreateFile(&ZwOpenProcessTokenFile);
		driverCreateFile(&ZwOpenProcessTokenExFile);
		driverCreateFile(&ZwDuplicateTokenFile);
		driverCreateFile(&ZwFilterTokenFile);
		driverCreateFile(&ZwAdjustPrivilegesTokenFile);
		driverCreateFile(&ZwAdjustGroupsTokenFile);
		driverCreateFile(&ZwSetInformationTokenFile);
		driverCreateFile(&ZwSignalAndWaitForSingleObjectFile);
		driverCreateFile(&ZwWaitForMultipleObjectsFile);
		driverCreateFile(&ZwCreateTimerFile);
		driverCreateFile(&ZwOpenTimerFile);
		driverCreateFile(&ZwCancelTimerFile);
		driverCreateFile(&ZwSetTimerFile);
		driverCreateFile(&ZwQueryTimerFile);
		driverCreateFile(&ZwCreateEventFile);
		driverCreateFile(&ZwOpenEventFile);
		driverCreateFile(&ZwPulseEventFile);
		driverCreateFile(&ZwResetEventFile);
		driverCreateFile(&ZwClearEventFile);
		driverCreateFile(&ZwQueryEventFile);
		driverCreateFile(&ZwCreateSemaphoreFile);
		driverCreateFile(&ZwOpenSemaphoreFile);
		driverCreateFile(&ZwReleaseSemaphoreFile);
		driverCreateFile(&ZwQuerySemaphoreFile);
		driverCreateFile(&ZwCreateMutantFile);
		driverCreateFile(&ZwOpenMutantFile);
		driverCreateFile(&ZwReleaseMutantFile);
		driverCreateFile(&ZwQueryMutantFile);
		driverCreateFile(&ZwCreateIoCompletionFile);
		driverCreateFile(&ZwOpenIoCompletionFile);
		driverCreateFile(&ZwSetIoCompletionFile);
		driverCreateFile(&ZwRemoveIoCompletionFile);
		driverCreateFile(&ZwQueryIoCompletionFile);
		driverCreateFile(&ZwCreateEventPairFile);
		driverCreateFile(&ZwOpenEventPairFile);
		driverCreateFile(&ZwWaitLowEventPairFile);
		driverCreateFile(&ZwWaitHighEventPairFile);
		driverCreateFile(&ZwSetLowWaitHighEventPairFile);
		driverCreateFile(&ZwSetHighWaitLowEventPairFile);
		driverCreateFile(&ZwSetLowEventPairFile);
		driverCreateFile(&ZwSetHighEventPairFile);
		driverCreateFile(&ZwSetSystemTimeFile);
		driverCreateFile(&ZwQueryPerformanceCounterFile);
		driverCreateFile(&ZwSetTimerResolutionFile);
		driverCreateFile(&ZwQueryTimerResolutionFile);
		driverCreateFile(&ZwYieldExecutionFile);
		driverCreateFile(&ZwSetIntervalProfileFile);
		driverCreateFile(&ZwQueryIntervalProfileFile);
		driverCreateFile(&ZwStopProfileFile);
		driverCreateFile(&ZwPrivilegeCheckFile);
		driverCreateFile(&ZwPrivilegeObjectAuditAlarmFile);
		driverCreateFile(&ZwPrivilegedServiceAuditAlarmFile);
		driverCreateFile(&ZwAccessCheckByTypeFile);
		driverCreateFile(&ZwAccessCheckByTypeAndAuditAlarmFile);
		driverCreateFile(&ZwAccessCheckByTypeResultListFile);
		driverCreateFile(&ZwAccessCheckByTypeResultListAndAuditAlarmFile);
		driverCreateFile(&ZwAccessCheckByTypeResultListAndAuditAlarmByHandleFile);
		driverCreateFile(&ZwOpenObjectAuditAlarmFile);
		driverCreateFile(&ZwCloseObjectAuditAlarmFile);
		driverCreateFile(&ZwDeleteObjectAuditAlarmFile);
		driverCreateFile(&ZwRequestWakeupLatencyFile);
		driverCreateFile(&ZwRequestDeviceWakeupFile);
		driverCreateFile(&ZwCancelDeviceWakeupRequestFile);
		driverCreateFile(&ZwIsSystemResumeAutomaticFile);
		driverCreateFile(&ZwSetThreadExecutionStateFile);
		driverCreateFile(&ZwGetDevicePowerStateFile);
		driverCreateFile(&ZwSetSystemPowerStateFile);
		driverCreateFile(&ZwInitiatePowerActionFile);
		driverCreateFile(&ZwPowerInformationFile);
		driverCreateFile(&ZwRaiseExceptionFile);
		//driverCreateFile(&ZwContinueFile);
		driverCreateFile(&ZwCallbackReturnFile);
		driverCreateFile(&ZwLoadDriverFile);
		driverCreateFile(&ZwUnloadDriverFile);
		driverCreateFile(&ZwFlushWriteBufferFile);
		driverCreateFile(&ZwSetDefaultLocaleFile);
		driverCreateFile(&ZwQueryDefaultUILanguageFile);
		driverCreateFile(&ZwSetDefaultUILanguageFile);
		driverCreateFile(&ZwQueryInstallUILanguageFile);
		driverCreateFile(&ZwAllocateLocallyUniqueIdFile);
		driverCreateFile(&ZwAllocateUuidsFile);
		driverCreateFile(&ZwSetUuidSeedFile);
		driverCreateFile(&ZwRaiseHardErrorFile);
		driverCreateFile(&ZwSetDefaultHardErrorPortFile);
		driverCreateFile(&ZwDisplayStringFile);
		driverCreateFile(&ZwCreatePagingFileFile);
		driverCreateFile(&ZwAddAtomFile);
		driverCreateFile(&ZwFindAtomFile);
		driverCreateFile(&ZwDeleteAtomFile);
		driverCreateFile(&ZwQueryInformationAtomFile);
		driverCreateFile(&ZwSetLdtEntriesFile);
		driverCreateFile(&ZwVdmControlFile);
		driverCreateFile(&NtSetBootEntryOrderFile);
		driverCreateFile(&NtCompactKeysFile);
		driverCreateFile(&NtCompareTokensFile);
		driverCreateFile(&NtCompressKeyFile);
		driverCreateFile(&NtCreateDebugObjectFile);
		driverCreateFile(&NtCreateJobSetFile);
		driverCreateFile(&NtDebugActiveProcessFile);
		driverCreateFile(&NtDebugContinueFile);
		driverCreateFile(&NtEnumerateSystemEnvironmentValuesExFile);
		driverCreateFile(&NtIsProcessInJobFile);
		driverCreateFile(&NtLockProductActivationKeysFile);
		driverCreateFile(&NtLockRegistryKeyFile);
		driverCreateFile(&NtMakePermanentObjectFile);
		driverCreateFile(&NtDeleteBootEntryFile);
		driverCreateFile(&NtQueryDebugFilterStateFile);
		driverCreateFile(&NtRemoveProcessDebugFile);
		driverCreateFile(&NtRenameKeyFile);
		driverCreateFile(&NtResumeProcessFile);
		driverCreateFile(&NtSetDebugFilterStateFile);
		driverCreateFile(&NtSetEventBoostPriorityFile);
		driverCreateFile(&NtSetInformationDebugObjectFile);
		driverCreateFile(&NtSuspendProcessFile);
		driverCreateFile(&NtTraceEventFile);
		driverCreateFile(&NtTranslateFilePathFile);
		driverCreateFile(&NtWaitForDebugEventFile);
		driverCreateFile(&NtCreateKeyedEventFile);
		driverCreateFile(&NtOpenKeyedEventFile);
		driverCreateFile(&NtReleaseKeyedEventFile);
		driverCreateFile(&NtWaitForKeyedEventFile);
		driverCreateFile(&NtQueryPortInformationProcessFile);
		//CREATE_FILE_HERE
		
		
		systemCallTable = KeServiceDescriptorTable.ServiceTable;
		
		//oldZwSetValueKey = (ZwSetValueKeyPtr)hookSSDT((BYTE*)ZwSetValueKey, (BYTE*)newZwSetValueKey, (DWORD*)systemCallTable);
		oldZwQuerySystemInformation = (ZwQuerySystemInformationPtr)hookSSDT((BYTE*)ZwQuerySystemInformation, (BYTE*)newZwQuerySystemInformation, (DWORD*)systemCallTable);
		//oldZwOpenProcess = (ZwOpenProcessPtr)hookSSDT((BYTE*)ZwOpenProcess, (BYTE*)newZwOpenProcess, (DWORD*)systemCallTable);
		//oldZwWriteVirtualMemory = (ZwWriteVirtualMemoryPtr)hookSSDTWithIndex(WRITE_VIRUTAL_MEMORY_INDEX, (BYTE*)newZwWriteVirtualMemory, (DWORD*)systemCallTable);
		//oldZwDebugActiveProcess = (ZwDebugActiveProcessPtr)hookSSDTWithIndex(DEBUG_ACTIVE_PROCESS_INDEX, (BYTE*)newZwDebugActiveProcess, (DWORD*)systemCallTable);
		//oldZwCreateSection = (ZwCreateSectionPtr)hookSSDTWithIndex(CREATE_SECTION_INDEX, (BYTE*)newZwCreateSection, (DWORD*)systemCallTable);
		//oldZwCreateProcess = (ZwCreateProcessPtr)hookSSDTWithIndex(CREATE_PROCESS_INDEX, (BYTE*)newZwCreateProcess, (DWORD*)systemCallTable);
		//oldZwCreateProcessEx = (ZwCreateProcessExPtr)hookSSDTWithIndex(CREATE_PROCESS_EX_INDEX, (BYTE*)newZwCreateProcessEx, (DWORD*)systemCallTable);
		//oldZwCreateThread = (ZwCreateThreadPtr)hookSSDTWithIndex(CREATE_THREAD_INDEX, (BYTE*)newZwCreateThread, (DWORD*)systemCallTable);
		//oldZwCreateThreadEx = (ZwCreateThreadExPtr)hookSSDTWithIndex(CREATE_THREAD_EX_INDEX, (BYTE*)newZwCreateThreadEx, (DWORD*)systemCallTable);
		oldZwMapViewOfSection = (ZwMapViewOfSectionPtr)hookSSDTWithIndex(MAP_VIEW_OF_SECTION_INDEX, (BYTE*)newZwMapViewOfSection, (DWORD*)systemCallTable);
		oldZwSetContextThread = (ZwSetContextThreadPtr)hookSSDTWithIndex(SET_CONTEXT_THREAD_INDEX, (BYTE*)newZwSetContextThread, (DWORD*)systemCallTable);
		//oldZwSystemDebugControl = (ZwSystemDebugControlPtr)hookSSDTWithIndex(SYSTEM_DEBUG_CONTROL_INDEX, (BYTE*)newZwSystemDebugControl, (DWORD*)systemCallTable);
		//oldZwOpenFile = (ZwOpenFilePtr)hookSSDT((BYTE*)ZwOpenFile, (BYTE*)newZwOpenFile, (DWORD*)systemCallTable);
		//oldZwCreateFile = (ZwCreateFilePtr)hookSSDTWithIndex(CREATE_FILE_INDEX, (BYTE*)newZwCreateFile, (DWORD*)systemCallTable);
		oldZwReadFile = (ZwReadFilePtr)hookSSDTWithIndex(READ_FILE_INDEX, (BYTE*)newZwReadFile, (DWORD*)systemCallTable);
		//oldZwDeleteFile = (ZwDeleteFilePtr)hookSSDTWithIndex(DELETE_FILE_INDEX, (BYTE*)newZwDeleteFile, (DWORD*)systemCallTable);
		//oldZwSetInformationFile = (ZwSetInformationFilePtr)hookSSDTWithIndex(SET_INFORMATION_FILE_INDEX, (BYTE*)newZwSetInformationFile, (DWORD*)systemCallTable);
		//oldZwCreateMutant = (ZwCreateMutantPtr)hookSSDTWithIndex(CREATE_MUTANT_INDEX, (BYTE*)newZwCreateMutant, (DWORD*)systemCallTable);
		oldZwDeviceIoControlFile = (ZwDeviceIoControlFilePtr)hookSSDTWithIndex(DEVICE_IO_CONTROL_FILE_INDEX, (BYTE*)newZwDeviceIoControlFile, (DWORD*)systemCallTable);
		//oldZwTerminateProcess = (ZwTerminateProcessPtr)hookSSDTWithIndex(TERMINATE_PROCESS_INDEX, (BYTE*)newZwTerminateProcess, (DWORD*)systemCallTable);
		//oldZwLoadDriver = (ZwLoadDriverPtr)hookSSDTWithIndex(LOAD_DRIVER_INDEX, (BYTE*)newZwLoadDriver, (DWORD*)systemCallTable);
		oldZwDelayExecution = (ZwDelayExecutionPtr)hookSSDTWithIndex(DELAY_EXECUTION_INDEX, (BYTE*)newZwDelayExecution, (DWORD*)systemCallTable);
		//oldZwQueryValueKey = (ZwQueryValueKeyPtr)hookSSDTWithIndex(QUERY_VALUE_KEY_INDEX, (BYTE*)newZwQueryValueKey, (DWORD*)systemCallTable);
		//oldZwQueryAttributesFile = (ZwQueryAttributesFilePtr)hookSSDTWithIndex(QUERY_ATTRIBUTES_FILE_INDEX, (BYTE*)newZwQueryAttributesFile, (DWORD*)systemCallTable);
		//oldZwAcceptConnectPort = (ZwAcceptConnectPortPtr)hookSSDTWithIndex(ACCEPT_CONNECT_PORT, (BYTE*)newZwAcceptConnectPort, (DWORD*)systemCallTable);
		oldZwWaitForSingleObject = (ZwWaitForSingleObjectPtr)hookSSDTWithIndex(WAIT_FOR_SINGLE_OBJECT, (BYTE*)newZwWaitForSingleObject, (DWORD*)systemCallTable);
		oldZwReplyWaitReceivePort = (ZwReplyWaitReceivePortPtr)hookSSDTWithIndex(REPLY_WAIT_RECEIVE_PORT, (BYTE*)newZwReplyWaitReceivePort, (DWORD*)systemCallTable);
		oldZwRequestWaitReplyPort = (ZwRequestWaitReplyPortPtr)hookSSDTWithIndex(REQUEST_WAIT_REPLY_PORT, (BYTE*)newZwRequestWaitReplyPort, (DWORD*)systemCallTable);
		oldZwClose = (ZwClosePtr)hookSSDTWithIndex(CLOSE, (BYTE*)newZwClose, (DWORD*)systemCallTable);
		oldZwSetEvent = (ZwSetEventPtr)hookSSDTWithIndex(SET_EVENT, (BYTE*)newZwSetEvent, (DWORD*)systemCallTable);
		oldZwOpenThreadToken = (ZwOpenThreadTokenPtr)hookSSDTWithIndex(OPEN_THREAD_TOKEN, (BYTE*)newZwOpenThreadToken, (DWORD*)systemCallTable);
		oldZwOpenThreadTokenEx = (ZwOpenThreadTokenExPtr)hookSSDTWithIndex(OPEN_THREAD_TOKEN_EX, (BYTE*)newZwOpenThreadTokenEx, (DWORD*)systemCallTable);
		oldZwOpenKey = (ZwOpenKeyPtr)hookSSDTWithIndex(OPEN_KEY, (BYTE*)newZwOpenKey, (DWORD*)systemCallTable);
		oldZwAllocateVirtualMemory = (ZwAllocateVirtualMemoryPtr)hookSSDTWithIndex(ALLOCATE_VIRTUAL_MEMORY, (BYTE*)newZwAllocateVirtualMemory, (DWORD*)systemCallTable);
		oldZwProtectVirtualMemory = (ZwProtectVirtualMemoryPtr)hookSSDTWithIndex(PROTECT_VIRTUAL_MEMORY, (BYTE*)newZwProtectVirtualMemory, (DWORD*)systemCallTable);
		oldZwQueryInformationToken = (ZwQueryInformationTokenPtr)hookSSDTWithIndex(QUERY_INFORMATION_TOKEN, (BYTE*)newZwQueryInformationToken, (DWORD*)systemCallTable);
		oldZwEnumerateKey = (ZwEnumerateKeyPtr)hookSSDTWithIndex(ENUMERATE_KEY, (BYTE*)newZwEnumerateKey, (DWORD*)systemCallTable);
		oldZwFlushInstructionCache = (ZwFlushInstructionCachePtr)hookSSDTWithIndex(FLUSH_INSTRUCTION_CACHE, (BYTE*)newZwFlushInstructionCache, (DWORD*)systemCallTable);
		oldZwQuerySecurityObject = (ZwQuerySecurityObjectPtr)hookSSDTWithIndex(QUERY_SECURITY_OBJECT, (BYTE*)newZwQuerySecurityObject, (DWORD*)systemCallTable);
		oldZwQueryDefaultLocale = (ZwQueryDefaultLocalePtr)hookSSDTWithIndex(QUERY_DEFAULT_LOCALE, (BYTE*)newZwQueryDefaultLocale, (DWORD*)systemCallTable);
		oldZwQuerySystemTime = (ZwQuerySystemTimePtr)hookSSDTWithIndex(QUERY_SYSTEM_TIME, (BYTE*)newZwQuerySystemTime, (DWORD*)systemCallTable);
		oldZwOpenSection = (ZwOpenSectionPtr)hookSSDTWithIndex(OPEN_SECTION, (BYTE*)newZwOpenSection, (DWORD*)systemCallTable);
		oldZwSetInformationProcess = (ZwSetInformationProcessPtr)hookSSDTWithIndex(SET_INFORMATION_PROCESS, (BYTE*)newZwSetInformationProcess, (DWORD*)systemCallTable);
		oldZwQueryInformationProcess = (ZwQueryInformationProcessPtr)hookSSDTWithIndex(QUERY_INFORMATION_PROCESS, (BYTE*)newZwQueryInformationProcess, (DWORD*)systemCallTable);
		oldZwGetContextThread = (ZwGetContextThreadPtr)hookSSDTWithIndex(GET_CONTEXT_THREAD, (BYTE*)newZwGetContextThread, (DWORD*)systemCallTable);
		oldZwCreateProfile = (ZwCreateProfilePtr)hookSSDTWithIndex(CREATE_PROFILE, (BYTE*)newZwCreateProfile, (DWORD*)systemCallTable);
		oldZwStartProfile = (ZwStartProfilePtr)hookSSDTWithIndex(START_PROFILE, (BYTE*)newZwStartProfile, (DWORD*)systemCallTable);
		oldZwAccessCheck = (ZwAccessCheckPtr)hookSSDTWithIndex(ACCESS_CHECK, (BYTE*)newZwAccessCheck, (DWORD*)systemCallTable);
		oldZwAccessCheckAndAuditAlarm = (ZwAccessCheckAndAuditAlarmPtr)hookSSDTWithIndex(ACCESS_CHECK_AND_AUDIT_ALARM, (BYTE*)newZwAccessCheckAndAuditAlarm, (DWORD*)systemCallTable);
		oldZwSetSystemInformation = (ZwSetSystemInformationPtr)hookSSDTWithIndex(SET_SYSTEM_INFORMATION, (BYTE*)newZwSetSystemInformation, (DWORD*)systemCallTable);
		oldZwGetPlugPlayEvent = (ZwGetPlugPlayEventPtr)hookSSDTWithIndex(GET_PLUG_PLAY_EVENT, (BYTE*)newZwGetPlugPlayEvent, (DWORD*)systemCallTable);
		oldZwPlugPlayControl = (ZwPlugPlayControlPtr)hookSSDTWithIndex(PLUG_PLAY_CONTROL, (BYTE*)newZwPlugPlayControl, (DWORD*)systemCallTable);
		oldZwLockVirtualMemory = (ZwLockVirtualMemoryPtr)hookSSDTWithIndex(LOCK_VIRTUAL_MEMORY, (BYTE*)newZwLockVirtualMemory, (DWORD*)systemCallTable);
		oldZwUnlockVirtualMemory = (ZwUnlockVirtualMemoryPtr)hookSSDTWithIndex(UNLOCK_VIRTUAL_MEMORY, (BYTE*)newZwUnlockVirtualMemory, (DWORD*)systemCallTable);
		oldZwFlushVirtualMemory = (ZwFlushVirtualMemoryPtr)hookSSDTWithIndex(FLUSH_VIRTUAL_MEMORY, (BYTE*)newZwFlushVirtualMemory, (DWORD*)systemCallTable);
		oldZwAllocateUserPhysicalPages = (ZwAllocateUserPhysicalPagesPtr)hookSSDTWithIndex(ALLOCATE_USER_PHYSICAL_PAGES, (BYTE*)newZwAllocateUserPhysicalPages, (DWORD*)systemCallTable);
		oldZwFreeUserPhysicalPages = (ZwFreeUserPhysicalPagesPtr)hookSSDTWithIndex(FREE_USER_PHYSICAL_PAGES, (BYTE*)newZwFreeUserPhysicalPages, (DWORD*)systemCallTable);
		oldZwMapUserPhysicalPages = (ZwMapUserPhysicalPagesPtr)hookSSDTWithIndex(MAP_USER_PHYSICAL_PAGES, (BYTE*)newZwMapUserPhysicalPages, (DWORD*)systemCallTable);
		oldZwMapUserPhysicalPagesScatter = (ZwMapUserPhysicalPagesScatterPtr)hookSSDTWithIndex(MAP_USER_PHYSICAL_PAGES_SCATTER, (BYTE*)newZwMapUserPhysicalPagesScatter, (DWORD*)systemCallTable);
		oldZwGetWriteWatch = (ZwGetWriteWatchPtr)hookSSDTWithIndex(GET_WRITE_WATCH, (BYTE*)newZwGetWriteWatch, (DWORD*)systemCallTable);
		oldZwResetWriteWatch = (ZwResetWriteWatchPtr)hookSSDTWithIndex(RESET_WRITE_WATCH, (BYTE*)newZwResetWriteWatch, (DWORD*)systemCallTable);
		oldZwFreeVirtualMemory = (ZwFreeVirtualMemoryPtr)hookSSDTWithIndex(FREE_VIRTUAL_MEMORY, (BYTE*)newZwFreeVirtualMemory, (DWORD*)systemCallTable);
		oldZwQueryVirtualMemory = (ZwQueryVirtualMemoryPtr)hookSSDTWithIndex(QUERY_VIRTUAL_MEMORY, (BYTE*)newZwQueryVirtualMemory, (DWORD*)systemCallTable);
		oldZwReadVirtualMemory = (ZwReadVirtualMemoryPtr)hookSSDTWithIndex(READ_VIRTUAL_MEMORY, (BYTE*)newZwReadVirtualMemory, (DWORD*)systemCallTable);
		oldZwWriteVirtualMemory = (ZwWriteVirtualMemoryPtr)hookSSDTWithIndex(WRITE_VIRTUAL_MEMORY, (BYTE*)newZwWriteVirtualMemory, (DWORD*)systemCallTable);
		oldZwCreateFile = (ZwCreateFilePtr)hookSSDTWithIndex(CREATE_FILE, (BYTE*)newZwCreateFile, (DWORD*)systemCallTable);
		oldZwOpenFile = (ZwOpenFilePtr)hookSSDTWithIndex(OPEN_FILE, (BYTE*)newZwOpenFile, (DWORD*)systemCallTable);
		oldZwDeleteFile = (ZwDeleteFilePtr)hookSSDTWithIndex(DELETE_FILE, (BYTE*)newZwDeleteFile, (DWORD*)systemCallTable);
		oldZwFlushBuffersFile = (ZwFlushBuffersFilePtr)hookSSDTWithIndex(FLUSH_BUFFERS_FILE, (BYTE*)newZwFlushBuffersFile, (DWORD*)systemCallTable);
		oldZwCancelIoFile = (ZwCancelIoFilePtr)hookSSDTWithIndex(CANCEL_IO_FILE, (BYTE*)newZwCancelIoFile, (DWORD*)systemCallTable);
		oldZwWriteFile = (ZwWriteFilePtr)hookSSDTWithIndex(WRITE_FILE, (BYTE*)newZwWriteFile, (DWORD*)systemCallTable);
		oldZwReadFileScatter = (ZwReadFileScatterPtr)hookSSDTWithIndex(READ_FILE_SCATTER, (BYTE*)newZwReadFileScatter, (DWORD*)systemCallTable);
		oldZwWriteFileGather = (ZwWriteFileGatherPtr)hookSSDTWithIndex(WRITE_FILE_GATHER, (BYTE*)newZwWriteFileGather, (DWORD*)systemCallTable);
		oldZwLockFile = (ZwLockFilePtr)hookSSDTWithIndex(LOCK_FILE, (BYTE*)newZwLockFile, (DWORD*)systemCallTable);
		oldZwUnlockFile = (ZwUnlockFilePtr)hookSSDTWithIndex(UNLOCK_FILE, (BYTE*)newZwUnlockFile, (DWORD*)systemCallTable);
		oldZwFsControlFile = (ZwFsControlFilePtr)hookSSDTWithIndex(FS_CONTROL_FILE, (BYTE*)newZwFsControlFile, (DWORD*)systemCallTable);
		oldZwNotifyChangeDirectoryFile = (ZwNotifyChangeDirectoryFilePtr)hookSSDTWithIndex(NOTIFY_CHANGE_DIRECTORY_FILE, (BYTE*)newZwNotifyChangeDirectoryFile, (DWORD*)systemCallTable);
		oldZwQueryEaFile = (ZwQueryEaFilePtr)hookSSDTWithIndex(QUERY_EA_FILE, (BYTE*)newZwQueryEaFile, (DWORD*)systemCallTable);
		oldZwSetEaFile = (ZwSetEaFilePtr)hookSSDTWithIndex(SET_EA_FILE, (BYTE*)newZwSetEaFile, (DWORD*)systemCallTable);
		oldZwCreateNamedPipeFile = (ZwCreateNamedPipeFilePtr)hookSSDTWithIndex(CREATE_NAMED_PIPE_FILE, (BYTE*)newZwCreateNamedPipeFile, (DWORD*)systemCallTable);
		oldZwCreateMailslotFile = (ZwCreateMailslotFilePtr)hookSSDTWithIndex(CREATE_MAILSLOT_FILE, (BYTE*)newZwCreateMailslotFile, (DWORD*)systemCallTable);
		oldZwQueryVolumeInformationFile = (ZwQueryVolumeInformationFilePtr)hookSSDTWithIndex(QUERY_VOLUME_INFORMATION_FILE, (BYTE*)newZwQueryVolumeInformationFile, (DWORD*)systemCallTable);
		oldZwSetVolumeInformationFile = (ZwSetVolumeInformationFilePtr)hookSSDTWithIndex(SET_VOLUME_INFORMATION_FILE, (BYTE*)newZwSetVolumeInformationFile, (DWORD*)systemCallTable);
		oldZwQueryQuotaInformationFile = (ZwQueryQuotaInformationFilePtr)hookSSDTWithIndex(QUERY_QUOTA_INFORMATION_FILE, (BYTE*)newZwQueryQuotaInformationFile, (DWORD*)systemCallTable);
		oldZwSetQuotaInformationFile = (ZwSetQuotaInformationFilePtr)hookSSDTWithIndex(SET_QUOTA_INFORMATION_FILE, (BYTE*)newZwSetQuotaInformationFile, (DWORD*)systemCallTable);
		oldZwQueryAttributesFile = (ZwQueryAttributesFilePtr)hookSSDTWithIndex(QUERY_ATTRIBUTES_FILE, (BYTE*)newZwQueryAttributesFile, (DWORD*)systemCallTable);
		oldZwQueryFullAttributesFile = (ZwQueryFullAttributesFilePtr)hookSSDTWithIndex(QUERY_FULL_ATTRIBUTES_FILE, (BYTE*)newZwQueryFullAttributesFile, (DWORD*)systemCallTable);
		oldZwQueryInformationFile = (ZwQueryInformationFilePtr)hookSSDTWithIndex(QUERY_INFORMATION_FILE, (BYTE*)newZwQueryInformationFile, (DWORD*)systemCallTable);
		oldZwSetInformationFile = (ZwSetInformationFilePtr)hookSSDTWithIndex(SET_INFORMATION_FILE, (BYTE*)newZwSetInformationFile, (DWORD*)systemCallTable);
		oldZwQueryDirectoryFile = (ZwQueryDirectoryFilePtr)hookSSDTWithIndex(QUERY_DIRECTORY_FILE, (BYTE*)newZwQueryDirectoryFile, (DWORD*)systemCallTable);
		oldZwCreateKey = (ZwCreateKeyPtr)hookSSDTWithIndex(CREATE_KEY, (BYTE*)newZwCreateKey, (DWORD*)systemCallTable);
		oldZwDeleteKey = (ZwDeleteKeyPtr)hookSSDTWithIndex(DELETE_KEY, (BYTE*)newZwDeleteKey, (DWORD*)systemCallTable);
		oldZwFlushKey = (ZwFlushKeyPtr)hookSSDTWithIndex(FLUSH_KEY, (BYTE*)newZwFlushKey, (DWORD*)systemCallTable);
		oldZwSaveKey = (ZwSaveKeyPtr)hookSSDTWithIndex(SAVE_KEY, (BYTE*)newZwSaveKey, (DWORD*)systemCallTable);
		oldZwSaveKeyEx = (ZwSaveKeyExPtr)hookSSDTWithIndex(SAVE_KEY_EX, (BYTE*)newZwSaveKeyEx, (DWORD*)systemCallTable);
		oldZwSaveMergedKeys = (ZwSaveMergedKeysPtr)hookSSDTWithIndex(SAVE_MERGED_KEYS, (BYTE*)newZwSaveMergedKeys, (DWORD*)systemCallTable);
		oldZwRestoreKey = (ZwRestoreKeyPtr)hookSSDTWithIndex(RESTORE_KEY, (BYTE*)newZwRestoreKey, (DWORD*)systemCallTable);
		oldZwLoadKey = (ZwLoadKeyPtr)hookSSDTWithIndex(LOAD_KEY, (BYTE*)newZwLoadKey, (DWORD*)systemCallTable);
		oldZwLoadKey2 = (ZwLoadKey2Ptr)hookSSDTWithIndex(LOAD_KEY2, (BYTE*)newZwLoadKey2, (DWORD*)systemCallTable);
		oldZwUnloadKey = (ZwUnloadKeyPtr)hookSSDTWithIndex(UNLOAD_KEY, (BYTE*)newZwUnloadKey, (DWORD*)systemCallTable);
		oldZwUnloadKeyEx = (ZwUnloadKeyExPtr)hookSSDTWithIndex(UNLOAD_KEY_EX, (BYTE*)newZwUnloadKeyEx, (DWORD*)systemCallTable);
		oldZwQueryOpenSubKeys = (ZwQueryOpenSubKeysPtr)hookSSDTWithIndex(QUERY_OPEN_SUBKEYS, (BYTE*)newZwQueryOpenSubKeys, (DWORD*)systemCallTable);
		oldZwReplaceKey = (ZwReplaceKeyPtr)hookSSDTWithIndex(REPLACE_KEY, (BYTE*)newZwReplaceKey, (DWORD*)systemCallTable);
		oldZwSetInformationKey = (ZwSetInformationKeyPtr)hookSSDTWithIndex(SET_INFORMATION_KEY, (BYTE*)newZwSetInformationKey, (DWORD*)systemCallTable);
		oldZwQueryKey = (ZwQueryKeyPtr)hookSSDTWithIndex(QUERY_KEY, (BYTE*)newZwQueryKey, (DWORD*)systemCallTable);
		oldZwNotifyChangeKey = (ZwNotifyChangeKeyPtr)hookSSDTWithIndex(NOTIFY_CHANGE_KEY, (BYTE*)newZwNotifyChangeKey, (DWORD*)systemCallTable);
		oldZwNotifyChangeMultipleKeys = (ZwNotifyChangeMultipleKeysPtr)hookSSDTWithIndex(NOTIFY_CHANGE_MULTIPLE_KEYS, (BYTE*)newZwNotifyChangeMultipleKeys, (DWORD*)systemCallTable);
		oldZwDeleteValueKey = (ZwDeleteValueKeyPtr)hookSSDTWithIndex(DELETE_VALUE_KEY, (BYTE*)newZwDeleteValueKey, (DWORD*)systemCallTable);
		oldZwSetValueKey = (ZwSetValueKeyPtr)hookSSDTWithIndex(SET_VALUE_KEY, (BYTE*)newZwSetValueKey, (DWORD*)systemCallTable);
		oldZwQueryValueKey = (ZwQueryValueKeyPtr)hookSSDTWithIndex(QUERY_VALUE_KEY, (BYTE*)newZwQueryValueKey, (DWORD*)systemCallTable);
		oldZwEnumerateValueKey = (ZwEnumerateValueKeyPtr)hookSSDTWithIndex(ENUMERATE_VALUE_KEY, (BYTE*)newZwEnumerateValueKey, (DWORD*)systemCallTable);
		oldZwQueryMultipleValueKey = (ZwQueryMultipleValueKeyPtr)hookSSDTWithIndex(QUERY_MULTIPLE_VALUE_KEY, (BYTE*)newZwQueryMultipleValueKey, (DWORD*)systemCallTable);
		oldZwInitializeRegistry = (ZwInitializeRegistryPtr)hookSSDTWithIndex(INITIALIZE_REGISTRY, (BYTE*)newZwInitializeRegistry, (DWORD*)systemCallTable);
		oldZwCreatePort = (ZwCreatePortPtr)hookSSDTWithIndex(CREATE_PORT, (BYTE*)newZwCreatePort, (DWORD*)systemCallTable);
		oldZwCreateWaitablePort = (ZwCreateWaitablePortPtr)hookSSDTWithIndex(CREATE_WAITABLE_PORT, (BYTE*)newZwCreateWaitablePort, (DWORD*)systemCallTable);
		oldZwConnectPort = (ZwConnectPortPtr)hookSSDTWithIndex(CONNECT_PORT, (BYTE*)newZwConnectPort, (DWORD*)systemCallTable);
		oldZwSecureConnectPort = (ZwSecureConnectPortPtr)hookSSDTWithIndex(SECURE_CONNECT_PORT, (BYTE*)newZwSecureConnectPort, (DWORD*)systemCallTable);
		oldZwListenPort = (ZwListenPortPtr)hookSSDTWithIndex(LISTEN_PORT, (BYTE*)newZwListenPort, (DWORD*)systemCallTable);
		oldZwAcceptConnectPort = (ZwAcceptConnectPortPtr)hookSSDTWithIndex(ACCEPT_CONNECT_PORT, (BYTE*)newZwAcceptConnectPort, (DWORD*)systemCallTable);
		oldZwCompleteConnectPort = (ZwCompleteConnectPortPtr)hookSSDTWithIndex(COMPLETE_CONNECT_PORT, (BYTE*)newZwCompleteConnectPort, (DWORD*)systemCallTable);
		oldZwRequestPort = (ZwRequestPortPtr)hookSSDTWithIndex(REQUEST_PORT, (BYTE*)newZwRequestPort, (DWORD*)systemCallTable);
		oldZwReplyPort = (ZwReplyPortPtr)hookSSDTWithIndex(REPLY_PORT, (BYTE*)newZwReplyPort, (DWORD*)systemCallTable);
		oldZwReplyWaitReplyPort = (ZwReplyWaitReplyPortPtr)hookSSDTWithIndex(REPLY_WAIT_REPLY_PORT, (BYTE*)newZwReplyWaitReplyPort, (DWORD*)systemCallTable);
		oldZwReplyWaitReceivePortEx = (ZwReplyWaitReceivePortExPtr)hookSSDTWithIndex(REPLY_WAIT_RECEIVE_PORT_EX, (BYTE*)newZwReplyWaitReceivePortEx, (DWORD*)systemCallTable);
		oldZwReadRequestData = (ZwReadRequestDataPtr)hookSSDTWithIndex(READ_REQUEST_DATA, (BYTE*)newZwReadRequestData, (DWORD*)systemCallTable);
		oldZwWriteRequestData = (ZwWriteRequestDataPtr)hookSSDTWithIndex(WRITE_REQUEST_DATA, (BYTE*)newZwWriteRequestData, (DWORD*)systemCallTable);
		oldZwQueryInformationPort = (ZwQueryInformationPortPtr)hookSSDTWithIndex(QUERY_INFORMATION_PORT, (BYTE*)newZwQueryInformationPort, (DWORD*)systemCallTable);
		oldZwImpersonateClientOfPort = (ZwImpersonateClientOfPortPtr)hookSSDTWithIndex(IMPERSONATE_CLIENT_OF_PORT, (BYTE*)newZwImpersonateClientOfPort, (DWORD*)systemCallTable);
		oldZwCreateProcess = (ZwCreateProcessPtr)hookSSDTWithIndex(CREATE_PROCESS, (BYTE*)newZwCreateProcess, (DWORD*)systemCallTable);
		oldZwCreateProcessEx = (ZwCreateProcessExPtr)hookSSDTWithIndex(CREATE_PROCESS_EX, (BYTE*)newZwCreateProcessEx, (DWORD*)systemCallTable);
		oldZwOpenProcess = (ZwOpenProcessPtr)hookSSDTWithIndex(OPEN_PROCESS, (BYTE*)newZwOpenProcess, (DWORD*)systemCallTable);
		oldZwTerminateProcess = (ZwTerminateProcessPtr)hookSSDTWithIndex(TERMINATE_PROCESS, (BYTE*)newZwTerminateProcess, (DWORD*)systemCallTable);
		oldZwCreateThread = (ZwCreateThreadPtr)hookSSDTWithIndex(CREATE_THREAD, (BYTE*)newZwCreateThread, (DWORD*)systemCallTable);
		oldZwOpenThread = (ZwOpenThreadPtr)hookSSDTWithIndex(OPEN_THREAD, (BYTE*)newZwOpenThread, (DWORD*)systemCallTable);
		oldZwTerminateThread = (ZwTerminateThreadPtr)hookSSDTWithIndex(TERMINATE_THREAD, (BYTE*)newZwTerminateThread, (DWORD*)systemCallTable);
		oldZwQueryInformationThread = (ZwQueryInformationThreadPtr)hookSSDTWithIndex(QUERY_INFORMATION_THREAD, (BYTE*)newZwQueryInformationThread, (DWORD*)systemCallTable);
		oldZwSetInformationThread = (ZwSetInformationThreadPtr)hookSSDTWithIndex(SET_INFORMATION_THREAD, (BYTE*)newZwSetInformationThread, (DWORD*)systemCallTable);
		oldZwSuspendThread = (ZwSuspendThreadPtr)hookSSDTWithIndex(SUSPEND_THREAD, (BYTE*)newZwSuspendThread, (DWORD*)systemCallTable);
		oldZwResumeThread = (ZwResumeThreadPtr)hookSSDTWithIndex(RESUME_THREAD, (BYTE*)newZwResumeThread, (DWORD*)systemCallTable);
		oldZwQueueApcThread = (ZwQueueApcThreadPtr)hookSSDTWithIndex(QUEUE_APC_THREAD, (BYTE*)newZwQueueApcThread, (DWORD*)systemCallTable);
		oldZwTestAlert = (ZwTestAlertPtr)hookSSDTWithIndex(TEST_ALERT, (BYTE*)newZwTestAlert, (DWORD*)systemCallTable);
		oldZwAlertThread = (ZwAlertThreadPtr)hookSSDTWithIndex(ALERT_THREAD, (BYTE*)newZwAlertThread, (DWORD*)systemCallTable);
		oldZwAlertResumeThread = (ZwAlertResumeThreadPtr)hookSSDTWithIndex(ALERT_RESUME_THREAD, (BYTE*)newZwAlertResumeThread, (DWORD*)systemCallTable);
		oldZwRegisterThreadTerminatePort = (ZwRegisterThreadTerminatePortPtr)hookSSDTWithIndex(REGISTER_THREAD_TERMINATE_PORT, (BYTE*)newZwRegisterThreadTerminatePort, (DWORD*)systemCallTable);
		oldZwImpersonateThread = (ZwImpersonateThreadPtr)hookSSDTWithIndex(IMPERSONATE_THREAD, (BYTE*)newZwImpersonateThread, (DWORD*)systemCallTable);
		oldZwImpersonateAnonymousToken = (ZwImpersonateAnonymousTokenPtr)hookSSDTWithIndex(IMPERSONATE_ANONYMOUS_TOKEN, (BYTE*)newZwImpersonateAnonymousToken, (DWORD*)systemCallTable);
		oldZwQuerySystemEnvironmentValue = (ZwQuerySystemEnvironmentValuePtr)hookSSDTWithIndex(QUERY_SYSTEM_ENVIRONMENT_VALUE, (BYTE*)newZwQuerySystemEnvironmentValue, (DWORD*)systemCallTable);
		oldZwQuerySystemEnvironmentValueEx = (ZwQuerySystemEnvironmentValueExPtr)hookSSDTWithIndex(QUERY_SYSTEM_ENVIRONMENT_VALUE_EX, (BYTE*)newZwQuerySystemEnvironmentValueEx, (DWORD*)systemCallTable);
		oldZwSetSystemEnvironmentValue = (ZwSetSystemEnvironmentValuePtr)hookSSDTWithIndex(SET_SYSTEM_ENVIRONMENT_VALUE, (BYTE*)newZwSetSystemEnvironmentValue, (DWORD*)systemCallTable);
		oldZwSetSystemEnvironmentValueEx = (ZwSetSystemEnvironmentValueExPtr)hookSSDTWithIndex(SET_SYSTEM_ENVIRONMENT_VALUE_EX, (BYTE*)newZwSetSystemEnvironmentValueEx, (DWORD*)systemCallTable);
		oldZwShutdownSystem = (ZwShutdownSystemPtr)hookSSDTWithIndex(SHUTDOWN_SYSTEM, (BYTE*)newZwShutdownSystem, (DWORD*)systemCallTable);
		oldZwSystemDebugControl = (ZwSystemDebugControlPtr)hookSSDTWithIndex(SYSTEM_DEBUG_CONTROL, (BYTE*)newZwSystemDebugControl, (DWORD*)systemCallTable);
		oldZwQueryObject = (ZwQueryObjectPtr)hookSSDTWithIndex(QUERY_OBJECT, (BYTE*)newZwQueryObject, (DWORD*)systemCallTable);
		oldZwSetInformationObject = (ZwSetInformationObjectPtr)hookSSDTWithIndex(SET_INFORMATION_OBJECT, (BYTE*)newZwSetInformationObject, (DWORD*)systemCallTable);
		oldZwDuplicateObject = (ZwDuplicateObjectPtr)hookSSDTWithIndex(DUPLICATE_OBJECT, (BYTE*)newZwDuplicateObject, (DWORD*)systemCallTable);
		oldZwMakeTemporaryObject = (ZwMakeTemporaryObjectPtr)hookSSDTWithIndex(MAKE_TEMPORARY_OBJECT, (BYTE*)newZwMakeTemporaryObject, (DWORD*)systemCallTable);
		oldZwSetSecurityObject = (ZwSetSecurityObjectPtr)hookSSDTWithIndex(SET_SECURITY_OBJECT, (BYTE*)newZwSetSecurityObject, (DWORD*)systemCallTable);
		oldZwCreateDirectoryObject = (ZwCreateDirectoryObjectPtr)hookSSDTWithIndex(CREATE_DIRECTORY_OBJECT, (BYTE*)newZwCreateDirectoryObject, (DWORD*)systemCallTable);
		oldZwOpenDirectoryObject = (ZwOpenDirectoryObjectPtr)hookSSDTWithIndex(OPEN_DIRECTORY_OBJECT, (BYTE*)newZwOpenDirectoryObject, (DWORD*)systemCallTable);
		oldZwQueryDirectoryObject = (ZwQueryDirectoryObjectPtr)hookSSDTWithIndex(QUERY_DIRECTORY_OBJECT, (BYTE*)newZwQueryDirectoryObject, (DWORD*)systemCallTable);
		oldZwCreateSymbolicLinkObject = (ZwCreateSymbolicLinkObjectPtr)hookSSDTWithIndex(CREATE_SYMBOLIC_LINK_OBJECT, (BYTE*)newZwCreateSymbolicLinkObject, (DWORD*)systemCallTable);
		oldZwOpenSymbolicLinkObject = (ZwOpenSymbolicLinkObjectPtr)hookSSDTWithIndex(OPEN_SYMBOLIC_LINK_OBJECT, (BYTE*)newZwOpenSymbolicLinkObject, (DWORD*)systemCallTable);
		oldZwQuerySymbolicLinkObject = (ZwQuerySymbolicLinkObjectPtr)hookSSDTWithIndex(QUERY_SYMBOLIC_LINK_OBJECT, (BYTE*)newZwQuerySymbolicLinkObject, (DWORD*)systemCallTable);
		oldZwCreateSection = (ZwCreateSectionPtr)hookSSDTWithIndex(CREATE_SECTION, (BYTE*)newZwCreateSection, (DWORD*)systemCallTable);
		oldZwQuerySection = (ZwQuerySectionPtr)hookSSDTWithIndex(QUERY_SECTION, (BYTE*)newZwQuerySection, (DWORD*)systemCallTable);
		oldZwExtendSection = (ZwExtendSectionPtr)hookSSDTWithIndex(EXTEND_SECTION, (BYTE*)newZwExtendSection, (DWORD*)systemCallTable);
		oldZwUnmapViewOfSection = (ZwUnmapViewOfSectionPtr)hookSSDTWithIndex(UNMAP_VIEW_OF_SECTION, (BYTE*)newZwUnmapViewOfSection, (DWORD*)systemCallTable);
		oldZwAreMappedFilesTheSame = (ZwAreMappedFilesTheSamePtr)hookSSDTWithIndex(ARE_MAPPED_FILES_THE_SAME, (BYTE*)newZwAreMappedFilesTheSame, (DWORD*)systemCallTable);
		oldZwCreateJobObject = (ZwCreateJobObjectPtr)hookSSDTWithIndex(CREATE_JOB_OBJECT, (BYTE*)newZwCreateJobObject, (DWORD*)systemCallTable);
		oldZwOpenJobObject = (ZwOpenJobObjectPtr)hookSSDTWithIndex(OPEN_JOB_OBJECT, (BYTE*)newZwOpenJobObject, (DWORD*)systemCallTable);
		oldZwTerminateJobObject = (ZwTerminateJobObjectPtr)hookSSDTWithIndex(TERMINATE_JOB_OBJECT, (BYTE*)newZwTerminateJobObject, (DWORD*)systemCallTable);
		oldZwAssignProcessToJobObject = (ZwAssignProcessToJobObjectPtr)hookSSDTWithIndex(ASSIGN_PROCESS_TO_JOB_OBJECT, (BYTE*)newZwAssignProcessToJobObject, (DWORD*)systemCallTable);
		oldZwQueryInformationJobObject = (ZwQueryInformationJobObjectPtr)hookSSDTWithIndex(QUERY_INFORMATION_JOB_OBJECT, (BYTE*)newZwQueryInformationJobObject, (DWORD*)systemCallTable);
		oldZwSetInformationJobObject = (ZwSetInformationJobObjectPtr)hookSSDTWithIndex(SET_INFORMATION_JOB_OBJECT, (BYTE*)newZwSetInformationJobObject, (DWORD*)systemCallTable);
		oldZwCreateToken = (ZwCreateTokenPtr)hookSSDTWithIndex(CREATE_TOKEN, (BYTE*)newZwCreateToken, (DWORD*)systemCallTable);
		oldZwOpenProcessToken = (ZwOpenProcessTokenPtr)hookSSDTWithIndex(OPEN_PROCESS_TOKEN, (BYTE*)newZwOpenProcessToken, (DWORD*)systemCallTable);
		oldZwOpenProcessTokenEx = (ZwOpenProcessTokenExPtr)hookSSDTWithIndex(OPEN_PROCESS_TOKEN_EX, (BYTE*)newZwOpenProcessTokenEx, (DWORD*)systemCallTable);
		oldZwDuplicateToken = (ZwDuplicateTokenPtr)hookSSDTWithIndex(DUPLICATE_TOKEN, (BYTE*)newZwDuplicateToken, (DWORD*)systemCallTable);
		oldZwFilterToken = (ZwFilterTokenPtr)hookSSDTWithIndex(FILTER_TOKEN, (BYTE*)newZwFilterToken, (DWORD*)systemCallTable);
		oldZwAdjustPrivilegesToken = (ZwAdjustPrivilegesTokenPtr)hookSSDTWithIndex(ADJUST_PRIVILEGES_TOKEN, (BYTE*)newZwAdjustPrivilegesToken, (DWORD*)systemCallTable);
		oldZwAdjustGroupsToken = (ZwAdjustGroupsTokenPtr)hookSSDTWithIndex(ADJUST_GROUPS_TOKEN, (BYTE*)newZwAdjustGroupsToken, (DWORD*)systemCallTable);
		oldZwSetInformationToken = (ZwSetInformationTokenPtr)hookSSDTWithIndex(SET_INFORMATION_TOKEN, (BYTE*)newZwSetInformationToken, (DWORD*)systemCallTable);
		oldZwSignalAndWaitForSingleObject = (ZwSignalAndWaitForSingleObjectPtr)hookSSDTWithIndex(SIGNAL_AND_WAIT_FOR_SINGLE_OBJECT, (BYTE*)newZwSignalAndWaitForSingleObject, (DWORD*)systemCallTable);
		oldZwWaitForMultipleObjects = (ZwWaitForMultipleObjectsPtr)hookSSDTWithIndex(WAIT_FOR_MULTIPLE_OBJECTS, (BYTE*)newZwWaitForMultipleObjects, (DWORD*)systemCallTable);
		oldZwCreateTimer = (ZwCreateTimerPtr)hookSSDTWithIndex(CREATE_TIMER, (BYTE*)newZwCreateTimer, (DWORD*)systemCallTable);
		oldZwOpenTimer = (ZwOpenTimerPtr)hookSSDTWithIndex(OPEN_TIMER, (BYTE*)newZwOpenTimer, (DWORD*)systemCallTable);
		oldZwCancelTimer = (ZwCancelTimerPtr)hookSSDTWithIndex(CANCEL_TIMER, (BYTE*)newZwCancelTimer, (DWORD*)systemCallTable);
		oldZwSetTimer = (ZwSetTimerPtr)hookSSDTWithIndex(SET_TIMER, (BYTE*)newZwSetTimer, (DWORD*)systemCallTable);
		oldZwQueryTimer = (ZwQueryTimerPtr)hookSSDTWithIndex(QUERY_TIMER, (BYTE*)newZwQueryTimer, (DWORD*)systemCallTable);
		oldZwCreateEvent = (ZwCreateEventPtr)hookSSDTWithIndex(CREATE_EVENT, (BYTE*)newZwCreateEvent, (DWORD*)systemCallTable);
		oldZwOpenEvent = (ZwOpenEventPtr)hookSSDTWithIndex(OPEN_EVENT, (BYTE*)newZwOpenEvent, (DWORD*)systemCallTable);
		oldZwPulseEvent = (ZwPulseEventPtr)hookSSDTWithIndex(PULSE_EVENT, (BYTE*)newZwPulseEvent, (DWORD*)systemCallTable);
		oldZwResetEvent = (ZwResetEventPtr)hookSSDTWithIndex(RESET_EVENT, (BYTE*)newZwResetEvent, (DWORD*)systemCallTable);
		oldZwClearEvent = (ZwClearEventPtr)hookSSDTWithIndex(CLEAR_EVENT, (BYTE*)newZwClearEvent, (DWORD*)systemCallTable);
		oldZwQueryEvent = (ZwQueryEventPtr)hookSSDTWithIndex(QUERY_EVENT, (BYTE*)newZwQueryEvent, (DWORD*)systemCallTable);
		oldZwCreateSemaphore = (ZwCreateSemaphorePtr)hookSSDTWithIndex(CREATE_SEMAPHORE, (BYTE*)newZwCreateSemaphore, (DWORD*)systemCallTable);
		oldZwOpenSemaphore = (ZwOpenSemaphorePtr)hookSSDTWithIndex(OPEN_SEMAPHORE, (BYTE*)newZwOpenSemaphore, (DWORD*)systemCallTable);
		oldZwReleaseSemaphore = (ZwReleaseSemaphorePtr)hookSSDTWithIndex(RELEASE_SEMAPHORE, (BYTE*)newZwReleaseSemaphore, (DWORD*)systemCallTable);
		oldZwQuerySemaphore = (ZwQuerySemaphorePtr)hookSSDTWithIndex(QUERY_SEMAPHORE, (BYTE*)newZwQuerySemaphore, (DWORD*)systemCallTable);
		oldZwCreateMutant = (ZwCreateMutantPtr)hookSSDTWithIndex(CREATE_MUTANT, (BYTE*)newZwCreateMutant, (DWORD*)systemCallTable);
		oldZwOpenMutant = (ZwOpenMutantPtr)hookSSDTWithIndex(OPEN_MUTANT, (BYTE*)newZwOpenMutant, (DWORD*)systemCallTable);
		oldZwReleaseMutant = (ZwReleaseMutantPtr)hookSSDTWithIndex(RELEASE_MUTANT, (BYTE*)newZwReleaseMutant, (DWORD*)systemCallTable);
		oldZwQueryMutant = (ZwQueryMutantPtr)hookSSDTWithIndex(QUERY_MUTANT, (BYTE*)newZwQueryMutant, (DWORD*)systemCallTable);
		oldZwCreateIoCompletion = (ZwCreateIoCompletionPtr)hookSSDTWithIndex(CREATE_IO_COMPLETION, (BYTE*)newZwCreateIoCompletion, (DWORD*)systemCallTable);
		oldZwOpenIoCompletion = (ZwOpenIoCompletionPtr)hookSSDTWithIndex(OPEN_IO_COMPLETION, (BYTE*)newZwOpenIoCompletion, (DWORD*)systemCallTable);
		oldZwSetIoCompletion = (ZwSetIoCompletionPtr)hookSSDTWithIndex(SET_IO_COMPLETION, (BYTE*)newZwSetIoCompletion, (DWORD*)systemCallTable);
		oldZwRemoveIoCompletion = (ZwRemoveIoCompletionPtr)hookSSDTWithIndex(REMOVE_IO_COMPLETION, (BYTE*)newZwRemoveIoCompletion, (DWORD*)systemCallTable);
		oldZwQueryIoCompletion = (ZwQueryIoCompletionPtr)hookSSDTWithIndex(QUERY_IO_COMPLETION, (BYTE*)newZwQueryIoCompletion, (DWORD*)systemCallTable);
		oldZwCreateEventPair = (ZwCreateEventPairPtr)hookSSDTWithIndex(CREATE_EVENT_PAIR, (BYTE*)newZwCreateEventPair, (DWORD*)systemCallTable);
		oldZwOpenEventPair = (ZwOpenEventPairPtr)hookSSDTWithIndex(OPEN_EVENT_PAIR, (BYTE*)newZwOpenEventPair, (DWORD*)systemCallTable);
		oldZwWaitLowEventPair = (ZwWaitLowEventPairPtr)hookSSDTWithIndex(WAIT_LOW_EVENT_PAIR, (BYTE*)newZwWaitLowEventPair, (DWORD*)systemCallTable);
		oldZwWaitHighEventPair = (ZwWaitHighEventPairPtr)hookSSDTWithIndex(WAIT_HIGH_EVENT_PAIR, (BYTE*)newZwWaitHighEventPair, (DWORD*)systemCallTable);
		oldZwSetLowWaitHighEventPair = (ZwSetLowWaitHighEventPairPtr)hookSSDTWithIndex(SET_LOW_WAIT_HIGH_EVENT_PAIR, (BYTE*)newZwSetLowWaitHighEventPair, (DWORD*)systemCallTable);
		oldZwSetHighWaitLowEventPair = (ZwSetHighWaitLowEventPairPtr)hookSSDTWithIndex(SET_HIGH_WAIT_LOW_EVENT_PAIR, (BYTE*)newZwSetHighWaitLowEventPair, (DWORD*)systemCallTable);
		oldZwSetLowEventPair = (ZwSetLowEventPairPtr)hookSSDTWithIndex(SET_LOW_EVENT_PAIR, (BYTE*)newZwSetLowEventPair, (DWORD*)systemCallTable);
		oldZwSetHighEventPair = (ZwSetHighEventPairPtr)hookSSDTWithIndex(SET_HIGH_EVENT_PAIR, (BYTE*)newZwSetHighEventPair, (DWORD*)systemCallTable);
		oldZwSetSystemTime = (ZwSetSystemTimePtr)hookSSDTWithIndex(SET_SYSTEM_TIME, (BYTE*)newZwSetSystemTime, (DWORD*)systemCallTable);
		oldZwQueryPerformanceCounter = (ZwQueryPerformanceCounterPtr)hookSSDTWithIndex(QUERY_PERFORMANCE_COUNTER, (BYTE*)newZwQueryPerformanceCounter, (DWORD*)systemCallTable);
		oldZwSetTimerResolution = (ZwSetTimerResolutionPtr)hookSSDTWithIndex(SET_TIMER_RESOLUTION, (BYTE*)newZwSetTimerResolution, (DWORD*)systemCallTable);
		oldZwQueryTimerResolution = (ZwQueryTimerResolutionPtr)hookSSDTWithIndex(QUERY_TIMER_RESOLUTION, (BYTE*)newZwQueryTimerResolution, (DWORD*)systemCallTable);
		oldZwYieldExecution = (ZwYieldExecutionPtr)hookSSDTWithIndex(YIELD_EXECUTION, (BYTE*)newZwYieldExecution, (DWORD*)systemCallTable);
		oldZwSetIntervalProfile = (ZwSetIntervalProfilePtr)hookSSDTWithIndex(SET_INTERVAL_PROFILE, (BYTE*)newZwSetIntervalProfile, (DWORD*)systemCallTable);
		oldZwQueryIntervalProfile = (ZwQueryIntervalProfilePtr)hookSSDTWithIndex(QUERY_INTERVAL_PROFILE, (BYTE*)newZwQueryIntervalProfile, (DWORD*)systemCallTable);
		oldZwStopProfile = (ZwStopProfilePtr)hookSSDTWithIndex(STOP_PROFILE, (BYTE*)newZwStopProfile, (DWORD*)systemCallTable);
		oldZwPrivilegeCheck = (ZwPrivilegeCheckPtr)hookSSDTWithIndex(PRIVILEGE_CHECK, (BYTE*)newZwPrivilegeCheck, (DWORD*)systemCallTable);
		oldZwPrivilegeObjectAuditAlarm = (ZwPrivilegeObjectAuditAlarmPtr)hookSSDTWithIndex(PRIVILEGE_OBJECT_AUDIT_ALARM, (BYTE*)newZwPrivilegeObjectAuditAlarm, (DWORD*)systemCallTable);
		oldZwPrivilegedServiceAuditAlarm = (ZwPrivilegedServiceAuditAlarmPtr)hookSSDTWithIndex(PRIVILEGED_SERVICE_AUDIT_ALARM, (BYTE*)newZwPrivilegedServiceAuditAlarm, (DWORD*)systemCallTable);
		oldZwAccessCheckByType = (ZwAccessCheckByTypePtr)hookSSDTWithIndex(ACCESS_CHECK_BY_TYPE, (BYTE*)newZwAccessCheckByType, (DWORD*)systemCallTable);
		oldZwAccessCheckByTypeAndAuditAlarm = (ZwAccessCheckByTypeAndAuditAlarmPtr)hookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_AND_AUDIT_ALARM, (BYTE*)newZwAccessCheckByTypeAndAuditAlarm, (DWORD*)systemCallTable);
		oldZwAccessCheckByTypeResultList = (ZwAccessCheckByTypeResultListPtr)hookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST, (BYTE*)newZwAccessCheckByTypeResultList, (DWORD*)systemCallTable);
		oldZwAccessCheckByTypeResultListAndAuditAlarm = (ZwAccessCheckByTypeResultListAndAuditAlarmPtr)hookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST_AND_AUDIT_ALARM, (BYTE*)newZwAccessCheckByTypeResultListAndAuditAlarm, (DWORD*)systemCallTable);
		oldZwAccessCheckByTypeResultListAndAuditAlarmByHandle = (ZwAccessCheckByTypeResultListAndAuditAlarmByHandlePtr)hookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST_AND_AUDIT_ALARM_BY_HANDLE, (BYTE*)newZwAccessCheckByTypeResultListAndAuditAlarmByHandle, (DWORD*)systemCallTable);
		oldZwOpenObjectAuditAlarm = (ZwOpenObjectAuditAlarmPtr)hookSSDTWithIndex(OPEN_OBJECT_AUDIT_ALARM, (BYTE*)newZwOpenObjectAuditAlarm, (DWORD*)systemCallTable);
		oldZwCloseObjectAuditAlarm = (ZwCloseObjectAuditAlarmPtr)hookSSDTWithIndex(CLOSE_OBJECT_AUDIT_ALARM, (BYTE*)newZwCloseObjectAuditAlarm, (DWORD*)systemCallTable);
		oldZwDeleteObjectAuditAlarm = (ZwDeleteObjectAuditAlarmPtr)hookSSDTWithIndex(DELETE_OBJECT_AUDIT_ALARM, (BYTE*)newZwDeleteObjectAuditAlarm, (DWORD*)systemCallTable);
		oldZwRequestWakeupLatency = (ZwRequestWakeupLatencyPtr)hookSSDTWithIndex(REQUEST_WAKEUP_LATENCY, (BYTE*)newZwRequestWakeupLatency, (DWORD*)systemCallTable);
		oldZwRequestDeviceWakeup = (ZwRequestDeviceWakeupPtr)hookSSDTWithIndex(REQUEST_DEVICE_WAKEUP, (BYTE*)newZwRequestDeviceWakeup, (DWORD*)systemCallTable);
		oldZwCancelDeviceWakeupRequest = (ZwCancelDeviceWakeupRequestPtr)hookSSDTWithIndex(CANCEL_DEVICE_WAKEUP_REQUEST, (BYTE*)newZwCancelDeviceWakeupRequest, (DWORD*)systemCallTable);
		oldZwIsSystemResumeAutomatic = (ZwIsSystemResumeAutomaticPtr)hookSSDTWithIndex(IS_SYSTEM_RESUME_AUTOMATIC, (BYTE*)newZwIsSystemResumeAutomatic, (DWORD*)systemCallTable);
		oldZwSetThreadExecutionState = (ZwSetThreadExecutionStatePtr)hookSSDTWithIndex(SET_THREAD_EXECUTION_STATE, (BYTE*)newZwSetThreadExecutionState, (DWORD*)systemCallTable);
		oldZwGetDevicePowerState = (ZwGetDevicePowerStatePtr)hookSSDTWithIndex(GET_DEVICE_POWER_STATE, (BYTE*)newZwGetDevicePowerState, (DWORD*)systemCallTable);
		oldZwSetSystemPowerState = (ZwSetSystemPowerStatePtr)hookSSDTWithIndex(SET_SYSTEM_POWER_STATE, (BYTE*)newZwSetSystemPowerState, (DWORD*)systemCallTable);
		oldZwInitiatePowerAction = (ZwInitiatePowerActionPtr)hookSSDTWithIndex(INITIATE_POWER_ACTION, (BYTE*)newZwInitiatePowerAction, (DWORD*)systemCallTable);
		oldZwPowerInformation = (ZwPowerInformationPtr)hookSSDTWithIndex(POWER_INFORMATION, (BYTE*)newZwPowerInformation, (DWORD*)systemCallTable);
		oldZwRaiseException = (ZwRaiseExceptionPtr)hookSSDTWithIndex(RAISE_EXCEPTION, (BYTE*)newZwRaiseException, (DWORD*)systemCallTable);
		//oldZwContinue = (ZwContinuePtr)hookSSDTWithIndex(CONTINUE, (BYTE*)newZwContinue, (DWORD*)systemCallTable);
		oldZwCallbackReturn = (ZwCallbackReturnPtr)hookSSDTWithIndex(CALLBACK_RETURN, (BYTE*)newZwCallbackReturn, (DWORD*)systemCallTable);
		oldZwLoadDriver = (ZwLoadDriverPtr)hookSSDTWithIndex(LOAD_DRIVER, (BYTE*)newZwLoadDriver, (DWORD*)systemCallTable);
		oldZwUnloadDriver = (ZwUnloadDriverPtr)hookSSDTWithIndex(UNLOAD_DRIVER, (BYTE*)newZwUnloadDriver, (DWORD*)systemCallTable);
		oldZwFlushWriteBuffer = (ZwFlushWriteBufferPtr)hookSSDTWithIndex(FLUSH_WRITE_BUFFER, (BYTE*)newZwFlushWriteBuffer, (DWORD*)systemCallTable);
		oldZwSetDefaultLocale = (ZwSetDefaultLocalePtr)hookSSDTWithIndex(SET_DEFAULT_LOCALE, (BYTE*)newZwSetDefaultLocale, (DWORD*)systemCallTable);
		oldZwQueryDefaultUILanguage = (ZwQueryDefaultUILanguagePtr)hookSSDTWithIndex(QUERY_DEFAULT_UI_LANGUAGE, (BYTE*)newZwQueryDefaultUILanguage, (DWORD*)systemCallTable);
		oldZwSetDefaultUILanguage = (ZwSetDefaultUILanguagePtr)hookSSDTWithIndex(SET_DEFAULT_UI_LANGUAGE, (BYTE*)newZwSetDefaultUILanguage, (DWORD*)systemCallTable);
		oldZwQueryInstallUILanguage = (ZwQueryInstallUILanguagePtr)hookSSDTWithIndex(QUERY_INSTALL_UI_LANGUAGE, (BYTE*)newZwQueryInstallUILanguage, (DWORD*)systemCallTable);
		oldZwAllocateLocallyUniqueId = (ZwAllocateLocallyUniqueIdPtr)hookSSDTWithIndex(ALLOCATE_LOCALLY_UNIQUE_ID, (BYTE*)newZwAllocateLocallyUniqueId, (DWORD*)systemCallTable);
		oldZwAllocateUuids = (ZwAllocateUuidsPtr)hookSSDTWithIndex(ALLOCATE_UUIDS, (BYTE*)newZwAllocateUuids, (DWORD*)systemCallTable);
		oldZwSetUuidSeed = (ZwSetUuidSeedPtr)hookSSDTWithIndex(SET_UUID_SEED, (BYTE*)newZwSetUuidSeed, (DWORD*)systemCallTable);
		oldZwRaiseHardError = (ZwRaiseHardErrorPtr)hookSSDTWithIndex(RAISE_HARD_ERROR, (BYTE*)newZwRaiseHardError, (DWORD*)systemCallTable);
		oldZwSetDefaultHardErrorPort = (ZwSetDefaultHardErrorPortPtr)hookSSDTWithIndex(SET_DEFAULT_HARD_ERROR_PORT, (BYTE*)newZwSetDefaultHardErrorPort, (DWORD*)systemCallTable);
		oldZwDisplayString = (ZwDisplayStringPtr)hookSSDTWithIndex(DISPLAY_STRING, (BYTE*)newZwDisplayString, (DWORD*)systemCallTable);
		oldZwCreatePagingFile = (ZwCreatePagingFilePtr)hookSSDTWithIndex(CREATE_PAGING_FILE, (BYTE*)newZwCreatePagingFile, (DWORD*)systemCallTable);
		oldZwAddAtom = (ZwAddAtomPtr)hookSSDTWithIndex(ADD_ATOM, (BYTE*)newZwAddAtom, (DWORD*)systemCallTable);
		oldZwFindAtom = (ZwFindAtomPtr)hookSSDTWithIndex(FIND_ATOM, (BYTE*)newZwFindAtom, (DWORD*)systemCallTable);
		oldZwDeleteAtom = (ZwDeleteAtomPtr)hookSSDTWithIndex(DELETE_ATOM, (BYTE*)newZwDeleteAtom, (DWORD*)systemCallTable);
		oldZwQueryInformationAtom = (ZwQueryInformationAtomPtr)hookSSDTWithIndex(QUERY_INFORMATION_ATOM, (BYTE*)newZwQueryInformationAtom, (DWORD*)systemCallTable);
		oldZwSetLdtEntries = (ZwSetLdtEntriesPtr)hookSSDTWithIndex(SET_LDT_ENTRIES, (BYTE*)newZwSetLdtEntries, (DWORD*)systemCallTable);
		oldZwVdmControl = (ZwVdmControlPtr)hookSSDTWithIndex(VDM_CONTROL, (BYTE*)newZwVdmControl, (DWORD*)systemCallTable);
		oldNtSetBootEntryOrder = (NtSetBootEntryOrderPtr)hookSSDTWithIndex(SET_BOOT_ENTRY_ORDER, (BYTE*)newNtSetBootEntryOrder, (DWORD*)systemCallTable);
		oldNtCompactKeys = (NtCompactKeysPtr)hookSSDTWithIndex(COMPACT_KEYS, (BYTE*)newNtCompactKeys, (DWORD*)systemCallTable);
		oldNtCompareTokens = (NtCompareTokensPtr)hookSSDTWithIndex(COMPARE_TOKENS, (BYTE*)newNtCompareTokens, (DWORD*)systemCallTable);
		oldNtCompressKey = (NtCompressKeyPtr)hookSSDTWithIndex(COMPRESS_KEY, (BYTE*)newNtCompressKey, (DWORD*)systemCallTable);
		oldNtCreateDebugObject = (NtCreateDebugObjectPtr)hookSSDTWithIndex(CREATE_DEBUG_OBJECT, (BYTE*)newNtCreateDebugObject, (DWORD*)systemCallTable);
		oldNtCreateJobSet = (NtCreateJobSetPtr)hookSSDTWithIndex(CREATE_JOB_SET, (BYTE*)newNtCreateJobSet, (DWORD*)systemCallTable);
		oldNtDebugActiveProcess = (NtDebugActiveProcessPtr)hookSSDTWithIndex(DEBUG_ACTIVE_PROCESS, (BYTE*)newNtDebugActiveProcess, (DWORD*)systemCallTable);
		oldNtDebugContinue = (NtDebugContinuePtr)hookSSDTWithIndex(DEBUG_CONTINUE, (BYTE*)newNtDebugContinue, (DWORD*)systemCallTable);
		oldNtEnumerateSystemEnvironmentValuesEx = (NtEnumerateSystemEnvironmentValuesExPtr)hookSSDTWithIndex(ENUMERATE_SYSTEM_ENVIRONMENT_VALUES_EX, (BYTE*)newNtEnumerateSystemEnvironmentValuesEx, (DWORD*)systemCallTable);
		oldNtIsProcessInJob = (NtIsProcessInJobPtr)hookSSDTWithIndex(IS_PROCESS_IN_JOB, (BYTE*)newNtIsProcessInJob, (DWORD*)systemCallTable);
		oldNtLockProductActivationKeys = (NtLockProductActivationKeysPtr)hookSSDTWithIndex(LOCK_PRODUCT_ACTIVATION_KEYS, (BYTE*)newNtLockProductActivationKeys, (DWORD*)systemCallTable);
		oldNtLockRegistryKey = (NtLockRegistryKeyPtr)hookSSDTWithIndex(LOCK_REGISTRY_KEY, (BYTE*)newNtLockRegistryKey, (DWORD*)systemCallTable);
		oldNtMakePermanentObject = (NtMakePermanentObjectPtr)hookSSDTWithIndex(MAKE_PERMANENT_OBJECT, (BYTE*)newNtMakePermanentObject, (DWORD*)systemCallTable);
		oldNtDeleteBootEntry = (NtDeleteBootEntryPtr)hookSSDTWithIndex(DELETE_BOOT_ENTRY, (BYTE*)newNtDeleteBootEntry, (DWORD*)systemCallTable);
		oldNtQueryDebugFilterState = (NtQueryDebugFilterStatePtr)hookSSDTWithIndex(QUERY_DEBUG_FILTER_STATE, (BYTE*)newNtQueryDebugFilterState, (DWORD*)systemCallTable);
		oldNtRemoveProcessDebug = (NtRemoveProcessDebugPtr)hookSSDTWithIndex(REMOVE_PROCESS_DEBUG, (BYTE*)newNtRemoveProcessDebug, (DWORD*)systemCallTable);
		oldNtRenameKey = (NtRenameKeyPtr)hookSSDTWithIndex(RENAME_KEY, (BYTE*)newNtRenameKey, (DWORD*)systemCallTable);
		oldNtResumeProcess = (NtResumeProcessPtr)hookSSDTWithIndex(RESUME_PROCESS, (BYTE*)newNtResumeProcess, (DWORD*)systemCallTable);
		oldNtSetDebugFilterState = (NtSetDebugFilterStatePtr)hookSSDTWithIndex(SET_DEBUG_FILTER_STATE, (BYTE*)newNtSetDebugFilterState, (DWORD*)systemCallTable);
		oldNtSetEventBoostPriority = (NtSetEventBoostPriorityPtr)hookSSDTWithIndex(SET_EVENT_BOOST_PRIORITY, (BYTE*)newNtSetEventBoostPriority, (DWORD*)systemCallTable);
		oldNtSetInformationDebugObject = (NtSetInformationDebugObjectPtr)hookSSDTWithIndex(SET_INFORMATION_DEBUG_OBJECT, (BYTE*)newNtSetInformationDebugObject, (DWORD*)systemCallTable);
		oldNtSuspendProcess = (NtSuspendProcessPtr)hookSSDTWithIndex(SUSPEND_PROCESS, (BYTE*)newNtSuspendProcess, (DWORD*)systemCallTable);
		oldNtTraceEvent = (NtTraceEventPtr)hookSSDTWithIndex(TRACE_EVENT, (BYTE*)newNtTraceEvent, (DWORD*)systemCallTable);
		oldNtTranslateFilePath = (NtTranslateFilePathPtr)hookSSDTWithIndex(TRANSLATE_FILE_PATH, (BYTE*)newNtTranslateFilePath, (DWORD*)systemCallTable);
		oldNtWaitForDebugEvent = (NtWaitForDebugEventPtr)hookSSDTWithIndex(WAIT_FOR_DEBUG_EVENT, (BYTE*)newNtWaitForDebugEvent, (DWORD*)systemCallTable);
		oldNtCreateKeyedEvent = (NtCreateKeyedEventPtr)hookSSDTWithIndex(CREATE_KEYED_EVENT, (BYTE*)newNtCreateKeyedEvent, (DWORD*)systemCallTable);
		oldNtOpenKeyedEvent = (NtOpenKeyedEventPtr)hookSSDTWithIndex(OPEN_KEYED_EVENT, (BYTE*)newNtOpenKeyedEvent, (DWORD*)systemCallTable);
		oldNtReleaseKeyedEvent = (NtReleaseKeyedEventPtr)hookSSDTWithIndex(RELEASE_KEYED_EVENT, (BYTE*)newNtReleaseKeyedEvent, (DWORD*)systemCallTable);
		oldNtWaitForKeyedEvent = (NtWaitForKeyedEventPtr)hookSSDTWithIndex(WAIT_FOR_KEYED_EVENT, (BYTE*)newNtWaitForKeyedEvent, (DWORD*)systemCallTable);
		oldNtQueryPortInformationProcess = (NtQueryPortInformationProcessPtr)hookSSDTWithIndex(QUERY_PORT_INFORMATION_PROCESS, (BYTE*)newNtQueryPortInformationProcess, (DWORD*)systemCallTable);
		//HOOK_HERE
	
		//oldZwAcceptConnectPort = (ZwAcceptConnectPortPtr)hookSSDT((BYTE*)ZwAcceptConnectPort, (BYTE*)newZwAcceptConnectPort, (DWORD*)systemCallTable);
		
		//FUNCTIONS THAT ARE USED LATER, KEEP AN EYE ON THEM
		//RtlInitUnicodeString(&function, L"ZwQueryInformationThread");
		//ZwQueryInformationThread = MmGetSystemRoutineAddress(&function);
		RtlInitUnicodeString(&function, L"ZwQueryInformationProcess");
		ZwQueryInformationProcess = MmGetSystemRoutineAddress(&function);
		
		//RtlInitUnicodeString(&buddyName, L"\\Device\\FileWriterDriver");
		//IoGetDeviceObjectPointer(&buddyName, GENERIC_ALL, &fObject, &buddyDevice);
		
		//RtlInitUnicodeString(&function, L"PsLookupProcessByProcessId");
		//PsLookupProcessByProcessId = MmGetSystemRoutineAddress(&function);
		
		EnableWP();
		
		//DbgPrint("Past first HookSSDT");
	}

    return NtStatus;
}


 /*
  * MyDriver_Unload: called when the driver is unloaded.
  */
VOID MyDriver_Unload(PDRIVER_OBJECT  DriverObject) {
	/* local variables */
	LARGE_INTEGER   interval;
	UNICODE_STRING usDosDeviceName;
	interval.QuadPart = (5 * DELAY_ONE_SECOND);
	DisableWP();
	
	/* restore the hook 
	if(oldZwQuerySystemInformation != NULL) {
		oldZwQuerySystemInformation = (ZwQuerySystemInformationPrototype)HookSSDT((PULONG)ZwQuerySystemInformation, (PULONG)oldZwQuerySystemInformation);
		EnableWP();
		DbgPrint("The original SSDT function restored.\r\n");
	}
	*/
	
	
	//unHookSSDT((BYTE*)ZwSetValueKey, (BYTE*)oldZwSetValueKey, (DWORD*)systemCallTable);
	unHookSSDT((BYTE*)ZwQuerySystemInformation, (BYTE*)oldZwQuerySystemInformation, (DWORD*)systemCallTable);
	//unHookSSDT((BYTE*)ZwOpenProcess, (BYTE*)oldZwOpenProcess, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(WRITE_VIRUTAL_MEMORY_INDEX, (BYTE*)oldZwWriteVirtualMemory, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(DEBUG_ACTIVE_PROCESS_INDEX, (BYTE*)oldZwDebugActiveProcess, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_SECTION_INDEX, (BYTE*)oldZwCreateSection, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_PROCESS_INDEX, (BYTE*)oldZwCreateProcess, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_PROCESS_EX_INDEX, (BYTE*)oldZwCreateProcessEx, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_THREAD_INDEX, (BYTE*)oldZwCreateThread, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_THREAD_EX_INDEX, (BYTE*)oldZwCreateThreadEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(MAP_VIEW_OF_SECTION_INDEX, (BYTE*)oldZwMapViewOfSection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_CONTEXT_THREAD_INDEX, (BYTE*)oldZwSetContextThread, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(SYSTEM_DEBUG_CONTROL_INDEX, (BYTE*)oldZwSystemDebugControl, (DWORD*)systemCallTable);
	//unHookSSDT((BYTE*)ZwOpenFile, (BYTE*)oldZwOpenFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_FILE_INDEX, (BYTE*)oldZwCreateFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(READ_FILE_INDEX, (BYTE*)oldZwReadFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(DELETE_FILE_INDEX, (BYTE*)oldZwDeleteFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(SET_INFORMATION_FILE_INDEX, (BYTE*)oldZwSetInformationFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CREATE_MUTANT_INDEX, (BYTE*)oldZwCreateMutant, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DEVICE_IO_CONTROL_FILE_INDEX, (BYTE*)oldZwDeviceIoControlFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(TERMINATE_PROCESS_INDEX, (BYTE*)oldZwTerminateProcess, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(LOAD_DRIVER_INDEX, (BYTE*)oldZwLoadDriver, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELAY_EXECUTION_INDEX, (BYTE*)oldZwDelayExecution, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(QUERY_VALUE_KEY_INDEX, (BYTE*)oldZwQueryValueKey, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(QUERY_ATTRIBUTES_FILE_INDEX, (BYTE*)oldZwQueryAttributesFile, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(ACCEPT_CONNECT_PORT, (BYTE*)oldZwAcceptConnectPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_FOR_SINGLE_OBJECT, (BYTE*)oldZwWaitForSingleObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REPLY_WAIT_RECEIVE_PORT, (BYTE*)oldZwReplyWaitReceivePort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REQUEST_WAIT_REPLY_PORT, (BYTE*)oldZwRequestWaitReplyPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CLOSE, (BYTE*)oldZwClose, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_EVENT, (BYTE*)oldZwSetEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_THREAD_TOKEN, (BYTE*)oldZwOpenThreadToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_THREAD_TOKEN_EX, (BYTE*)oldZwOpenThreadTokenEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_KEY, (BYTE*)oldZwOpenKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALLOCATE_VIRTUAL_MEMORY, (BYTE*)oldZwAllocateVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PROTECT_VIRTUAL_MEMORY, (BYTE*)oldZwProtectVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_TOKEN, (BYTE*)oldZwQueryInformationToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ENUMERATE_KEY, (BYTE*)oldZwEnumerateKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FLUSH_INSTRUCTION_CACHE, (BYTE*)oldZwFlushInstructionCache, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SECURITY_OBJECT, (BYTE*)oldZwQuerySecurityObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_DEFAULT_LOCALE, (BYTE*)oldZwQueryDefaultLocale, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SYSTEM_TIME, (BYTE*)oldZwQuerySystemTime, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_SECTION, (BYTE*)oldZwOpenSection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_PROCESS, (BYTE*)oldZwSetInformationProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_PROCESS, (BYTE*)oldZwQueryInformationProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(GET_CONTEXT_THREAD, (BYTE*)oldZwGetContextThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_PROFILE, (BYTE*)oldZwCreateProfile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(START_PROFILE, (BYTE*)oldZwStartProfile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK, (BYTE*)oldZwAccessCheck, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_AND_AUDIT_ALARM, (BYTE*)oldZwAccessCheckAndAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SYSTEM_INFORMATION, (BYTE*)oldZwSetSystemInformation, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(GET_PLUG_PLAY_EVENT, (BYTE*)oldZwGetPlugPlayEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PLUG_PLAY_CONTROL, (BYTE*)oldZwPlugPlayControl, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOCK_VIRTUAL_MEMORY, (BYTE*)oldZwLockVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNLOCK_VIRTUAL_MEMORY, (BYTE*)oldZwUnlockVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FLUSH_VIRTUAL_MEMORY, (BYTE*)oldZwFlushVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALLOCATE_USER_PHYSICAL_PAGES, (BYTE*)oldZwAllocateUserPhysicalPages, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FREE_USER_PHYSICAL_PAGES, (BYTE*)oldZwFreeUserPhysicalPages, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(MAP_USER_PHYSICAL_PAGES, (BYTE*)oldZwMapUserPhysicalPages, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(MAP_USER_PHYSICAL_PAGES_SCATTER, (BYTE*)oldZwMapUserPhysicalPagesScatter, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(GET_WRITE_WATCH, (BYTE*)oldZwGetWriteWatch, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RESET_WRITE_WATCH, (BYTE*)oldZwResetWriteWatch, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FREE_VIRTUAL_MEMORY, (BYTE*)oldZwFreeVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_VIRTUAL_MEMORY, (BYTE*)oldZwQueryVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(READ_VIRTUAL_MEMORY, (BYTE*)oldZwReadVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WRITE_VIRTUAL_MEMORY, (BYTE*)oldZwWriteVirtualMemory, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_FILE, (BYTE*)oldZwCreateFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_FILE, (BYTE*)oldZwOpenFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_FILE, (BYTE*)oldZwDeleteFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FLUSH_BUFFERS_FILE, (BYTE*)oldZwFlushBuffersFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CANCEL_IO_FILE, (BYTE*)oldZwCancelIoFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WRITE_FILE, (BYTE*)oldZwWriteFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(READ_FILE_SCATTER, (BYTE*)oldZwReadFileScatter, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WRITE_FILE_GATHER, (BYTE*)oldZwWriteFileGather, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOCK_FILE, (BYTE*)oldZwLockFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNLOCK_FILE, (BYTE*)oldZwUnlockFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FS_CONTROL_FILE, (BYTE*)oldZwFsControlFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(NOTIFY_CHANGE_DIRECTORY_FILE, (BYTE*)oldZwNotifyChangeDirectoryFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_EA_FILE, (BYTE*)oldZwQueryEaFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_EA_FILE, (BYTE*)oldZwSetEaFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_NAMED_PIPE_FILE, (BYTE*)oldZwCreateNamedPipeFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_MAILSLOT_FILE, (BYTE*)oldZwCreateMailslotFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_VOLUME_INFORMATION_FILE, (BYTE*)oldZwQueryVolumeInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_VOLUME_INFORMATION_FILE, (BYTE*)oldZwSetVolumeInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_QUOTA_INFORMATION_FILE, (BYTE*)oldZwQueryQuotaInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_QUOTA_INFORMATION_FILE, (BYTE*)oldZwSetQuotaInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_ATTRIBUTES_FILE, (BYTE*)oldZwQueryAttributesFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_FULL_ATTRIBUTES_FILE, (BYTE*)oldZwQueryFullAttributesFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_FILE, (BYTE*)oldZwQueryInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_FILE, (BYTE*)oldZwSetInformationFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_DIRECTORY_FILE, (BYTE*)oldZwQueryDirectoryFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_KEY, (BYTE*)oldZwCreateKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_KEY, (BYTE*)oldZwDeleteKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FLUSH_KEY, (BYTE*)oldZwFlushKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SAVE_KEY, (BYTE*)oldZwSaveKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SAVE_KEY_EX, (BYTE*)oldZwSaveKeyEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SAVE_MERGED_KEYS, (BYTE*)oldZwSaveMergedKeys, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RESTORE_KEY, (BYTE*)oldZwRestoreKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOAD_KEY, (BYTE*)oldZwLoadKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOAD_KEY2, (BYTE*)oldZwLoadKey2, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNLOAD_KEY, (BYTE*)oldZwUnloadKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNLOAD_KEY_EX, (BYTE*)oldZwUnloadKeyEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_OPEN_SUBKEYS, (BYTE*)oldZwQueryOpenSubKeys, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REPLACE_KEY, (BYTE*)oldZwReplaceKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_KEY, (BYTE*)oldZwSetInformationKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_KEY, (BYTE*)oldZwQueryKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(NOTIFY_CHANGE_KEY, (BYTE*)oldZwNotifyChangeKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(NOTIFY_CHANGE_MULTIPLE_KEYS, (BYTE*)oldZwNotifyChangeMultipleKeys, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_VALUE_KEY, (BYTE*)oldZwDeleteValueKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_VALUE_KEY, (BYTE*)oldZwSetValueKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_VALUE_KEY, (BYTE*)oldZwQueryValueKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ENUMERATE_VALUE_KEY, (BYTE*)oldZwEnumerateValueKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_MULTIPLE_VALUE_KEY, (BYTE*)oldZwQueryMultipleValueKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(INITIALIZE_REGISTRY, (BYTE*)oldZwInitializeRegistry, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_PORT, (BYTE*)oldZwCreatePort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_WAITABLE_PORT, (BYTE*)oldZwCreateWaitablePort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CONNECT_PORT, (BYTE*)oldZwConnectPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SECURE_CONNECT_PORT, (BYTE*)oldZwSecureConnectPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LISTEN_PORT, (BYTE*)oldZwListenPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCEPT_CONNECT_PORT, (BYTE*)oldZwAcceptConnectPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(COMPLETE_CONNECT_PORT, (BYTE*)oldZwCompleteConnectPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REQUEST_PORT, (BYTE*)oldZwRequestPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REPLY_PORT, (BYTE*)oldZwReplyPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REPLY_WAIT_REPLY_PORT, (BYTE*)oldZwReplyWaitReplyPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REPLY_WAIT_RECEIVE_PORT_EX, (BYTE*)oldZwReplyWaitReceivePortEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(READ_REQUEST_DATA, (BYTE*)oldZwReadRequestData, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WRITE_REQUEST_DATA, (BYTE*)oldZwWriteRequestData, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_PORT, (BYTE*)oldZwQueryInformationPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(IMPERSONATE_CLIENT_OF_PORT, (BYTE*)oldZwImpersonateClientOfPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_PROCESS, (BYTE*)oldZwCreateProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_PROCESS_EX, (BYTE*)oldZwCreateProcessEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_PROCESS, (BYTE*)oldZwOpenProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TERMINATE_PROCESS, (BYTE*)oldZwTerminateProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_THREAD, (BYTE*)oldZwCreateThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_THREAD, (BYTE*)oldZwOpenThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TERMINATE_THREAD, (BYTE*)oldZwTerminateThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_THREAD, (BYTE*)oldZwQueryInformationThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_THREAD, (BYTE*)oldZwSetInformationThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SUSPEND_THREAD, (BYTE*)oldZwSuspendThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RESUME_THREAD, (BYTE*)oldZwResumeThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUEUE_APC_THREAD, (BYTE*)oldZwQueueApcThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TEST_ALERT, (BYTE*)oldZwTestAlert, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALERT_THREAD, (BYTE*)oldZwAlertThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALERT_RESUME_THREAD, (BYTE*)oldZwAlertResumeThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REGISTER_THREAD_TERMINATE_PORT, (BYTE*)oldZwRegisterThreadTerminatePort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(IMPERSONATE_THREAD, (BYTE*)oldZwImpersonateThread, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(IMPERSONATE_ANONYMOUS_TOKEN, (BYTE*)oldZwImpersonateAnonymousToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SYSTEM_ENVIRONMENT_VALUE, (BYTE*)oldZwQuerySystemEnvironmentValue, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SYSTEM_ENVIRONMENT_VALUE_EX, (BYTE*)oldZwQuerySystemEnvironmentValueEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SYSTEM_ENVIRONMENT_VALUE, (BYTE*)oldZwSetSystemEnvironmentValue, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SYSTEM_ENVIRONMENT_VALUE_EX, (BYTE*)oldZwSetSystemEnvironmentValueEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SHUTDOWN_SYSTEM, (BYTE*)oldZwShutdownSystem, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SYSTEM_DEBUG_CONTROL, (BYTE*)oldZwSystemDebugControl, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_OBJECT, (BYTE*)oldZwQueryObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_OBJECT, (BYTE*)oldZwSetInformationObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DUPLICATE_OBJECT, (BYTE*)oldZwDuplicateObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(MAKE_TEMPORARY_OBJECT, (BYTE*)oldZwMakeTemporaryObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SECURITY_OBJECT, (BYTE*)oldZwSetSecurityObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_DIRECTORY_OBJECT, (BYTE*)oldZwCreateDirectoryObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_DIRECTORY_OBJECT, (BYTE*)oldZwOpenDirectoryObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_DIRECTORY_OBJECT, (BYTE*)oldZwQueryDirectoryObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_SYMBOLIC_LINK_OBJECT, (BYTE*)oldZwCreateSymbolicLinkObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_SYMBOLIC_LINK_OBJECT, (BYTE*)oldZwOpenSymbolicLinkObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SYMBOLIC_LINK_OBJECT, (BYTE*)oldZwQuerySymbolicLinkObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_SECTION, (BYTE*)oldZwCreateSection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SECTION, (BYTE*)oldZwQuerySection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(EXTEND_SECTION, (BYTE*)oldZwExtendSection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNMAP_VIEW_OF_SECTION, (BYTE*)oldZwUnmapViewOfSection, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ARE_MAPPED_FILES_THE_SAME, (BYTE*)oldZwAreMappedFilesTheSame, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_JOB_OBJECT, (BYTE*)oldZwCreateJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_JOB_OBJECT, (BYTE*)oldZwOpenJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TERMINATE_JOB_OBJECT, (BYTE*)oldZwTerminateJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ASSIGN_PROCESS_TO_JOB_OBJECT, (BYTE*)oldZwAssignProcessToJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_JOB_OBJECT, (BYTE*)oldZwQueryInformationJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_JOB_OBJECT, (BYTE*)oldZwSetInformationJobObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_TOKEN, (BYTE*)oldZwCreateToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_PROCESS_TOKEN, (BYTE*)oldZwOpenProcessToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_PROCESS_TOKEN_EX, (BYTE*)oldZwOpenProcessTokenEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DUPLICATE_TOKEN, (BYTE*)oldZwDuplicateToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FILTER_TOKEN, (BYTE*)oldZwFilterToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ADJUST_PRIVILEGES_TOKEN, (BYTE*)oldZwAdjustPrivilegesToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ADJUST_GROUPS_TOKEN, (BYTE*)oldZwAdjustGroupsToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_TOKEN, (BYTE*)oldZwSetInformationToken, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SIGNAL_AND_WAIT_FOR_SINGLE_OBJECT, (BYTE*)oldZwSignalAndWaitForSingleObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_FOR_MULTIPLE_OBJECTS, (BYTE*)oldZwWaitForMultipleObjects, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_TIMER, (BYTE*)oldZwCreateTimer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_TIMER, (BYTE*)oldZwOpenTimer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CANCEL_TIMER, (BYTE*)oldZwCancelTimer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_TIMER, (BYTE*)oldZwSetTimer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_TIMER, (BYTE*)oldZwQueryTimer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_EVENT, (BYTE*)oldZwCreateEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_EVENT, (BYTE*)oldZwOpenEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PULSE_EVENT, (BYTE*)oldZwPulseEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RESET_EVENT, (BYTE*)oldZwResetEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CLEAR_EVENT, (BYTE*)oldZwClearEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_EVENT, (BYTE*)oldZwQueryEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_SEMAPHORE, (BYTE*)oldZwCreateSemaphore, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_SEMAPHORE, (BYTE*)oldZwOpenSemaphore, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RELEASE_SEMAPHORE, (BYTE*)oldZwReleaseSemaphore, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_SEMAPHORE, (BYTE*)oldZwQuerySemaphore, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_MUTANT, (BYTE*)oldZwCreateMutant, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_MUTANT, (BYTE*)oldZwOpenMutant, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RELEASE_MUTANT, (BYTE*)oldZwReleaseMutant, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_MUTANT, (BYTE*)oldZwQueryMutant, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_IO_COMPLETION, (BYTE*)oldZwCreateIoCompletion, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_IO_COMPLETION, (BYTE*)oldZwOpenIoCompletion, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_IO_COMPLETION, (BYTE*)oldZwSetIoCompletion, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REMOVE_IO_COMPLETION, (BYTE*)oldZwRemoveIoCompletion, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_IO_COMPLETION, (BYTE*)oldZwQueryIoCompletion, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_EVENT_PAIR, (BYTE*)oldZwCreateEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_EVENT_PAIR, (BYTE*)oldZwOpenEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_LOW_EVENT_PAIR, (BYTE*)oldZwWaitLowEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_HIGH_EVENT_PAIR, (BYTE*)oldZwWaitHighEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_LOW_WAIT_HIGH_EVENT_PAIR, (BYTE*)oldZwSetLowWaitHighEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_HIGH_WAIT_LOW_EVENT_PAIR, (BYTE*)oldZwSetHighWaitLowEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_LOW_EVENT_PAIR, (BYTE*)oldZwSetLowEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_HIGH_EVENT_PAIR, (BYTE*)oldZwSetHighEventPair, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SYSTEM_TIME, (BYTE*)oldZwSetSystemTime, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_PERFORMANCE_COUNTER, (BYTE*)oldZwQueryPerformanceCounter, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_TIMER_RESOLUTION, (BYTE*)oldZwSetTimerResolution, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_TIMER_RESOLUTION, (BYTE*)oldZwQueryTimerResolution, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(YIELD_EXECUTION, (BYTE*)oldZwYieldExecution, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INTERVAL_PROFILE, (BYTE*)oldZwSetIntervalProfile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INTERVAL_PROFILE, (BYTE*)oldZwQueryIntervalProfile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(STOP_PROFILE, (BYTE*)oldZwStopProfile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PRIVILEGE_CHECK, (BYTE*)oldZwPrivilegeCheck, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PRIVILEGE_OBJECT_AUDIT_ALARM, (BYTE*)oldZwPrivilegeObjectAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(PRIVILEGED_SERVICE_AUDIT_ALARM, (BYTE*)oldZwPrivilegedServiceAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_BY_TYPE, (BYTE*)oldZwAccessCheckByType, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_AND_AUDIT_ALARM, (BYTE*)oldZwAccessCheckByTypeAndAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST, (BYTE*)oldZwAccessCheckByTypeResultList, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST_AND_AUDIT_ALARM, (BYTE*)oldZwAccessCheckByTypeResultListAndAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ACCESS_CHECK_BY_TYPE_RESULT_LIST_AND_AUDIT_ALARM_BY_HANDLE, (BYTE*)oldZwAccessCheckByTypeResultListAndAuditAlarmByHandle, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_OBJECT_AUDIT_ALARM, (BYTE*)oldZwOpenObjectAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CLOSE_OBJECT_AUDIT_ALARM, (BYTE*)oldZwCloseObjectAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_OBJECT_AUDIT_ALARM, (BYTE*)oldZwDeleteObjectAuditAlarm, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REQUEST_WAKEUP_LATENCY, (BYTE*)oldZwRequestWakeupLatency, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REQUEST_DEVICE_WAKEUP, (BYTE*)oldZwRequestDeviceWakeup, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CANCEL_DEVICE_WAKEUP_REQUEST, (BYTE*)oldZwCancelDeviceWakeupRequest, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(IS_SYSTEM_RESUME_AUTOMATIC, (BYTE*)oldZwIsSystemResumeAutomatic, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_THREAD_EXECUTION_STATE, (BYTE*)oldZwSetThreadExecutionState, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(GET_DEVICE_POWER_STATE, (BYTE*)oldZwGetDevicePowerState, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_SYSTEM_POWER_STATE, (BYTE*)oldZwSetSystemPowerState, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(INITIATE_POWER_ACTION, (BYTE*)oldZwInitiatePowerAction, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(POWER_INFORMATION, (BYTE*)oldZwPowerInformation, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RAISE_EXCEPTION, (BYTE*)oldZwRaiseException, (DWORD*)systemCallTable);
	//unHookSSDTWithIndex(CONTINUE, (BYTE*)oldZwContinue, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CALLBACK_RETURN, (BYTE*)oldZwCallbackReturn, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOAD_DRIVER, (BYTE*)oldZwLoadDriver, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(UNLOAD_DRIVER, (BYTE*)oldZwUnloadDriver, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FLUSH_WRITE_BUFFER, (BYTE*)oldZwFlushWriteBuffer, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_DEFAULT_LOCALE, (BYTE*)oldZwSetDefaultLocale, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_DEFAULT_UI_LANGUAGE, (BYTE*)oldZwQueryDefaultUILanguage, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_DEFAULT_UI_LANGUAGE, (BYTE*)oldZwSetDefaultUILanguage, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INSTALL_UI_LANGUAGE, (BYTE*)oldZwQueryInstallUILanguage, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALLOCATE_LOCALLY_UNIQUE_ID, (BYTE*)oldZwAllocateLocallyUniqueId, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ALLOCATE_UUIDS, (BYTE*)oldZwAllocateUuids, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_UUID_SEED, (BYTE*)oldZwSetUuidSeed, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RAISE_HARD_ERROR, (BYTE*)oldZwRaiseHardError, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_DEFAULT_HARD_ERROR_PORT, (BYTE*)oldZwSetDefaultHardErrorPort, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DISPLAY_STRING, (BYTE*)oldZwDisplayString, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_PAGING_FILE, (BYTE*)oldZwCreatePagingFile, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ADD_ATOM, (BYTE*)oldZwAddAtom, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(FIND_ATOM, (BYTE*)oldZwFindAtom, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_ATOM, (BYTE*)oldZwDeleteAtom, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_INFORMATION_ATOM, (BYTE*)oldZwQueryInformationAtom, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_LDT_ENTRIES, (BYTE*)oldZwSetLdtEntries, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(VDM_CONTROL, (BYTE*)oldZwVdmControl, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_BOOT_ENTRY_ORDER, (BYTE*)oldNtSetBootEntryOrder, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(COMPACT_KEYS, (BYTE*)oldNtCompactKeys, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(COMPARE_TOKENS, (BYTE*)oldNtCompareTokens, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(COMPRESS_KEY, (BYTE*)oldNtCompressKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_DEBUG_OBJECT, (BYTE*)oldNtCreateDebugObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_JOB_SET, (BYTE*)oldNtCreateJobSet, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DEBUG_ACTIVE_PROCESS, (BYTE*)oldNtDebugActiveProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DEBUG_CONTINUE, (BYTE*)oldNtDebugContinue, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(ENUMERATE_SYSTEM_ENVIRONMENT_VALUES_EX, (BYTE*)oldNtEnumerateSystemEnvironmentValuesEx, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(IS_PROCESS_IN_JOB, (BYTE*)oldNtIsProcessInJob, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOCK_PRODUCT_ACTIVATION_KEYS, (BYTE*)oldNtLockProductActivationKeys, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(LOCK_REGISTRY_KEY, (BYTE*)oldNtLockRegistryKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(MAKE_PERMANENT_OBJECT, (BYTE*)oldNtMakePermanentObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(DELETE_BOOT_ENTRY, (BYTE*)oldNtDeleteBootEntry, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_DEBUG_FILTER_STATE, (BYTE*)oldNtQueryDebugFilterState, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(REMOVE_PROCESS_DEBUG, (BYTE*)oldNtRemoveProcessDebug, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RENAME_KEY, (BYTE*)oldNtRenameKey, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RESUME_PROCESS, (BYTE*)oldNtResumeProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_DEBUG_FILTER_STATE, (BYTE*)oldNtSetDebugFilterState, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_EVENT_BOOST_PRIORITY, (BYTE*)oldNtSetEventBoostPriority, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SET_INFORMATION_DEBUG_OBJECT, (BYTE*)oldNtSetInformationDebugObject, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(SUSPEND_PROCESS, (BYTE*)oldNtSuspendProcess, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TRACE_EVENT, (BYTE*)oldNtTraceEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(TRANSLATE_FILE_PATH, (BYTE*)oldNtTranslateFilePath, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_FOR_DEBUG_EVENT, (BYTE*)oldNtWaitForDebugEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(CREATE_KEYED_EVENT, (BYTE*)oldNtCreateKeyedEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(OPEN_KEYED_EVENT, (BYTE*)oldNtOpenKeyedEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(RELEASE_KEYED_EVENT, (BYTE*)oldNtReleaseKeyedEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(WAIT_FOR_KEYED_EVENT, (BYTE*)oldNtWaitForKeyedEvent, (DWORD*)systemCallTable);
	unHookSSDTWithIndex(QUERY_PORT_INFORMATION_PROCESS, (BYTE*)oldNtQueryPortInformationProcess, (DWORD*)systemCallTable);
	//UNHOOK_HERE
	
	//unHookSSDT((BYTE*)ZwAcceptConnectPort, (BYTE*)oldZwAcceptConnectPort, (DWORD*)systemCallTable);
	EnableWP();
	/**
	while (counter != 0) {
		DbgPrint("Counter value: %u \r\n",counter );
	}
	*/
	//KeDelayExecutionThread(KernelMode, FALSE, &interval);
	/* delete the driver */
    DbgPrint("MyDriver_Unload Called \r\n");
	DbgPrint("Counter value: %u \r\n",counter );
	KeDelayExecutionThread(KernelMode, TRUE, &interval);
	DbgPrint("Counter value: %u \r\n",counter );
    RtlInitUnicodeString(&usDosDeviceName, L"\\DosDevices\\MyDriver");
    IoDeleteSymbolicLink(&usDosDeviceName);
    IoDeleteDevice(DriverObject->DeviceObject);
}

void unHookSSDT(BYTE* apiCall, BYTE* oldAddr, DWORD* callTable) {
	PLONG target;
	DWORD indexValue;
	
	indexValue = getSSDTIndex(apiCall);
	target = (PLONG) &(callTable[indexValue]);
	InterlockedExchange(target,(LONG)oldAddr);
}

void unHookSSDTWithIndex(DWORD apiCall, BYTE* oldAddr, DWORD* callTable) {
	PLONG target;
	DWORD indexValue;
	
	indexValue = apiCall;
	target = (PLONG) &(callTable[indexValue]);
	InterlockedExchange(target,(LONG)oldAddr);
}




/*
 * MyDriver_UnSupportedFunction: called when a major function is issued that isn't supported.
 */
NTSTATUS MyDriver_UnSupportedFunction(PDEVICE_OBJECT DeviceObject, PIRP Irp) {
    NTSTATUS NtStatus = STATUS_NOT_SUPPORTED;
    DbgPrint("MyDriver_UnSupportedFunction Called \r\n");

    return NtStatus;
	
}
/**
NTSTATUS newZwSetValueKey(
  IN     HANDLE          KeyHandle,
  IN     PUNICODE_STRING ValueName,
  IN 	 ULONG           TitleIndex,
  IN     ULONG           Type,
  IN     PVOID           Data,
  IN     ULONG           DataSize
  ){
		ULONG index = 0;
		NTSTATUS ntStatus;
		//PKEY_NAME_INFORMATION keyNameInfo;
		ANSI_STRING ansiString;
		ANSI_STRING processName = {0};
		KEY_INFORMATION_CLASS keyInfo;
		ULONG resultLength = 0;
		ULONG proposedSize = 0;
		PKEY_NAME_INFORMATION keyNameInfo = NULL;
		WCHAR logString[950] = {0};
		WCHAR dataString[150] = {0};
		WCHAR nameString[150] = {0};
		WCHAR fileString[150] = {0};
		UNICODE_STRING logEvent = {0};
		UNICODE_STRING dataData = {0};
		UNICODE_STRING nameData = {0};
		UNICODE_STRING fileData = {0};
		logEvent.MaximumLength = 1000 *  sizeof(WCHAR);
		dataData.MaximumLength = 100 *  sizeof(WCHAR);
		nameData.MaximumLength = 500 * sizeof(WCHAR);
		fileData.MaximumLength = 100 * sizeof(WCHAR);
		processName.MaximumLength = 100 * sizeof(CHAR);
		counter+=1;
		
		logEvent.Length = 0;
		dataData.Length = 0;
		nameData.Length = 0;
		processName.Length = 0;
		fileData.Length = 0;
		//keyNameInfo = ExAllocatePool(PagedPool, sizeof(KEY_NAME_INFORMATION));
		//RtlInitUnicodeString(&logEvent, L"");
		RtlInitEmptyUnicodeString(&logEvent, logString, (USHORT)sizeof(logString));
		RtlInitEmptyUnicodeString(&dataData, dataString, (USHORT)sizeof(dataString));
		RtlInitEmptyUnicodeString(&nameData, nameString, (USHORT)sizeof(nameString));
		RtlInitEmptyUnicodeString(&fileData, fileString, (USHORT)sizeof(fileString));
		ntStatus = RtlUnicodeStringToAnsiString(&ansiString, ValueName, TRUE);
		RtlAppendUnicodeToString(&fileData, L"\\SystemRoot\\d\\example.txt\0");
		if(NT_SUCCESS(ntStatus))
		{
			RtlInitAnsiString(&processName, (BYTE *)PsGetCurrentProcess()+0x174);
			RtlAnsiStringToUnicodeString(&dataData, &processName, FALSE);
			//DbgPrint("Process Name: %wZ \n", &dataData);
			
			RtlAppendUnicodeToString(&logEvent, L"ProcessName=");
			RtlAppendUnicodeStringToString(&logEvent, &dataData);
			RtlAppendUnicodeToString(&logEvent, L",MethodName=ZwSetValueKey,ValueName=");
			RtlAppendUnicodeToString(&logEvent, ValueName->Buffer);
			
			//RtlAppendUnicodeStringToString(&logEvent, ValueName);
			//DbgPrint("%wZ \n", &logEvent);
			RtlFreeAnsiString(&ansiString);
			keyInfo = KeyNameInformation;
			ntStatus = ZwQueryKey(KeyHandle, KeyNameInformation, keyNameInfo, proposedSize, &resultLength);
			if((ntStatus == STATUS_BUFFER_TOO_SMALL) || (ntStatus == STATUS_BUFFER_OVERFLOW)){
				proposedSize = resultLength;
				keyNameInfo = (PKEY_NAME_INFORMATION)ExAllocatePoolWithTag(NonPagedPool, resultLength, 'aaa');
			}
			ntStatus = ZwQueryKey(KeyHandle, KeyNameInformation, keyNameInfo, proposedSize, &resultLength);
			if (NT_SUCCESS(ntStatus)){
					//DbgPrint("Success!!\r\n");
					for (index = 0; index < keyNameInfo->NameLength; index++) {
						RtlAppendUnicodeToString(&nameData, &(keyNameInfo->Name[index]));
					}
					RtlAppendUnicodeToString(&logEvent, L",Key=");
					RtlAppendUnicodeStringToString(&logEvent, &nameData);
			}
			else {
				if (STATUS_BUFFER_TOO_SMALL == ntStatus){
					DbgPrint("Buffer too small\r\n");
				}
				if (STATUS_BUFFER_OVERFLOW == ntStatus) {
					for (index = 0; index < keyNameInfo->NameLength; index++) {
						RtlAppendUnicodeToString(&nameData, &(keyNameInfo->Name[index]));
					}
					DbgPrint("ZwSetValueKey: Buffer Overflow!!");
				}
				if (STATUS_INVALID_PARAMETER == ntStatus) {
					DbgPrint("Invalid Parameter\r\n");
				}
				if (STATUS_ACCESS_VIOLATION == ntStatus) {
					DbgPrint("Status Access Violation\r\n");
				}
				DbgPrint("Unsuccessful: %x \r\n", ntStatus);
			}
			switch(Type)
			{
				case(REG_BINARY):{
					//RtlIntegerToUnicodeString(Data, 16L, dataData);
					RtlAppendUnicodeToString(&logEvent, L",Type==REG_BINARY,Data=");
					RtlAppendUnicodeToString(&logEvent, (PCWSTR)Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");
					//DbgPrint("CASE Data: %S\n", Data);
					driverWriteFile(&logEvent, &fileData);}break;
				case(REG_DWORD):{
					RtlAppendUnicodeToString(&logEvent, L",Type=REG_DWORD,Data=");
					RtlAppendUnicodeToString(&logEvent, Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");
					driverWriteFile(&logEvent, &fileData);}break;
				case(REG_EXPAND_SZ):{
					RtlAppendUnicodeToString(&logEvent, L",Type==REG_EXPAND_SZ,Data=");
					RtlAppendUnicodeToString(&logEvent, Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");					
					driverWriteFile(&logEvent, &fileData);}break;
				case(REG_LINK):{
					RtlAppendUnicodeToString(&logEvent, L",Type==REG_LINK,Data=");
					RtlAppendUnicodeToString(&logEvent, Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");					
					driverWriteFile(&logEvent, &fileData);}break;
				case(REG_MULTI_SZ):{
					RtlAppendUnicodeToString(&logEvent, L",Type=REG_MULTI_SZ,Data=");
					RtlAppendUnicodeToString(&logEvent, (PCWSTR)Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");
					//DbgPrint("REG_MULTI_SZ: %S\n", Data);
					driverWriteFile(&logEvent, &fileData);}break;
				case(REG_NONE):{RtlAppendUnicodeToString(&logEvent, L",Type==REG_NONE\r\n");driverWriteFile(&logEvent, &fileData);}break;
				case(REG_SZ):{
					RtlAppendUnicodeToString(&logEvent, L",Type==REG_SZ,Data=");
					RtlAppendUnicodeToString(&logEvent, (PCWSTR)Data);
					RtlAppendUnicodeToString(&logEvent, L"\r\n\0");
					//DbgPrint("REG_SZ: %S\n", Data);
					driverWriteFile(&logEvent, &fileData); }break;
			};
		}
		ntStatus = ((ZwSetValueKeyPtr)(oldZwSetValueKey))
		(
			KeyHandle,
			ValueName,
			TitleIndex,
			Type,
			Data,
			DataSize
		);
		
		if(!NT_SUCCESS(ntStatus)) {
			DbgPrint("newZwSetValueKey: Call was not a success");
		}
		//ExFreePool(keyNameInfo);
		return ntStatus;
	  
}
*/
/*
ULONG getTIDByHandle(HANDLE hThread)
{
	THREAD_BASIC_INFORMATION teb;
	NTSTATUS ntStatus;
	PEPROCESS process = NULL;
	
	if(hThread) {
		ntStatus = ZwQueryInformationThread(hThread, 0, &teb, sizeof(teb), NULL);
		if(NT_SUCCESS(ntStatus)) {
			//PsLookupProcessByProcessId(teb.ClientId.UniqueProcess, process);
			//DbgPrint("getTIDByHandle %S\n:", (BYTE *)process+0x174);
			return (ULONG)teb.ClientId.UniqueProcess;
		}
		else {
			DbgPrint("getTIDByHandle: %x\n", ntStatus);
		}
	}
	else {
		DbgPrint("getTIDByHandle: INVALID HANDLE");
	}
	
	return 0;
}
*/
ULONG getPIDByHandle(HANDLE hProc)
{
	PROCESS_BASIC_INFORMATION peb;
	ULONG neverDoThis = 1234567890L;
	
	if(hProc)
		if(NT_SUCCESS(ZwQueryInformationProcess(hProc, 0, &peb, sizeof(PROCESS_BASIC_INFORMATION), &neverDoThis)))
			return peb.UniqueProcessId;
	
	return 0;
}

NTSTATUS getPIDByThreadHandle(HANDLE hThread, PUNICODE_STRING ProcessImageName)
{
	NTSTATUS status;
    ULONG returnedLength;
    ULONG bufferLength;
    PVOID buffer;
    PUNICODE_STRING imageName;
	
	PAGED_CODE();
	
	status = ZwQueryInformationProcess( hThread, 
                                        ProcessImageFileName,
                                        NULL, // buffer
                                        0, // buffer size
                                        &returnedLength);	
	
	
	/**
	status = ZwQueryInformationProcess( NtCurrentProcess(), 
                                        ProcessImageFileName,
                                        NULL, // buffer
                                        0, // buffer size
                                        &returnedLength);
	**/
	 if (STATUS_INFO_LENGTH_MISMATCH != status) {

        return status;

    }

    //
    // Is the passed-in buffer going to be big enough for us?  
    // This function returns a single contguous buffer model...
    //
    bufferLength = returnedLength - sizeof(UNICODE_STRING);
    
    if (ProcessImageName->MaximumLength < bufferLength) {

        ProcessImageName->Length = (USHORT) bufferLength;

        return STATUS_BUFFER_OVERFLOW;
        
    }
	buffer = ExAllocatePoolWithTag(PagedPool, returnedLength, 'ipgD');

    if (NULL == buffer) {

        return STATUS_INSUFFICIENT_RESOURCES;
        
    }

    //
    // Now lets go get the data
    //
    status = ZwQueryInformationProcess( NtCurrentProcess(), 
                                        ProcessImageFileName,
                                        buffer,
                                        returnedLength,
                                        &returnedLength);

    if (NT_SUCCESS(status)) {
        //
        // Ah, we got what we needed
        //
        imageName = (PUNICODE_STRING) buffer;

        RtlCopyUnicodeString(ProcessImageName, imageName);
        
    }

    //
    // free our buffer
    //
    ExFreePool(buffer);

    //
    // And tell the caller what happened.
    //    
    return status;
}

NTSTATUS getFilenameByHandle(HANDLE hFile, PUNICODE_STRING FileName)
{
	//STARTS HERE
	NTSTATUS status;
    ULONG returnedLength;
    ULONG bufferLength;
    PUNICODE_STRING imageName;
	PFILE_NAME_INFORMATION buffer;
	PIO_STATUS_BLOCK ioStatusBlock;
	UNICODE_STRING routineName;
	ZwQueryInformationFilePtr ZwQueryInformationFile = NULL;
	
	PAGED_CODE(); // this eliminates the possibility of the IDLE Thread/Process
	
    if (NULL == ZwQueryInformationFile) {

        

        RtlInitUnicodeString(&routineName, L"ZwQueryInformationFile");

        ZwQueryInformationFile = 
               (ZwQueryInformationFilePtr)MmGetSystemRoutineAddress(&routineName);
        if (NULL == ZwQueryInformationFile) {
            DbgPrint("Cannot resolve ZwQueryInformationFile\n");
        }
    }
	
	ioStatusBlock = (PIO_STATUS_BLOCK)ExAllocatePoolWithTag(PagedPool, sizeof(IO_STATUS_BLOCK), 'stat');
	buffer = (PFILE_NAME_INFORMATION)ExAllocatePoolWithTag(PagedPool, sizeof(FILE_NAME_INFORMATION) + (150 * sizeof(WCHAR)), 'sdfs');
    //
    // Now lets go get the data
    //
    status = ZwQueryInformationFile(hFile, 
                                ioStatusBlock,
                                buffer,
                                sizeof(FILE_NAME_INFORMATION) + (150 * sizeof(WCHAR)),
                                FileNameInformation);

	//FileName->Buffer = buffer->FileName;
    if (NT_SUCCESS(status)) {
        //
        // Ah, we got what we needed
        //
        //DbgPrint("This was successful! \r\n");
		memcpy(FileName->Buffer,
		&(buffer->FileName[0]),
		buffer->FileNameLength);
		//FileName->Length = buffer->FileNameLength;
		FileName->Length = (SHORT)buffer->FileNameLength;
//		buffer->FileNameLength = (SHORT)FileName->Length;
		//RtlLongToShort(buffer->FileNameLength, &(FileName->Length));
		//DbgPrint("Copied memory: %wZ length: %lu original:%S \r\n", FileName, buffer->FileNameLength, &buffer->FileName);
        
    }
	else {
	}
	//ENDS HERE

	ExFreePool(ioStatusBlock);
	ExFreePool(buffer);

    //
    // And tell the caller what happened.
    //    
    return status;
}

/**
NTSTATUS newZwOpenThread(PHANDLE ThreadHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientID)
{
	NTSTATUS ntStatus;
	NTSTATUS processNameStatus;
	WCHAR tebString[150]={0};
	PWCHAR logString = {0};
	WCHAR uprocessString[150] = {0};
	PWCHAR fileString = {0};
	WCHAR processString[150] = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];

	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING logEvent = {0};
	UNICODE_STRING uprocessEvent = {0};
	UNICODE_STRING processHooked;
	UNICODE_STRING teb = {0};
	UNICODE_STRING fileData = {0};
	UNICODE_STRING processName = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	
	logEvent.MaximumLength = 1000 *  sizeof(WCHAR);
	uprocessEvent.MaximumLength = 100 *  sizeof(WCHAR);
	teb.MaximumLength = 150 *sizeof(WCHAR);
	fileData.MaximumLength = 100 * sizeof(WCHAR);
	
	processName.MaximumLength = 100 * sizeof(CHAR);
	
	logEvent.Length = 0;
	uprocessEvent.Length = 0;
	processName.Length = 0;
	teb.Length = 0;
	fileData.Length = 0;
	
	fileData.MaximumLength = 150 * sizeof(WCHAR);
	logEvent.MaximumLength = 950 * sizeof(WCHAR);
	
	fileData.Length = 0;
	logEvent.Length = 0;
	fileString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	logString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	fileData.Buffer = fileString;
	logEvent.Buffer = logString;
	
	RtlInitEmptyUnicodeString(&teb, tebString, (USHORT)sizeof(tebString));
	RtlInitEmptyUnicodeString(&uprocessEvent, uprocessString, (USHORT)sizeof(uprocessString));
	RtlInitEmptyUnicodeString(&processName, processString, (USHORT)150 * sizeof(WCHAR));

	//RtlInitAnsiString(&processName, (BYTE *)PsGetCurrentProcess()+0x174);

	//RtlAnsiStringToUnicodeString(&uprocessEvent, &processName, FALSE);
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&logEvent, L"Time=");
	RtlAppendUnicodeStringToString(&logEvent, &uTime);
	RtlAppendUnicodeToString(&logEvent, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uprocessEvent);
	
	RtlAppendUnicodeToString(&fileData, L"\\SystemRoot\\d\\thread.txt\0");
	RtlAppendUnicodeToString(&logEvent, L"MethodName=ZwOpenThread,");
	RtlAppendUnicodeToString(&logEvent, L"ProcessName=");
	RtlAppendUnicodeStringToString(&logEvent, &uprocessEvent);
	
	//DbgPrint("ZwOpenThread: %wZ \n", &logEvent);

	
	RtlAppendUnicodeToString(&logEvent, L",TargetProcessID=");
	//RtlAppendUnicodeStringToString(&logEvent, &teb);
	//RtlAppendUnicodeToString(&logEvent, L"\r\n");
	
	
	
	ntStatus = oldZwOpenThread(ThreadHandle, DesiredAccess, ObjectAttributes, ClientID);
	RtlIntegerToUnicodeString(getTIDByHandle(*ThreadHandle), 10, &teb);
	RtlAppendUnicodeStringToString(&logEvent, &teb);
	RtlAppendUnicodeToString(&logEvent, L"\r\n\0");
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = fileString;
			Irp->UserBuffer = logString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&logEvent, &fileData, *oldZwOpenFile);
	}
	//DbgPrint("Process ID 0: %wZ, Thread ID 1: %u\n", &teb, getTIDByHandle(*ThreadHandle));
	//DbgPrint("OBJECT_ATTRIBUTES: %wZ \n", &(ObjectAttributes->ObjectName));

	ExFreePool(fileString);
	ExFreePool(logString);
	ExFreePool(timeBuffer);
	return ntStatus;

}
*/
/**
NTSTATUS newZwOpenProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientID) {
	NTSTATUS ntStatus;
	
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	WCHAR nameString[150] = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uName = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	uName.MaximumLength = 150 * sizeof(WCHAR);
	
	counter+=1;
	uName.Length = 0;
	
	RtlInitEmptyUnicodeString(&uName, nameString, sizeof(nameString));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenProcess,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);
	
	ntStatus = oldZwOpenProcess(ProcessHandle, DesiredAccess, ObjectAttributes, ClientID);
	
	getPIDByThreadHandle(*ProcessHandle, &uName);
	RtlAppendUnicodeToString(&uFullString, L",ProcessOpen=");
	RtlAppendUnicodeStringToString(&uFullString, &uName);
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	//DbgPrint("%wZ \r\n", &uFullString);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenProcess.txt\0");
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
	
}
*/
/**
NTSTATUS newZwWriteVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG NumberOfBytesToWrite, PULONG NumberOfBytesWritten) {
	
	NTSTATUS ntStatus;

	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];

	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWriteVirtualMemory,ProcessName=");
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	
	ntStatus = oldZwWriteVirtualMemory(ProcessHandle, BaseAddress, Buffer, NumberOfBytesToWrite, NumberOfBytesWritten);
	
	getPIDByThreadHandle(ProcessHandle, &uProcess);	
	RtlAppendUnicodeToString(&uFullString, L",TargetProcess=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWriteVirtualMemory.txt\0");
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
NTSTATUS newZwReadVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG NumberOfBytesToRead, PULONG NumberOfBytesReaded) {
	
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReadVirtualMemory,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);
	
	ntStatus = oldZwReadVirtualMemory(ProcessHandle, BaseAddress, Buffer, NumberOfBytesToRead, NumberOfBytesReaded);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReadVirtualMemory.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
//NEED TO TEST THIS
NTSTATUS newZwDebugActiveProcess(HANDLE ProcessHandle, HANDLE DebugHandle) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDebugActiveProcess,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwDebugActiveProcess(ProcessHandle, DebugHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDebugActiveProcess.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
NTSTATUS newZwCreateSection (PHANDLE SectionHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,PLARGE_INTEGER SectionSize,ULONG Protect,ULONG Attributes,HANDLE FileHandle) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateSection,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwCreateSection(SectionHandle,DesiredAccess,ObjectAttributes,SectionSize,Protect,Attributes,FileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateSection.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
//NEED TO TEST!!
NTSTATUS newZwCreateProcess(PHANDLE ProcessHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,HANDLE InheritFromProcessHandle,BOOLEAN InheritHandles,HANDLE SectionHandle,HANDLE DebugPort,HANDLE ExceptionPort) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateProcess,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwCreateProcess(ProcessHandle,DesiredAccess,ObjectAttributes,InheritFromProcessHandle,InheritHandles,SectionHandle,DebugPort,ExceptionPort);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateProcess.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}
*/
/**
NTSTATUS newZwCreateProcessEx(PHANDLE ProcessHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,HANDLE InheritFromProcessHandle,BOOLEAN InheritHandles,HANDLE SectionHandle,HANDLE DebugPort,HANDLE ExceptionPort,HANDLE dunno) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateProcessEx,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwCreateProcessEx(ProcessHandle,DesiredAccess,ObjectAttributes,InheritFromProcessHandle,InheritHandles,SectionHandle,DebugPort,ExceptionPort,dunno);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateProcessEx.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	} 
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}
*/
/**
NTSTATUS newZwQueueApcThread(HANDLE ThreadHandle,PIO_APC_ROUTINE ApcRoutine,PVOID ApcRoutineContext,PIO_STATUS_BLOCK ApcStatusBlock,ULONG ApcReserved)	{
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueueApcThread,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwQueueApcThread(ThreadHandle,ApcRoutine,ApcRoutineContext,ApcStatusBlock,ApcReserved);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueueApcThread.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);	
	return ntStatus;	
}
*/
/**
NTSTATUS newZwCreateThread(PHANDLE ThreadHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,HANDLE ProcessHandle,PCLIENT_ID ClientID,PCONTEXT ThreadContext,PUSER_STACK UserStack,BOOLEAN CreateSuspended) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	

	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateThread,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwCreateThread(ThreadHandle,DesiredAccess,ObjectAttributes,ProcessHandle,ClientID,ThreadContext,UserStack,CreateSuspended);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateThread.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);	
	return ntStatus;
}
*/
/**
NTSTATUS newZwCreateThreadEx(PHANDLE ThreadHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,HANDLE ProcessHandle,PVOID StartAddress,PVOID Parameter,BOOLEAN CreateSuspended,ULONG StackZeroBits,ULONG SizeOfStackCommit,ULONG SizeOfStackReserve,PVOID BytesBuffer) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateThreadEx,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwCreateThreadEx(ThreadHandle,DesiredAccess,ObjectAttributes,ProcessHandle,StartAddress,Parameter,CreateSuspended,StackZeroBits,SizeOfStackCommit,SizeOfStackReserve,BytesBuffer);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateThreadEx.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	} else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/

NTSTATUS newZwMapViewOfSection(HANDLE SectionHandle, HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, SIZE_T CommitSize, PLARGE_INTEGER SectionOffset, PSIZE_T ViewSize, SECTION_INHERIT InheritDisposition, ULONG AllocationType, ULONG Win32Protect) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwMapViewOfSection \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else  {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;	
}	
NTSTATUS newZwSetContextThread(HANDLE ThreadHandle, PCONTEXT Context){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwSetContextThread \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetContextThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetContextThread(ThreadHandle,Context);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetContextThread.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;	
}	
/**
NTSTATUS newZwSystemDebugControl(SYSDBG_COMMAND Command, PVOID InputBuffer, ULONG InputBufferLength, PVOID OutputBuffer, ULONG OutputBufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSystemDebugControl,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSystemDebugControl(Command,InputBuffer,InputBufferLength,OutputBuffer,OutputBufferLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSystemDebugControl.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
/**
NTSTATUS newZwOpenFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, ULONG ShareAccess, ULONG OpenOptions){
	
	NTSTATUS ntStatus;
	//PFILE_NAME_INFORMATION buffer;
	//enum FILE_INFORMATION_CLASS enumInfo = FileNameInformation;
	//PIO_STATUS_BLOCK pioStatusBlock = NULL;
	
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	size_t expectedLength;
	//PWCHAR nameString;
	PWSTR checkString; 
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	UINT32 i = 0;
	counter+=1;
	
	expectedLength = sizeof(WCHAR) * 27;
	//DbgPrint("ObjectAttributes: %wZ \r\n", ObjectAttributes->ObjectName);
	expectedLength = memcmp(ObjectAttributes->ObjectName->Buffer, L"\\SystemRoot\\d\\", sizeof(WCHAR) * 14); 
	if (expectedLength == 0) {
		//DbgPrint("Expected Length %u \r\n", expectedLength);
		return oldZwOpenFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,ShareAccess,OpenOptions);
	}
	else {		
		uProcess.MaximumLength = 150 * sizeof(WCHAR);
		uFullString.MaximumLength = 950 * sizeof(WCHAR);
		processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'ofpr');
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'offu');
		
		uProcess.Length = 0;
		uFullString.Length = 0;
		uFullString.Buffer = fullString;
		uProcess.Buffer = processString;
		
		
		//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 950);
		//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		
		//DbgPrint("File: %wZ\r\n", ObjectAttributes->ObjectName);
		checkString = L"\\SystemRoot\\d";


		//ExFreePool(buffer);

		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");		
		
		getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenFile,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);
		
		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwOpenFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,ShareAccess,OpenOptions);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenFile.txt\0");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");

		driverWriteFile(&uFullString, &uProcess, oldZwOpenFile);
		/* KEEP REMOVED
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
		*/
		/**
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(timeBuffer);
		globalSetter = 0;
		return ntStatus;
	}
		
}	
*/
/**
NTSTATUS newZwCreateFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, PLARGE_INTEGER AllocationSize, ULONG FileAttributes, ULONG ShareAccess, ULONG CreateDisposition, ULONG CreateOptions, PVOID EaBuffer, ULONG EaLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	counter+=1;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'cfpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'cffu');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 950);
	//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,AllocationSize,FileAttributes,ShareAccess,CreateDisposition,CreateOptions,EaBuffer,EaLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateFile.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
NTSTATUS newZwReadFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwReadFile \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReadFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReadFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,Length,ByteOffset,Key);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	uProcess.Length = 0;
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReadFile.txt\0");
	
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	} 
	else {
		//DbgPrint("ZwReadFile: %wZ full: %wZ\r\n", &uProcess, &uFullString);
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}
/**
NTSTATUS newZwDeleteFile(POBJECT_ATTRIBUTES ObjectAttributes) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteFile(ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteFile.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
NTSTATUS newZwSetInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG Length, FILE_INFORMATION_CLASS FileInformationClass) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationFile(FileHandle,IoStatusBlock,FileInformation,Length,FileInformationClass);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationFile.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
NTSTATUS newZwCreateMutant(PHANDLE MutantHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, BOOLEAN InitialOwner) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];	

	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateMutant,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateMutant(MutantHandle,DesiredAccess,ObjectAttributes,InitialOwner);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateMutant.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/

NTSTATUS newZwDeviceIoControlFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, ULONG IoControlCode, PVOID InputBuffer, ULONG InputBufferLength, PVOID OuputBuffer, ULONG OutputBufferLength) {
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];

	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	

	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	counter+=1;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwDeviceIoControlFile \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 150);
	//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 950);
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeviceIoControlFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeviceIoControlFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,IoControlCode,InputBuffer,InputBufferLength,OuputBuffer,OutputBufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeviceIoControlFile.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}
/**
NTSTATUS newZwTerminateProcess(HANDLE ProcessHandle, NTSTATUS ExitStatus) {
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwTerminateProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwTerminateProcess(ProcessHandle, ExitStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwTerminateProcess.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}
*/
/**
NTSTATUS newZwResumeThread(HANDLE ThreadHandle, PULONG SuspendCount){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];

	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;	

	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;

	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwResumeThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwResumeThread(ThreadHandle,SuspendCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwResumeThread.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
/**
NTSTATUS newZwLoadDriver(PUNICODE_STRING DriverServiceName){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;

	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLoadDriver,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLoadDriver(DriverServiceName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLoadDriver.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
NTSTATUS newZwDelayExecution(BOOLEAN Alertable, PLARGE_INTEGER DelayInterval){
	NTSTATUS ntStatus;
	WCHAR processString[150] = {0};
	WCHAR fullString[950] = {0};
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(fullString));
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDelayExecution,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDelayExecution(Alertable,DelayInterval);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDelayExecution.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n");
	
	driverWriteFile(&uFullString, &uProcess);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);	
	return ntStatus;	
}	
/**
NTSTATUS newZwQueryValueKey(HANDLE KeyHandle, PUNICODE_STRING ValueName, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG Length, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];	
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryValueKey(KeyHandle,ValueName,KeyValueInformationClass,KeyValueInformation,Length,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryValueKey.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
/**
NTSTATUS newZwQueryAttributesFile(POBJECT_ATTRIBUTES ObjectAttributes, PFILE_BASIC_INFORMATION FileInformation){
	NTSTATUS ntStatus;
	PWCHAR processString = {0};
	PWCHAR fullString = {0};
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];	
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapViewOfSection,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryAttributesFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryAttributesFile(ObjectAttributes,FileInformation);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, 150 * sizeof(WCHAR));
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryAttributesFile.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;	
}	
*/
/**
NTSTATUS newZwAcceptConnectPort(PHANDLE PortHandle, ULONG PortIdentifier, PPORT_MESSAGE Message, BOOLEAN Accept, PPORT_SECTION_WRITE WriteSection, PPORT_SECTION_READ ReadSection){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	
	ANSI_STRING ansiTime;
	
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	counter+=1;
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	
	//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 150);
	//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 950);
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAcceptConnectPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAcceptConnectPort(PortHandle,PortIdentifier,Message,Accept,WriteSection,ReadSection);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAcceptConnectPort.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	return ntStatus;
}	*/
NTSTATUS newZwWaitForSingleObject(HANDLE Handle, BOOLEAN Alertable, PLARGE_INTEGER Timeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwWaitForSingleObject \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 150);
	//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 950);
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWaitForSingleObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWaitForSingleObject(Handle,Alertable,Timeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWaitForSingleObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n");
	
	driverWriteFile(&uFullString, &uProcess);
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}
	
NTSTATUS newZwReplyWaitReceivePort(HANDLE PortHandle, PULONG PortIdentifier, PPORT_MESSAGE ReplyMessage, PPORT_MESSAGE Message){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	counter+=1;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwReplyWaitReceivePort \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	//RtlInitEmptyUnicodeString(&uFullString, fullString, sizeof(WCHAR) * 150);
	//RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 950);
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	//RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,");
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReplyWaitReceivePort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReplyWaitReceivePort(PortHandle,PortIdentifier,ReplyMessage,Message);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReplyWaitReceivePort.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	//driverWriteFile(&uFullString, &uProcess);
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}	
NTSTATUS newZwRequestWaitReplyPort(HANDLE PortHandle, PPORT_MESSAGE RequestMessage, PPORT_MESSAGE ReplyMessage){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime = {0};
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwRequestWaitReplyPort \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRequestWaitReplyPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRequestWaitReplyPort(PortHandle,RequestMessage,ReplyMessage);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRequestWaitReplyPort.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}	
NTSTATUS newZwClose(HANDLE Handle){
	NTSTATUS ntStatus;
	NTSTATUS filenameStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR nameBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	size_t expectedLength;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uName = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uName.MaximumLength = 150 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	uName.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwClose \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	nameBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'kwjl');
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uName.Buffer = nameBuffer;
	uPid.Buffer = pidBuffer;
	
	filenameStatus = getFilenameByHandle(Handle, &uName);
	expectedLength = sizeof(WCHAR) * 27;
	//DbgPrint("ObjectAttributes: %wZ \r\n", ObjectAttributes->ObjectName);
	if (filenameStatus == STATUS_SUCCESS) {
		expectedLength = memcmp(uName.Buffer, L"\\WINDOWS\\d\\", sizeof(WCHAR) * 10); 
	}
	if ((filenameStatus == STATUS_SUCCESS) && (expectedLength == 0)) {
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(nameBuffer);
		ExFreePool(pidBuffer);
		return oldZwClose(Handle);
	}
	else {
	
		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		pid = getPIDByHandle(NtCurrentProcess());
		RtlIntegerToUnicodeString(pid, 10, &uPid);
		RtlAppendUnicodeToString(&uFullString, L"Pid=");
		RtlAppendUnicodeStringToString(&uFullString, &uPid);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwClose,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);

		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwClose(Handle);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwClose.txt");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
		

		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(nameBuffer);
	ExFreePool(pidBuffer);

	return ntStatus;
}	


NTSTATUS newZwSetEvent(HANDLE EventHandle, PULONG PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwSetEvent \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetEvent(EventHandle,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenThreadToken(HANDLE ThreadHandle, ACCESS_MASK DesiredAccess, BOOLEAN OpenAsSelf, PHANDLE TokenHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwOpenThreadToken \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenThreadToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenThreadToken(ThreadHandle,DesiredAccess,OpenAsSelf,TokenHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenThreadToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenThreadTokenEx(HANDLE ThreadHandle, ACCESS_MASK DesiredAccess, BOOLEAN OpenAsSelf, ULONG HandleAttributes, PHANDLE TokenHandle) {
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwOpenThreadTokenEx \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenThreadTokenEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenThreadTokenEx(ThreadHandle,DesiredAccess,OpenAsSelf,HandleAttributes,TokenHandle);;
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenThreadTokenEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenKey(PHANDLE KeyHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwOpenKey \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenKey(KeyHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAllocateVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddresss, ULONG ZeroBits, PULONG AllocationSize, ULONG AllocationType, ULONG Protect){
	NTSTATUS ntStatus;
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	ntStatus = oldZwAllocateVirtualMemory(ProcessHandle,BaseAddresss,ZeroBits,AllocationSize,AllocationType,Protect);
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAllocateVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);
	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	//ntStatus = oldZwAllocateVirtualMemory(ProcessHandle,*BaseAddresss,ZeroBits,AllocationSize,AllocationType,Protect);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAllocateVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");

	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {

		driverWriteFile(&uFullString, &uProcess);

	}

	return ntStatus;
}
NTSTATUS newZwProtectVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddresss, PULONG ProtectSize, ULONG NewProtect, PULONG OldProtect){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwProtectVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwProtectVirtualMemory(ProcessHandle,BaseAddresss,ProtectSize,NewProtect,OldProtect);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwProtectVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationToken(HANDLE TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, PVOID TokenInformation, ULONG TokenInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwQueryInformationToken \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInformationToken(TokenHandle,TokenInformationClass,TokenInformation,TokenInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwEnumerateKey(HANDLE KeyHandle, ULONG Index, KEY_INFORMATION_CLASS KeyInformationClass, PVOID KeyInformation, ULONG KeyInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwEnumerateKey \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwEnumerateKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwEnumerateKey(KeyHandle,Index,KeyInformationClass,KeyInformation,KeyInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwEnumerateKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFlushInstructionCache(HANDLE ProcessHandle, PVOID BaseAddresss, ULONG FlushSize){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwFlushInstructionCache \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFlushInstructionCache,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFlushInstructionCache(ProcessHandle,BaseAddresss,FlushSize);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFlushInstructionCache.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySecurityObject(HANDLE Handle, SECURITY_INFORMATION SecurityInformation, PSECURITY_DESCRIPTOR SecurityDescriptor, ULONG SecurityDescriptorLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwQuerySecurityObject \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySecurityObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySecurityObject(Handle,SecurityInformation,SecurityDescriptor,SecurityDescriptorLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySecurityObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryDefaultLocale(BOOLEAN ThreadOrSystem, PLCID Locale){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwQueryDefaultLocale \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryDefaultLocale,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryDefaultLocale(ThreadOrSystem,Locale);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryDefaultLocale.txt\0");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		DbgPrint("I shoudln't get here \r\n");
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySystemTime(PLARGE_INTEGER CurrentTime){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwQuerySystemTime \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySystemTime,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySystemTime(CurrentTime);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySystemTime.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenSection(PHANDLE SectionHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwOpenSection \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenSection,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenSection(SectionHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenSection.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationProcess(HANDLE ProcessHandle, PROCESSINFOCLASS ProcessInformationClass, PVOID ProcessInformation, ULONG ProcessInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwSetInformationProcess \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");

	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationProcess(ProcessHandle,ProcessInformationClass,ProcessInformation,ProcessInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationProcess(HANDLE ProcessHandle, PROCESSINFOCLASS ProcessInformationClass, PVOID ProcessInformation, ULONG ProcessInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	

	
	ANSI_STRING ansiTime;
	counter+=1;
	if (ProcessInformationClass == ProcessImageFileName) {
		ntStatus = oldZwQueryInformationProcess(ProcessHandle,ProcessInformationClass, ProcessInformation,ProcessInformationLength,ReturnLength);
	}
	else if ((ReturnLength!=NULL) && ((*ReturnLength) == 1234567890L)) {
		ntStatus = oldZwQueryInformationProcess(ProcessHandle,ProcessInformationClass, ProcessInformation,ProcessInformationLength,NULL);
	}
	else {
		UNICODE_STRING uProcess = {0};
		UNICODE_STRING uFullString = {0};
		UNICODE_STRING uTime = {0};
		UNICODE_STRING uPid= {0};
		
		uProcess.MaximumLength = 150 * sizeof(WCHAR);
		uFullString.MaximumLength = 950 * sizeof(WCHAR);
		uPid.MaximumLength = 70 * sizeof(WCHAR);
	
		uPid.Length = 0;
		uProcess.Length = 0;
		uFullString.Length = 0;
		
		pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
		processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
		if (fullString == NULL) {
			DbgPrint("I was null in newZwQueryInformationProcess \r\n");
			fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
		}	
		
		uProcess.Buffer = processString;
		uFullString.Buffer = fullString;
		uPid.Buffer = pidBuffer;
		
		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		pid = getPIDByHandle(NtCurrentProcess());
		RtlIntegerToUnicodeString(pid, 10, &uPid);
		RtlAppendUnicodeToString(&uFullString, L"Pid=");
		RtlAppendUnicodeStringToString(&uFullString, &uPid);
		RtlAppendUnicodeToString(&uFullString, L",");		
		
		//getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationProcess,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);

		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwQueryInformationProcess(ProcessHandle,ProcessInformationClass,ProcessInformation,ProcessInformationLength,ReturnLength);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationProcess.txt");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
		
		//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
		if (WRITE_DIRECT == 0) {
			Irp = IoAllocateIrp((CCHAR) 1, FALSE);
			if (Irp != NULL) {
				Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
				Irp->AssociatedIrp.SystemBuffer = processString;
				Irp->UserBuffer = fullString;
				stackLoc = IoGetNextIrpStackLocation(Irp);
				stackLoc->MajorFunction = IRP_MJ_WRITE;
				stackLoc->MinorFunction = 0;
				if (buddyDevice != NULL) {
					IoCallDriver(buddyDevice, Irp);
				}
				IoFreeIrp(Irp);
			}
		}
		else {
			driverWriteFile(&uFullString, &uProcess);
		}
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(timeBuffer);
		ExFreePool(pidBuffer);
		
	}
	return ntStatus;
}	
NTSTATUS newZwGetContextThread(HANDLE ThreadHandle, PCONTEXT Context){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwGetContextThread \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwGetContextThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwGetContextThread(ThreadHandle,Context);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwGetContextThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateProfile(PHANDLE ProfileHandle, HANDLE ProcessHandle, PVOID Base, ULONG Size, ULONG BucketShift, PULONG Buffer, ULONG BufferLength, KPROFILE_SOURCE Source, ULONG ProcessorMask){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwCreateProfile \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateProfile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateProfile(ProfileHandle,ProcessHandle,Base,Size,BucketShift,Buffer,BufferLength,Source,ProcessorMask);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateProfile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwStartProfile(HANDLE ProfileHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwStartProfile \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwStartProfile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwStartProfile(ProfileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwStartProfile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheck(PSECURITY_DESCRIPTOR SecurityDescriptor, HANDLE TokenHandle, ACCESS_MASK DesiredAccess, PGENERIC_MAPPING GenericMapping, PPRIVILEGE_SET PrivilegeSet, PULONG PrivilegeSetLength, PACCESS_MASK GrantedAccess, PBOOLEAN AccessStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];

	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid = {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR)*70, 'pibf');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwAccessCheck \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheck,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheck(SecurityDescriptor,TokenHandle,DesiredAccess,GenericMapping,PrivilegeSet,PrivilegeSetLength,GrantedAccess,AccessStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheck.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckAndAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, PUNICODE_STRING ObjectTypeName, PUNICODE_STRING ObjectName, PSECURITY_DESCRIPTOR SecurityDescriptor, PGENERIC_MAPPING GenericMapping, BOOLEAN ObjectCreation, PACCESS_MASK GrantedAccess, PBOOLEAN AccessStatus, PBOOLEAN GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwAccessCheckAndAuditAlarm \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckAndAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckAndAuditAlarm(SubsystemName,HandleId,ObjectTypeName,ObjectName,SecurityDescriptor,GenericMapping,ObjectCreation,GrantedAccess,AccessStatus,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckAndAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSystemInformation(SYSTEM_INFORMATION_CLASS SystemInformationClass, PVOID SystemInformation){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwSetSystemInformation \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSystemInformation,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSystemInformation(SystemInformationClass,SystemInformation);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSystemInformation.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwGetPlugPlayEvent(ULONG Reserved1, ULONG Reserved2, PVOID Buffer, ULONG BufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uProcess.Length = 0;
	uFullString.Length = 0;
	uPid.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'pibf');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwGetPlugPlayEvent \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwGetPlugPlayEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwGetPlugPlayEvent(Reserved1,Reserved2,Buffer,BufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwGetPlugPlayEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPlugPlayControl(ULONG ControlCode, PVOID Buffer, ULONG BufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	char aPid[70];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwPlugPlayControl \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPlugPlayControl,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPlugPlayControl(ControlCode,Buffer,BufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPlugPlayControl.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwLockVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddress, PULONG LockSize, ULONG LockType){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLockVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLockVirtualMemory(ProcessHandle,BaseAddress,LockSize,LockType);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLockVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnlockVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddress, PULONG LockSize, ULONG LockType){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnlockVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnlockVirtualMemory(ProcessHandle,BaseAddress,LockSize,LockType);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnlockVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFlushVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddress, PULONG FlushSize, PIO_STATUS_BLOCK IoStatusBlock){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFlushVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFlushVirtualMemory(ProcessHandle,BaseAddress,FlushSize,IoStatusBlock);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFlushVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAllocateUserPhysicalPages(HANDLE ProcessHandle, PULONG NumberOfPages, PULONG PageFrameNumbers){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAllocateUserPhysicalPages,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAllocateUserPhysicalPages(ProcessHandle,NumberOfPages,PageFrameNumbers);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAllocateUserPhysicalPages.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFreeUserPhysicalPages(HANDLE ProcessHandle, PULONG NumberOfPages, PULONG PageFrameNumbers){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFreeUserPhysicalPages,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFreeUserPhysicalPages(ProcessHandle,NumberOfPages,PageFrameNumbers);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFreeUserPhysicalPages.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwMapUserPhysicalPages(PVOID BaseAddress, PULONG NumberOfPages, PULONG PageFrameNumbers){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapUserPhysicalPages,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwMapUserPhysicalPages(BaseAddress,NumberOfPages,PageFrameNumbers);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapUserPhysicalPages.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwMapUserPhysicalPagesScatter(PVOID *BaseAddress, PULONG NumberOfPages, PULONG PageFrameNumbers){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMapUserPhysicalPagesScatter,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwMapUserPhysicalPagesScatter(BaseAddress,NumberOfPages,PageFrameNumbers);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapUserPhysicalPagesScatter.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwGetWriteWatch(HANDLE ProcessHandle, ULONG Flags, PVOID BaseAddress, ULONG RegionSize, PULONG Buffer, PULONG BufferEntries, PULONG Granularity){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwGetWriteWatch,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwGetWriteWatch(ProcessHandle,Flags,BaseAddress,RegionSize,Buffer,BufferEntries,Granularity);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwGetWriteWatch.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwResetWriteWatch(HANDLE ProcessHandle, PVOID BaseAddress, ULONG RegionSize){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwResetWriteWatch,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwResetWriteWatch(ProcessHandle,BaseAddress,RegionSize);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwResetWriteWatch.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}

NTSTATUS newZwFreeVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddress, PULONG FreeSize, ULONG FreeType){
	NTSTATUS ntStatus;
	ULONG pid;
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	ANSI_STRING ansiTime;
	WCHAR processString[150];	
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	char aTime[150];

	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	ntStatus = oldZwFreeVirtualMemory(ProcessHandle,BaseAddress,FreeSize,FreeType);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFreeVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFreeVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	
	return ntStatus;
}		
NTSTATUS newZwQueryVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, MEMORY_INFORMATION_CLASS MemoryInformationClass, PVOID MemoryInformation, ULONG MemoryInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	ntStatus = oldZwQueryVirtualMemory(ProcessHandle,BaseAddress,MemoryInformationClass,MemoryInformation,MemoryInformationLength,ReturnLength);
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	return ntStatus;
}		
NTSTATUS newZwReadVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG BufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	ntStatus = oldZwReadVirtualMemory(ProcessHandle,BaseAddress,Buffer,BufferLength,ReturnLength);
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReadVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReadVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	return ntStatus;
}		
NTSTATUS newZwWriteVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG BufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	ntStatus = oldZwWriteVirtualMemory(ProcessHandle,BaseAddress,Buffer,BufferLength,ReturnLength);
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWriteVirtualMemory,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWriteVirtualMemory.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	return ntStatus;
}		
NTSTATUS newZwCreateFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, PLARGE_INTEGER AllocationSize, ULONG FileAttributes, ULONG ShareAccess, ULONG CreateDisposition, ULONG CreateOptions, PVOID EaBuffer, ULONG EaLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,AllocationSize,FileAttributes,ShareAccess,CreateDisposition,CreateOptions,EaBuffer,EaLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, ULONG ShareAccess, ULONG OpenOptions){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	UNICODE_STRING compString;
	ULONG pid;
	size_t expectedLength;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	
	ANSI_STRING ansiTime;
	counter+=1;
	
	expectedLength = sizeof(WCHAR) * 27;
	//DbgPrint("ObjectAttributes: %wZ \r\n", ObjectAttributes->ObjectName);
	
	//expectedLength = memcmp(ObjectAttributes->ObjectName->Buffer, L"\\SystemRoot\\d\\", sizeof(WCHAR) * 14); 
	if (OpenOptions == 1234567L) {
		//DbgPrint("Expected Length %u \r\n", expectedLength);
		return oldZwOpenFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,ShareAccess, FILE_SYNCHRONOUS_IO_ALERT);
	}
	else {	
	
		uProcess.MaximumLength = 150 * sizeof(WCHAR);
		uFullString.MaximumLength = 950 * sizeof(WCHAR);
		uPid.MaximumLength = 70 * sizeof(WCHAR);
		
		uPid.Length = 0;	
		uProcess.Length = 0;
		uFullString.Length = 0;
		
		pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
		processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
		if (fullString == NULL) {
			DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
			fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
		}	
		
		uProcess.Buffer = processString;
		uFullString.Buffer = fullString;
		uPid.Buffer = pidBuffer;
		
		
		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		pid = getPIDByHandle(NtCurrentProcess());
		RtlIntegerToUnicodeString(pid, 10, &uPid);
		RtlAppendUnicodeToString(&uFullString, L"Pid=");
		RtlAppendUnicodeStringToString(&uFullString, &uPid);
		RtlAppendUnicodeToString(&uFullString, L",");	
		
		getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenFile,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);

		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwOpenFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,ShareAccess,OpenOptions);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenFile.txt");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
		
		//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
		if (WRITE_DIRECT == 0) {
			Irp = IoAllocateIrp((CCHAR) 1, FALSE);
			if (Irp != NULL) {
				Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
				Irp->AssociatedIrp.SystemBuffer = processString;
				Irp->UserBuffer = fullString;
				stackLoc = IoGetNextIrpStackLocation(Irp);
				stackLoc->MajorFunction = IRP_MJ_WRITE;
				stackLoc->MinorFunction = 0;
				if (buddyDevice != NULL) {
					IoCallDriver(buddyDevice, Irp);
				}
				IoFreeIrp(Irp);
			}
		}
		else {
			driverWriteFile(&uFullString, &uProcess);
		}
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(timeBuffer);
		ExFreePool(pidBuffer);
		return ntStatus;
	}
}		
NTSTATUS newZwDeleteFile(POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteFile(ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFlushBuffersFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFlushBuffersFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFlushBuffersFile(FileHandle,IoStatusBlock);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFlushBuffersFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCancelIoFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCancelIoFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCancelIoFile(FileHandle,IoStatusBlock);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCancelIoFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWriteFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key){
	NTSTATUS ntStatus;
	NTSTATUS filenameStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	PWCHAR nameBuffer;
	
	ULONG pid;
	size_t expectedLength;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	UNICODE_STRING uName = {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	uName.MaximumLength = 150 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	uName.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	nameBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'kwjl');

	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	uName.Buffer = nameBuffer;
		
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}		
	filenameStatus = getFilenameByHandle(FileHandle, &uName);
	expectedLength = sizeof(WCHAR) * 27;
	//DbgPrint("ObjectAttributes: %wZ \r\n", ObjectAttributes->ObjectName);
	if (filenameStatus == STATUS_SUCCESS) {
		expectedLength = memcmp(uName.Buffer, L"\\WINDOWS\\d\\", sizeof(WCHAR) * 10); 
	}
	if ((filenameStatus == STATUS_SUCCESS) && (expectedLength == 0)) {
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(nameBuffer);
		ExFreePool(pidBuffer);
		return oldZwWriteFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,Length,ByteOffset,Key);
	}
	else {
	
		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		pid = getPIDByHandle(NtCurrentProcess());
		RtlIntegerToUnicodeString(pid, 10, &uPid);
		RtlAppendUnicodeToString(&uFullString, L"Pid=");
		RtlAppendUnicodeStringToString(&uFullString, &uPid);
		RtlAppendUnicodeToString(&uFullString, L",");	
		
		getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWriteFile,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);

		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwWriteFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,Length,ByteOffset,Key);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWriteFile.txt");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
		
		//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
		if (WRITE_DIRECT == 0) {
			Irp = IoAllocateIrp((CCHAR) 1, FALSE);
			if (Irp != NULL) {
				Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
				Irp->AssociatedIrp.SystemBuffer = processString;
				Irp->UserBuffer = fullString;
				stackLoc = IoGetNextIrpStackLocation(Irp);
				stackLoc->MajorFunction = IRP_MJ_WRITE;
				stackLoc->MinorFunction = 0;
				if (buddyDevice != NULL) {
					IoCallDriver(buddyDevice, Irp);
				}
				IoFreeIrp(Irp);
			}
		}
		else {
			driverWriteFile(&uFullString, &uProcess);
		}
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(timeBuffer);
		ExFreePool(nameBuffer);
		ExFreePool(pidBuffer);
		return ntStatus;
	}
	
}		
NTSTATUS newZwReadFileScatter(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PFILE_SEGMENT_ELEMENT Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReadFileScatter,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReadFileScatter(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,Length,ByteOffset,Key);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReadFileScatter.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWriteFileGather(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PFILE_SEGMENT_ELEMENT Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWriteFileGather,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWriteFileGather(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,Length,ByteOffset,Key);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWriteFileGather.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwLockFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PULARGE_INTEGER LockOffset, PULARGE_INTEGER LockLength, ULONG Key, BOOLEAN FailImmediately, BOOLEAN ExclusiveLock){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLockFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLockFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,LockOffset,LockLength,Key,FailImmediately,ExclusiveLock);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLockFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnlockFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PULARGE_INTEGER LockOffset, PULARGE_INTEGER LockLength, ULONG Key){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnlockFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnlockFile(FileHandle,IoStatusBlock,LockOffset,LockLength,Key);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnlockFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFsControlFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, ULONG FsControlCode, PVOID InputBuffer, ULONG InputBufferLength, PVOID OutputBuffer, ULONG OutputBufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFsControlFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFsControlFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,FsControlCode,InputBuffer,InputBufferLength,OutputBuffer,OutputBufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFsControlFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwNotifyChangeDirectoryFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PFILE_NOTIFY_INFORMATION Buffer, ULONG BufferLength, ULONG NotifyFilter, BOOLEAN WatchSubtree){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwNotifyChangeDirectoryFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwNotifyChangeDirectoryFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,Buffer,BufferLength,NotifyFilter,WatchSubtree);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwNotifyChangeDirectoryFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryEaFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PFILE_FULL_EA_INFORMATION Buffer, ULONG BufferLength, BOOLEAN ReturnSingleEntry, PFILE_GET_EA_INFORMATION EaList, ULONG EaListLength, PULONG EaIndex, BOOLEAN RestartScan){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryEaFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryEaFile(FileHandle,IoStatusBlock,Buffer,BufferLength,ReturnSingleEntry,EaList,EaListLength,EaIndex,RestartScan);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryEaFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetEaFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PFILE_FULL_EA_INFORMATION Buffer, ULONG BufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetEaFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetEaFile(FileHandle,IoStatusBlock,Buffer,BufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetEaFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateNamedPipeFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, ULONG ShareAccess, ULONG CreateDisposition, ULONG CreateOptions, BOOLEAN TypeMessage, BOOLEAN ReadmodeMessage, BOOLEAN Nonblocking, ULONG MaxInstances, ULONG InBufferSize, ULONG OutBufferSize, PLARGE_INTEGER DefaultTimeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateNamedPipeFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateNamedPipeFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,ShareAccess,CreateDisposition,CreateOptions,TypeMessage,ReadmodeMessage,Nonblocking,MaxInstances,InBufferSize,OutBufferSize,DefaultTimeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateNamedPipeFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateMailslotFile(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, ULONG CreateOptions, ULONG InBufferSize, ULONG MaxMessageSize, PLARGE_INTEGER ReadTimeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateMailslotFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateMailslotFile(FileHandle,DesiredAccess,ObjectAttributes,IoStatusBlock,CreateOptions,InBufferSize,MaxMessageSize,ReadTimeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateMailslotFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryVolumeInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID VolumeInformation, ULONG VolumeInformationLength, FS_INFORMATION_CLASS VolumeInformationClass){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryVolumeInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryVolumeInformationFile(FileHandle,IoStatusBlock,VolumeInformation,VolumeInformationLength,VolumeInformationClass);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryVolumeInformationFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetVolumeInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID Buffer, ULONG BufferLength, FS_INFORMATION_CLASS VolumeInformationClass){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetVolumeInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetVolumeInformationFile(FileHandle,IoStatusBlock,Buffer,BufferLength,VolumeInformationClass);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetVolumeInformationFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryQuotaInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PFILE_USER_QUOTA_INFORMATION Buffer, ULONG BufferLength, BOOLEAN ReturnSingleEntry, PFILE_QUOTA_LIST_INFORMATION QuotaList, ULONG QuotaListLength, PSID ResumeSid, BOOLEAN RestartScan){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryQuotaInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryQuotaInformationFile(FileHandle,IoStatusBlock,Buffer,BufferLength,ReturnSingleEntry,QuotaList,QuotaListLength,ResumeSid,RestartScan);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryQuotaInformationFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetQuotaInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PFILE_USER_QUOTA_INFORMATION Buffer, ULONG BufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetQuotaInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetQuotaInformationFile(FileHandle,IoStatusBlock,Buffer,BufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetQuotaInformationFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryAttributesFile(POBJECT_ATTRIBUTES ObjectAttributes, PFILE_BASIC_INFORMATION FileInformation){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryAttributesFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryAttributesFile(ObjectAttributes,FileInformation);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryAttributesFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryFullAttributesFile(POBJECT_ATTRIBUTES ObjectAttributes, PFILE_NETWORK_OPEN_INFORMATION FileInformation){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryFullAttributesFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryFullAttributesFile(ObjectAttributes,FileInformation);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryFullAttributesFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG FileInformationLength, FILE_INFORMATION_CLASS FileInformationClass){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	
	if (FileInformationClass == FileNameInformation) {
		return oldZwQueryInformationFile(FileHandle,IoStatusBlock,FileInformation,FileInformationLength,FileInformationClass);
	}
	else {
		uProcess.MaximumLength = 150 * sizeof(WCHAR);
		uFullString.MaximumLength = 950 * sizeof(WCHAR);
		uPid.MaximumLength = 70 * sizeof(WCHAR);
		
		uPid.Length = 0;	
		uProcess.Length = 0;
		uFullString.Length = 0;
		
		pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
		processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
		if (fullString == NULL) {
			DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
			fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
		}	
		
		uProcess.Buffer = processString;
		uFullString.Buffer = fullString;
		uPid.Buffer = pidBuffer;
		
		timeIncrement = KeQueryTimeIncrement();
		KeQueryTickCount(&currTimeStamp);
		mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
		timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
		uTime.Length = 0;
		uTime.MaximumLength = 150 * sizeof(WCHAR);
		uTime.Buffer = timeBuffer;
		RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
		RtlInitAnsiString(&ansiTime, aTime);
		RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
		RtlAppendUnicodeToString(&uFullString, L"Time=");
		RtlAppendUnicodeStringToString(&uFullString, &uTime);
		RtlAppendUnicodeToString(&uFullString, L",");
		
		pid = getPIDByHandle(NtCurrentProcess());
		RtlIntegerToUnicodeString(pid, 10, &uPid);
		RtlAppendUnicodeToString(&uFullString, L"Pid=");
		RtlAppendUnicodeStringToString(&uFullString, &uPid);
		RtlAppendUnicodeToString(&uFullString, L",");	
		
		getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
		RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationFile,"); 
		RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
		RtlAppendUnicodeStringToString(&uFullString, &uProcess);

		//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
		ntStatus = oldZwQueryInformationFile(FileHandle,IoStatusBlock,FileInformation,FileInformationLength,FileInformationClass);
		
		RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
		//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
		RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationFile.txt");
		RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
		
		//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
		if (WRITE_DIRECT == 0) {
			Irp = IoAllocateIrp((CCHAR) 1, FALSE);
			if (Irp != NULL) {
				Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
				Irp->AssociatedIrp.SystemBuffer = processString;
				Irp->UserBuffer = fullString;
				stackLoc = IoGetNextIrpStackLocation(Irp);
				stackLoc->MajorFunction = IRP_MJ_WRITE;
				stackLoc->MinorFunction = 0;
				if (buddyDevice != NULL) {
					IoCallDriver(buddyDevice, Irp);
				}
				IoFreeIrp(Irp);
			}
		}
		else {
			driverWriteFile(&uFullString, &uProcess);
		}
		ExFreePool(processString);
		ExFreePool(fullString);
		ExFreePool(timeBuffer);
		ExFreePool(pidBuffer);
		return ntStatus;
	}
}		
NTSTATUS newZwSetInformationFile(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG FileInformationLength, FILE_INFORMATION_CLASS FileInformationClass){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationFile(FileHandle,IoStatusBlock,FileInformation,FileInformationLength,FileInformationClass);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryDirectoryFile(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG FileInformationLength, FILE_INFORMATION_CLASS FileInformationClass, BOOLEAN ReturnSingleEntry, PUNICODE_STRING FileName, BOOLEAN RestartScan){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryDirectoryFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryDirectoryFile(FileHandle,Event,ApcRoutine,ApcContext,IoStatusBlock,FileInformation,FileInformationLength,FileInformationClass,ReturnSingleEntry,FileName,RestartScan);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryDirectoryFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateKey(PHANDLE KeyHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, ULONG TitleIndex, PUNICODE_STRING Class, ULONG CreateOptions, PULONG Disposition){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateKey(KeyHandle,DesiredAccess,ObjectAttributes,TitleIndex,Class,CreateOptions,Disposition);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDeleteKey(HANDLE KeyHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteKey(KeyHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFlushKey(HANDLE KeyHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFlushKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFlushKey(KeyHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFlushKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSaveKey(HANDLE KeyHandle, HANDLE FileHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSaveKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSaveKey(KeyHandle,FileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSaveKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSaveKeyEx(HANDLE KeyHandle, HANDLE FileHandle, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSaveKeyEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSaveKeyEx(KeyHandle,FileHandle,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSaveKeyEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSaveMergedKeys(HANDLE KeyHandle1, HANDLE KeyHandle2, HANDLE FileHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSaveMergedKeys,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSaveMergedKeys(KeyHandle1,KeyHandle2,FileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSaveMergedKeys.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRestoreKey(HANDLE KeyHandle, HANDLE FileHandle, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRestoreKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRestoreKey(KeyHandle,FileHandle,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRestoreKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwLoadKey(POBJECT_ATTRIBUTES KeyObjectAttributes, POBJECT_ATTRIBUTES FileObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLoadKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLoadKey(KeyObjectAttributes,FileObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLoadKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwLoadKey2(POBJECT_ATTRIBUTES KeyObjectAttributes, POBJECT_ATTRIBUTES FileObjectAttributes, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLoadKey2,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLoadKey2(KeyObjectAttributes,FileObjectAttributes,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLoadKey2.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnloadKey(POBJECT_ATTRIBUTES KeyObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnloadKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnloadKey(KeyObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnloadKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnloadKeyEx(POBJECT_ATTRIBUTES TargetKey, HANDLE Event){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnloadKeyEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnloadKeyEx(TargetKey,Event);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnloadKeyEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryOpenSubKeys(POBJECT_ATTRIBUTES KeyObjectAttributes, PULONG NumberOfKeys){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryOpenSubKeys,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryOpenSubKeys(KeyObjectAttributes,NumberOfKeys);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryOpenSubKeys.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReplaceKey(POBJECT_ATTRIBUTES NewFileObjectAttributes, HANDLE KeyHandle, POBJECT_ATTRIBUTES OldFileObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReplaceKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReplaceKey(NewFileObjectAttributes,KeyHandle,OldFileObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReplaceKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationKey(HANDLE KeyHandle, KEY_SET_INFORMATION_CLASS KeyInformationClass, PVOID KeyInformation, ULONG KeyInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationKey(KeyHandle,KeyInformationClass,KeyInformation,KeyInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryKey(HANDLE KeyHandle, KEY_INFORMATION_CLASS KeyInformationClass, PVOID KeyInformation, ULONG KeyInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryKey(KeyHandle,KeyInformationClass,KeyInformation,KeyInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwNotifyChangeKey(HANDLE KeyHandle, HANDLE EventHandle, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, ULONG NotifyFilter, BOOLEAN WatchSubtree, PVOID Buffer, ULONG BufferLength, BOOLEAN Asynchronous){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwNotifyChangeKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwNotifyChangeKey(KeyHandle,EventHandle,ApcRoutine,ApcContext,IoStatusBlock,NotifyFilter,WatchSubtree,Buffer,BufferLength,Asynchronous);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwNotifyChangeKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwNotifyChangeMultipleKeys(HANDLE KeyHandle, ULONG Flags, POBJECT_ATTRIBUTES KeyObjectAttributes, HANDLE EventHandle, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, ULONG NotifyFilter, BOOLEAN WatchSubtree, PVOID Buffer, ULONG BufferLength, BOOLEAN Asynchronous){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwNotifyChangeMultipleKeys,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwNotifyChangeMultipleKeys(KeyHandle,Flags,KeyObjectAttributes,EventHandle,ApcRoutine,ApcContext,IoStatusBlock,NotifyFilter,WatchSubtree,Buffer,BufferLength,Asynchronous);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwNotifyChangeMultipleKeys.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDeleteValueKey(HANDLE KeyHandle, PUNICODE_STRING ValueName){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteValueKey(KeyHandle,ValueName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteValueKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetValueKey(HANDLE KeyHandle, PUNICODE_STRING ValueName, ULONG TitleIndex, ULONG Type, PVOID Data, ULONG DataSize){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetValueKey(KeyHandle,ValueName,TitleIndex,Type,Data,DataSize);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetValueKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryValueKey(HANDLE KeyHandle, PUNICODE_STRING ValueName, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG KeyValueInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryValueKey(KeyHandle,ValueName,KeyValueInformationClass,KeyValueInformation,KeyValueInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryValueKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwEnumerateValueKey(HANDLE KeyHandle, ULONG Index, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG KeyValueInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwEnumerateValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwEnumerateValueKey(KeyHandle,Index,KeyValueInformationClass,KeyValueInformation,KeyValueInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwEnumerateValueKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryMultipleValueKey(HANDLE KeyHandle, PKEY_VALUE_ENTRY ValueList, ULONG NumberOfValues, PVOID Buffer, PULONG Length, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryMultipleValueKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryMultipleValueKey(KeyHandle,ValueList,NumberOfValues,Buffer,Length,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryMultipleValueKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwInitializeRegistry(BOOLEAN Setup){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwInitializeRegistry,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwInitializeRegistry(Setup);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwInitializeRegistry.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreatePort(PHANDLE PortHandle, POBJECT_ATTRIBUTES ObjectAttributes, ULONG MaxDataSize, ULONG MaxMessageSize, ULONG Reserved){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreatePort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreatePort(PortHandle,ObjectAttributes,MaxDataSize,MaxMessageSize,Reserved);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreatePort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateWaitablePort(PHANDLE PortHandle, POBJECT_ATTRIBUTES ObjectAttributes, ULONG MaxDataSize, ULONG MaxMessageSize, ULONG Reserved){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateWaitablePort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateWaitablePort(PortHandle,ObjectAttributes,MaxDataSize,MaxMessageSize,Reserved);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateWaitablePort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwConnectPort(PHANDLE PortHandle, PUNICODE_STRING PortName, PSECURITY_QUALITY_OF_SERVICE SecurityQos, PPORT_VIEW ClientView, PREMOTE_PORT_VIEW ServerView, PULONG MaxMessageLength, PVOID ConnectInformation, PULONG ConnectInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwConnectPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwConnectPort(PortHandle,PortName,SecurityQos,ClientView,ServerView,MaxMessageLength,ConnectInformation,ConnectInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwConnectPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSecureConnectPort(PHANDLE PortHandle, PUNICODE_STRING PortName, PSECURITY_QUALITY_OF_SERVICE SecurityQos, PPORT_VIEW ClientView, PSID ServerSid, PREMOTE_PORT_VIEW ServerView, PULONG MaxMessageLength, PVOID ConnectionInformation, PULONG ConnectionInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSecureConnectPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSecureConnectPort(PortHandle,PortName,SecurityQos,ClientView,ServerSid,ServerView,MaxMessageLength,ConnectionInformation,ConnectionInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSecureConnectPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwListenPort(HANDLE PortHandle, PPORT_MESSAGE Message){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwListenPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwListenPort(PortHandle,Message);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwListenPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAcceptConnectPort(PHANDLE PortHandle, PVOID PortIdentifier, PPORT_MESSAGE Message, BOOLEAN Accept, PPORT_VIEW ServerView, PREMOTE_PORT_VIEW ClientView){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAcceptConnectPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAcceptConnectPort(PortHandle,PortIdentifier,Message,Accept,ServerView,ClientView);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAcceptConnectPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCompleteConnectPort(HANDLE PortHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCompleteConnectPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCompleteConnectPort(PortHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCompleteConnectPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}	
	
NTSTATUS newZwRequestPort(HANDLE PortHandle, PPORT_MESSAGE RequestMessage){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRequestPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRequestPort(PortHandle,RequestMessage);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRequestPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReplyPort(HANDLE PortHandle, PPORT_MESSAGE ReplyMessage){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReplyPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReplyPort(PortHandle,ReplyMessage);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReplyPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReplyWaitReplyPort(HANDLE PortHandle, PPORT_MESSAGE ReplyMessage){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReplyWaitReplyPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReplyWaitReplyPort(PortHandle,ReplyMessage);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReplyWaitReplyPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReplyWaitReceivePortEx(HANDLE PortHandle, PVOID *PortContext, PPORT_MESSAGE ReplyMessage, PPORT_MESSAGE ReceiveMessage,PLARGE_INTEGER Timeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReplyWaitReceivePortEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReplyWaitReceivePortEx(PortHandle,PortContext,ReplyMessage,ReceiveMessage,Timeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReplyWaitReceivePortEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReadRequestData(HANDLE PortHandle, PPORT_MESSAGE Message, ULONG Index, PVOID Buffer, ULONG BufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReadRequestData,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReadRequestData(PortHandle,Message,Index,Buffer,BufferLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReadRequestData.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWriteRequestData(HANDLE PortHandle, PPORT_MESSAGE Message, ULONG Index, PVOID Buffer, ULONG BufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWriteRequestData,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWriteRequestData(PortHandle,Message,Index,Buffer,BufferLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWriteRequestData.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationPort(HANDLE PortHandle, PORT_INFORMATION_CLASS PortInformationClass, PVOID PortInformation, ULONG PortInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInformationPort(PortHandle,PortInformationClass,PortInformation,PortInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwImpersonateClientOfPort(HANDLE PortHandle, PPORT_MESSAGE Message){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwImpersonateClientOfPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwImpersonateClientOfPort(PortHandle,Message);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwImpersonateClientOfPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, HANDLE InheritFromProcessHandle, BOOLEAN InheritHandles, HANDLE SectionHandle, HANDLE DebugPort, HANDLE ExceptionPort){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateProcess(ProcessHandle,DesiredAccess,ObjectAttributes,InheritFromProcessHandle,InheritHandles,SectionHandle,DebugPort,ExceptionPort);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateProcessEx(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES oa, HANDLE ParentProcess, BOOLEAN InheritObjectTable, HANDLE SectionHandle, HANDLE DebugPort, HANDLE ExceptionPort, DWORD arg9){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateProcessEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateProcessEx(ProcessHandle,DesiredAccess,oa,ParentProcess,InheritObjectTable,SectionHandle,DebugPort,ExceptionPort,arg9);;
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateProcessEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenProcess(ProcessHandle,DesiredAccess,ObjectAttributes,ClientId);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwTerminateProcess(HANDLE ProcessHandle, NTSTATUS ExitStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwTerminateProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwTerminateProcess(ProcessHandle, ExitStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwTerminateProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateThread(PHANDLE ThreadHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, HANDLE ProcessHandle, PCLIENT_ID ClientId, PCONTEXT ThreadContext, PUSER_STACK UserStack, BOOLEAN CreateSuspended){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateThread(ThreadHandle,DesiredAccess,ObjectAttributes,ProcessHandle,ClientId,ThreadContext,UserStack,CreateSuspended);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenThread(PHANDLE ThreadHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenThread(ThreadHandle,DesiredAccess,ObjectAttributes,ClientId);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwTerminateThread(HANDLE ThreadHandle, NTSTATUS ExitStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwTerminateThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwTerminateThread(ThreadHandle,ExitStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwTerminateThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationThread(HANDLE ThreadHandle, THREADINFOCLASS ThreadInformationClass, PVOID ThreadInformation, ULONG ThreadInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInformationThread(ThreadHandle,ThreadInformationClass,ThreadInformation,ThreadInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationThread(HANDLE ThreadHandle, THREADINFOCLASS ThreadInformationClass, PVOID ThreadInformation, ULONG ThreadInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationThread(ThreadHandle,ThreadInformationClass,ThreadInformation,ThreadInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSuspendThread(HANDLE ThreadHandle, PULONG PreviousSuspendCount){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSuspendThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSuspendThread(ThreadHandle,PreviousSuspendCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSuspendThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwResumeThread(HANDLE ThreadHandle, PULONG PreviousSuspendCount){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwResumeThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwResumeThread(ThreadHandle,PreviousSuspendCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwResumeThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueueApcThread(HANDLE ThreadHandle, PKNORMAL_ROUTINE ApcRoutine, PVOID ApcContext, PVOID Argument1, PVOID Argument2){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueueApcThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueueApcThread(ThreadHandle,ApcRoutine,ApcContext,Argument1,Argument2);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueueApcThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		

NTSTATUS newZwTestAlert(){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwTestAlert,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwTestAlert();
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwTestAlert.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAlertThread(HANDLE ThreadHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAlertThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAlertThread(ThreadHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAlertThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAlertResumeThread(HANDLE ThreadHandle, PULONG PreviousSuspendCount){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAlertResumeThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAlertResumeThread(ThreadHandle,PreviousSuspendCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAlertResumeThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRegisterThreadTerminatePort(HANDLE PortHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRegisterThreadTerminatePort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRegisterThreadTerminatePort(PortHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRegisterThreadTerminatePort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwImpersonateThread(HANDLE ThreadHandle, HANDLE TargetThreadHandle, PSECURITY_QUALITY_OF_SERVICE SecurityQos){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwImpersonateThread,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwImpersonateThread(ThreadHandle,TargetThreadHandle,SecurityQos);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwImpersonateThread.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwImpersonateAnonymousToken(HANDLE ThreadHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwImpersonateAnonymousToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwImpersonateAnonymousToken(ThreadHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwImpersonateAnonymousToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySystemEnvironmentValue(PUNICODE_STRING Name, PVOID Value, ULONG ValueLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySystemEnvironmentValue,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySystemEnvironmentValue(Name,Value,ValueLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySystemEnvironmentValue.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySystemEnvironmentValueEx(PUNICODE_STRING name, LPGUID vendor, PVOID value, PULONG retlength, PULONG attrib){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySystemEnvironmentValueEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySystemEnvironmentValueEx(name,vendor,value,retlength,attrib);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySystemEnvironmentValueEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSystemEnvironmentValue(PUNICODE_STRING Name, PUNICODE_STRING Value){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSystemEnvironmentValue,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSystemEnvironmentValue(Name,Value);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSystemEnvironmentValue.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSystemEnvironmentValueEx(PUNICODE_STRING VariableName, LPGUID VendorGuid, PVOID Value, ULONG ValueLength, ULONG Attributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSystemEnvironmentValueEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSystemEnvironmentValueEx(VariableName,VendorGuid,Value,ValueLength,Attributes);;
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSystemEnvironmentValueEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwShutdownSystem(SHUTDOWN_ACTION Action){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwShutdownSystem,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwShutdownSystem(Action);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwShutdownSystem.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSystemDebugControl(DEBUG_CONTROL_CODE ControlCode, PVOID InputBuffer, ULONG InputBufferLength, PVOID OutputBuffer, ULONG OutputBufferLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSystemDebugControl,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSystemDebugControl(ControlCode,InputBuffer,InputBufferLength,OutputBuffer,OutputBufferLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSystemDebugControl.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryObject(HANDLE ObjectHandle, OBJECT_INFORMATION_CLASS ObjectInformationClass, PVOID ObjectInformation, ULONG ObjectInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryObject(ObjectHandle,ObjectInformationClass,ObjectInformation,ObjectInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationObject(HANDLE ObjectHandle, OBJECT_INFORMATION_CLASS ObjectInformationClass, PVOID ObjectInformation, ULONG ObjectInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationObject(ObjectHandle,ObjectInformationClass,ObjectInformation,ObjectInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDuplicateObject(HANDLE SourceProcessHandle, HANDLE SourceHandle, HANDLE TargetProcessHandle, PHANDLE TargetHandle, ACCESS_MASK DesiredAccess, ULONG Attributes, ULONG Options){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDuplicateObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDuplicateObject(SourceProcessHandle,SourceHandle,TargetProcessHandle,TargetHandle,DesiredAccess,Attributes,Options);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDuplicateObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwMakeTemporaryObject(HANDLE Handle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwMakeTemporaryObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwMakeTemporaryObject(Handle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMakeTemporaryObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSecurityObject(HANDLE Handle, SECURITY_INFORMATION SecurityInformation, PSECURITY_DESCRIPTOR SecurityDescriptor){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSecurityObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSecurityObject(Handle,SecurityInformation,SecurityDescriptor);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSecurityObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateDirectoryObject(PHANDLE DirectoryHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateDirectoryObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateDirectoryObject(DirectoryHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateDirectoryObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenDirectoryObject(PHANDLE DirectoryHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenDirectoryObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenDirectoryObject(DirectoryHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenDirectoryObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryDirectoryObject(HANDLE DirectoryHandle, PVOID Buffer, ULONG BufferLength, BOOLEAN ReturnSingleEntry, BOOLEAN RestartScan, PULONG Context, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryDirectoryObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryDirectoryObject(DirectoryHandle,Buffer,BufferLength,ReturnSingleEntry,RestartScan,Context,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryDirectoryObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateSymbolicLinkObject(PHANDLE SymbolicLinkHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PUNICODE_STRING TargetName){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateSymbolicLinkObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateSymbolicLinkObject(SymbolicLinkHandle,DesiredAccess,ObjectAttributes,TargetName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateSymbolicLinkObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenSymbolicLinkObject(PHANDLE SymbolicLinkHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenSymbolicLinkObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenSymbolicLinkObject(SymbolicLinkHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenSymbolicLinkObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySymbolicLinkObject(HANDLE SymbolicLinkHandle, PUNICODE_STRING TargetName, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySymbolicLinkObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySymbolicLinkObject(SymbolicLinkHandle,TargetName,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySymbolicLinkObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateSection(PHANDLE SectionHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PLARGE_INTEGER SectionSize, ULONG Protect, ULONG Attributes, HANDLE FileHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateSection,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateSection(SectionHandle,DesiredAccess,ObjectAttributes,SectionSize,Protect,Attributes,FileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateSection.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySection(HANDLE SectionHandle, SECTION_INFORMATION_CLASS SectionInformationClass, PVOID SectionInformation, ULONG SectionInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySection,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySection(SectionHandle,SectionInformationClass,SectionInformation,SectionInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySection.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwExtendSection(HANDLE SectionHandle, PLARGE_INTEGER SectionSize){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwExtendSection,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwExtendSection(SectionHandle,SectionSize);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwExtendSection.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnmapViewOfSection(HANDLE ProcessHandle, PVOID BaseAddress){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnmapViewOfSection,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnmapViewOfSection(ProcessHandle,BaseAddress);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnmapViewOfSection.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAreMappedFilesTheSame(PVOID Address1, PVOID Address2){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAreMappedFilesTheSame,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAreMappedFilesTheSame(Address1,Address2);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAreMappedFilesTheSame.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateJobObject(PHANDLE JobHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateJobObject(JobHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenJobObject(PHANDLE JobHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenJobObject(JobHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwTerminateJobObject(HANDLE JobHandle, NTSTATUS ExitStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwTerminateJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwTerminateJobObject(JobHandle, ExitStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwTerminateJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAssignProcessToJobObject(HANDLE JobHandle, HANDLE ProcessHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAssignProcessToJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAssignProcessToJobObject(JobHandle,ProcessHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAssignProcessToJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationJobObject(HANDLE JobHandle, JOBOBJECTINFOCLASS JobInformationClass, PVOID JobInformation, ULONG JobInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInformationJobObject(JobHandle,JobInformationClass,JobInformation,JobInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationJobObject(HANDLE JobHandle, JOBOBJECTINFOCLASS JobInformationClass, PVOID JobInformation, ULONG JobInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationJobObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationJobObject(JobHandle,JobInformationClass,JobInformation,JobInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationJobObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateToken(PHANDLE TokenHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, TOKEN_TYPE Type, PLUID AuthenticationId, PLARGE_INTEGER ExpirationTime, PTOKEN_USER User, PTOKEN_GROUPS Groups, PTOKEN_PRIVILEGES Privileges, PTOKEN_OWNER Owner, PTOKEN_PRIMARY_GROUP PrimaryGroup, PTOKEN_DEFAULT_DACL DefaultDacl, PTOKEN_SOURCE Source){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateToken(TokenHandle,DesiredAccess,ObjectAttributes,Type,AuthenticationId,ExpirationTime,User,Groups,Privileges,Owner,PrimaryGroup,DefaultDacl,Source);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenProcessToken(HANDLE ProcessHandle, ACCESS_MASK DesiredAccess, PHANDLE TokenHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenProcessToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenProcessToken(ProcessHandle,DesiredAccess,TokenHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenProcessToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenProcessTokenEx(HANDLE ProcessHandle, ACCESS_MASK DesiredAccess, ULONG HandleAttributes, PHANDLE TokenHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenProcessTokenEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenProcessTokenEx(ProcessHandle,DesiredAccess,HandleAttributes,TokenHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenProcessTokenEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDuplicateToken(HANDLE ExistingTokenHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, BOOLEAN EffectiveOnly, TOKEN_TYPE TokenType, PHANDLE NewTokenHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDuplicateToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDuplicateToken(ExistingTokenHandle,DesiredAccess,ObjectAttributes,EffectiveOnly,TokenType,NewTokenHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDuplicateToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFilterToken(HANDLE ExistingTokenHandle, ULONG Flags, PTOKEN_GROUPS SidsToDisable, PTOKEN_PRIVILEGES PrivilegesToDelete, PTOKEN_GROUPS SidsToRestricted, PHANDLE NewTokenHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFilterToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFilterToken(ExistingTokenHandle,Flags,SidsToDisable,PrivilegesToDelete,SidsToRestricted,NewTokenHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFilterToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAdjustPrivilegesToken(HANDLE TokenHandle, BOOLEAN DisableAllPrivileges, PTOKEN_PRIVILEGES NewState, ULONG BufferLength, PTOKEN_PRIVILEGES PreviousState, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAdjustPrivilegesToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAdjustPrivilegesToken(TokenHandle,DisableAllPrivileges,NewState,BufferLength,PreviousState,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAdjustPrivilegesToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAdjustGroupsToken(HANDLE TokenHandle, BOOLEAN ResetToDefault, PTOKEN_GROUPS NewState, ULONG BufferLength, PTOKEN_GROUPS PreviousState, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAdjustGroupsToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAdjustGroupsToken(TokenHandle,ResetToDefault,NewState,BufferLength,PreviousState,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAdjustGroupsToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetInformationToken(HANDLE TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, PVOID TokenInformation, ULONG TokenInformationLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetInformationToken,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetInformationToken(TokenHandle,TokenInformationClass,TokenInformation,TokenInformationLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetInformationToken.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSignalAndWaitForSingleObject(HANDLE HandleToSignal, HANDLE HandleToWait, BOOLEAN Alertable, PLARGE_INTEGER Timeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSignalAndWaitForSingleObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSignalAndWaitForSingleObject(HandleToSignal,HandleToWait,Alertable,Timeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSignalAndWaitForSingleObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWaitForMultipleObjects(ULONG HandleCount, PHANDLE Handles, WAIT_TYPE WaitType, BOOLEAN Alertable, PLARGE_INTEGER Timeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWaitForMultipleObjects,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWaitForMultipleObjects(HandleCount,Handles,WaitType,Alertable,Timeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWaitForMultipleObjects.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateTimer(PHANDLE TimerHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, TIMER_TYPE TimerType){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateTimer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateTimer(TimerHandle,DesiredAccess,ObjectAttributes,TimerType);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateTimer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenTimer(PHANDLE TimerHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenTimer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenTimer(TimerHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenTimer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCancelTimer(HANDLE TimerHandle, PBOOLEAN PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCancelTimer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCancelTimer(TimerHandle,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCancelTimer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetTimer(HANDLE TimerHandle, PLARGE_INTEGER DueTime, PTIMER_APC_ROUTINE TimerApcRoutine, PVOID TimerContext, BOOLEAN Resume, LONG Period, PBOOLEAN PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetTimer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetTimer(TimerHandle,DueTime,TimerApcRoutine,TimerContext,Resume,Period,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetTimer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryTimer(HANDLE TimerHandle, TIMER_INFORMATION_CLASS TimerInformationClass, PVOID TimerInformation, ULONG TimerInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryTimer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryTimer(TimerHandle,TimerInformationClass,TimerInformation,TimerInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryTimer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateEvent(PHANDLE EventHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, EVENT_TYPE EventType, BOOLEAN InitialState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateEvent(EventHandle,DesiredAccess,ObjectAttributes,EventType,InitialState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenEvent(PHANDLE EventHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenEvent(EventHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPulseEvent(HANDLE EventHandle, PULONG PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPulseEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPulseEvent(EventHandle,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPulseEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwResetEvent(HANDLE EventHandle, PULONG PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwResetEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwResetEvent(EventHandle,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwResetEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwClearEvent(HANDLE EventHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwClearEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwClearEvent(EventHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwClearEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryEvent(HANDLE EventHandle, EVENT_INFORMATION_CLASS EventInformationClass, PVOID EventInformation, ULONG EventInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryEvent(EventHandle,EventInformationClass,EventInformation,EventInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateSemaphore(PHANDLE SemaphoreHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, LONG InitialCount, LONG MaximumCount){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateSemaphore,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateSemaphore(SemaphoreHandle,DesiredAccess,ObjectAttributes,InitialCount,MaximumCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateSemaphore.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenSemaphore(PHANDLE SemaphoreHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenSemaphore,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenSemaphore(SemaphoreHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenSemaphore.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReleaseSemaphore(HANDLE SemaphoreHandle, LONG ReleaseCount, PLONG PreviousCount){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReleaseSemaphore,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReleaseSemaphore(SemaphoreHandle,ReleaseCount,PreviousCount);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReleaseSemaphore.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQuerySemaphore(HANDLE SemaphoreHandle, SEMAPHORE_INFORMATION_CLASS SemaphoreInformationClass, PVOID SemaphoreInformation, ULONG SemaphoreInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQuerySemaphore,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQuerySemaphore(SemaphoreHandle,SemaphoreInformationClass,SemaphoreInformation,SemaphoreInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQuerySemaphore.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateMutant(PHANDLE MutantHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, BOOLEAN InitialOwner){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateMutant,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateMutant(MutantHandle,DesiredAccess,ObjectAttributes,InitialOwner);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateMutant.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenMutant(PHANDLE MutantHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenMutant,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenMutant(MutantHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenMutant.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwReleaseMutant(HANDLE MutantHandle, PULONG PreviousState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwReleaseMutant,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwReleaseMutant(MutantHandle,PreviousState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwReleaseMutant.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryMutant(HANDLE MutantHandle, MUTANT_INFORMATION_CLASS MutantInformationClass, PVOID MutantInformation, ULONG MutantInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryMutant,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryMutant(MutantHandle,MutantInformationClass,MutantInformation,MutantInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryMutant.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateIoCompletion(PHANDLE IoCompletionHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, ULONG NumberOfConcurrentThreads){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateIoCompletion,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateIoCompletion(IoCompletionHandle,DesiredAccess,ObjectAttributes,NumberOfConcurrentThreads);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateIoCompletion.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenIoCompletion(PHANDLE IoCompletionHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenIoCompletion,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenIoCompletion(IoCompletionHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenIoCompletion.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetIoCompletion(HANDLE IoCompletionHandle, ULONG CompletionKey, ULONG CompletionValue, NTSTATUS Status, ULONG Information){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetIoCompletion,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetIoCompletion(IoCompletionHandle,CompletionKey,CompletionValue,Status,Information);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetIoCompletion.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRemoveIoCompletion(HANDLE IoCompletionHandle, PULONG CompletionKey, PULONG CompletionValue, PIO_STATUS_BLOCK IoStatusBlock, PLARGE_INTEGER Timeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRemoveIoCompletion,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRemoveIoCompletion(IoCompletionHandle,CompletionKey,CompletionValue,IoStatusBlock,Timeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRemoveIoCompletion.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryIoCompletion(HANDLE IoCompletionHandle, IO_COMPLETION_INFORMATION_CLASS IoCompletionInformationClass, PVOID IoCompletionInformation, ULONG IoCompletionInformationLength, PULONG ResultLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryIoCompletion,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryIoCompletion(IoCompletionHandle,IoCompletionInformationClass,IoCompletionInformation,IoCompletionInformationLength,ResultLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryIoCompletion.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreateEventPair(PHANDLE EventPairHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreateEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreateEventPair(EventPairHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreateEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenEventPair(PHANDLE EventPairHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenEventPair(EventPairHandle,DesiredAccess,ObjectAttributes);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWaitLowEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWaitLowEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWaitLowEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWaitLowEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwWaitHighEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwWaitHighEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwWaitHighEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwWaitHighEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetLowWaitHighEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetLowWaitHighEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetLowWaitHighEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetLowWaitHighEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetHighWaitLowEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetHighWaitLowEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetHighWaitLowEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetHighWaitLowEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetLowEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetLowEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetLowEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetLowEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetHighEventPair(HANDLE EventPairHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetHighEventPair,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetHighEventPair(EventPairHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetHighEventPair.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSystemTime(PLARGE_INTEGER NewTime, PLARGE_INTEGER OldTime){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSystemTime,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSystemTime(NewTime,OldTime);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSystemTime.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryPerformanceCounter(PLARGE_INTEGER PerformanceCount, PLARGE_INTEGER PerformanceFrequency){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryPerformanceCounter,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryPerformanceCounter(PerformanceCount,PerformanceFrequency);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryPerformanceCounter.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetTimerResolution(ULONG RequestedResolution, BOOLEAN Set, PULONG ActualResolution){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetTimerResolution,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetTimerResolution(RequestedResolution,Set,ActualResolution);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetTimerResolution.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryTimerResolution(PULONG CoarsestResolution, PULONG FinestResolution, PULONG ActualResolution){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryTimerResolution,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryTimerResolution(CoarsestResolution,FinestResolution,ActualResolution);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryTimerResolution.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwYieldExecution(){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwYieldExecution,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwYieldExecution();
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwYieldExecution.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetIntervalProfile(ULONG Interval, KPROFILE_SOURCE Source){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetIntervalProfile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetIntervalProfile(Interval,Source);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetIntervalProfile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryIntervalProfile(KPROFILE_SOURCE Source, PULONG Interval){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryIntervalProfile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryIntervalProfile(Source,Interval);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryIntervalProfile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwStopProfile(HANDLE ProfileHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwStopProfile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwStopProfile(ProfileHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwStopProfile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPrivilegeCheck(HANDLE TokenHandle, PPRIVILEGE_SET RequiredPrivileges, PBOOLEAN Result){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPrivilegeCheck,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPrivilegeCheck(TokenHandle,RequiredPrivileges,Result);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPrivilegeCheck.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPrivilegeObjectAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, HANDLE TokenHandle, ACCESS_MASK DesiredAccess, PPRIVILEGE_SET Privileges, BOOLEAN AccessGranted){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPrivilegeObjectAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPrivilegeObjectAuditAlarm(SubsystemName,HandleId,TokenHandle,DesiredAccess,Privileges,AccessGranted);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPrivilegeObjectAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPrivilegedServiceAuditAlarm(PUNICODE_STRING SubsystemName, PUNICODE_STRING ServiceName, HANDLE TokenHandle, PPRIVILEGE_SET Privileges, BOOLEAN AccessGranted){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPrivilegedServiceAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPrivilegedServiceAuditAlarm(SubsystemName,ServiceName,TokenHandle,Privileges,AccessGranted);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPrivilegedServiceAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckByType(PSECURITY_DESCRIPTOR SecurityDescriptor, PSID PrincipalSelfSid, HANDLE TokenHandle, ULONG DesiredAccess, POBJECT_TYPE_LIST ObjectTypeList, ULONG ObjectTypeListLength, PGENERIC_MAPPING GenericMapping, PPRIVILEGE_SET PrivilegeSet, PULONG PrivilegeSetLength, PACCESS_MASK GrantedAccess, PULONG AccessStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckByType,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckByType(SecurityDescriptor,PrincipalSelfSid,TokenHandle,DesiredAccess,ObjectTypeList,ObjectTypeListLength,GenericMapping,PrivilegeSet,PrivilegeSetLength,GrantedAccess,AccessStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckByType.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckByTypeAndAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, PUNICODE_STRING ObjectTypeName, PUNICODE_STRING ObjectName, PSECURITY_DESCRIPTOR SecurityDescriptor, PSID PrincipalSelfSid, ACCESS_MASK DesiredAccess, AUDIT_EVENT_TYPE AuditType, ULONG Flags, POBJECT_TYPE_LIST ObjectTypeList, ULONG ObjectTypeListLength, PGENERIC_MAPPING GenericMapping, BOOLEAN ObjectCreation, PACCESS_MASK GrantedAccess, PULONG AccessStatus, PBOOLEAN GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckByTypeAndAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckByTypeAndAuditAlarm(SubsystemName,HandleId,ObjectTypeName,ObjectName,SecurityDescriptor,PrincipalSelfSid,DesiredAccess,AuditType,Flags,ObjectTypeList,ObjectTypeListLength,GenericMapping,ObjectCreation,GrantedAccess,AccessStatus,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckByTypeAndAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckByTypeResultList(PSECURITY_DESCRIPTOR SecurityDescriptor, PSID PrincipalSelfSid, HANDLE TokenHandle, ACCESS_MASK DesiredAccess, POBJECT_TYPE_LIST ObjectTypeList, ULONG ObjectTypeListLength, PGENERIC_MAPPING GenericMapping, PPRIVILEGE_SET PrivilegeSet, PULONG PrivilegeSetLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckByTypeResultList,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckByTypeResultList(SecurityDescriptor,PrincipalSelfSid,TokenHandle,DesiredAccess,ObjectTypeList,ObjectTypeListLength,GenericMapping,PrivilegeSet,PrivilegeSetLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultList.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckByTypeResultListAndAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, PUNICODE_STRING ObjectTypeName, PUNICODE_STRING ObjectName, PSECURITY_DESCRIPTOR SecurityDescriptor, PSID PrincipalSelfSid, ACCESS_MASK DesiredAccess, AUDIT_EVENT_TYPE AuditType, ULONG Flags, POBJECT_TYPE_LIST ObjectTypeList, ULONG ObjectTypeListLength, PGENERIC_MAPPING GenericMapping, BOOLEAN ObjectCreation, PACCESS_MASK GrantedAccessList, PULONG AccessStatusList, PULONG GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckByTypeResultListAndAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckByTypeResultListAndAuditAlarm(SubsystemName,HandleId,ObjectTypeName,ObjectName,SecurityDescriptor,PrincipalSelfSid,DesiredAccess,AuditType,Flags,ObjectTypeList,ObjectTypeListLength,GenericMapping,ObjectCreation,GrantedAccessList,AccessStatusList,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultListAndAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAccessCheckByTypeResultListAndAuditAlarmByHandle(PUNICODE_STRING SubsystemName, PVOID HandleId, HANDLE TokenHandle, PUNICODE_STRING ObjectTypeName, PUNICODE_STRING ObjectName, PSECURITY_DESCRIPTOR SecurityDescriptor, PSID PrincipalSelfSid, ACCESS_MASK DesiredAccess, AUDIT_EVENT_TYPE AuditType, ULONG Flags, POBJECT_TYPE_LIST ObjectTypeList, ULONG ObjectTypeListLength, PGENERIC_MAPPING GenericMapping, BOOLEAN ObjectCreation, PACCESS_MASK GrantedAccessList, PULONG AccessStatusList, PULONG GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAccessCheckByTypeResultListAndAuditAlarmByHandle,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAccessCheckByTypeResultListAndAuditAlarmByHandle(SubsystemName,HandleId,TokenHandle,ObjectTypeName,ObjectName,SecurityDescriptor,PrincipalSelfSid,DesiredAccess,AuditType,Flags,ObjectTypeList,ObjectTypeListLength,GenericMapping,ObjectCreation,GrantedAccessList,AccessStatusList,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAccessCheckByTypeResultListAndAuditAlarmByHandle.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwOpenObjectAuditAlarm(PUNICODE_STRING SubsystemName, PVOID *HandleId, PUNICODE_STRING ObjectTypeName, PUNICODE_STRING ObjectName, PSECURITY_DESCRIPTOR SecurityDescriptor, HANDLE TokenHandle, ACCESS_MASK DesiredAccess, ACCESS_MASK GrantedAccess, PPRIVILEGE_SET Privileges, BOOLEAN ObjectCreation, BOOLEAN AccessGranted, PBOOLEAN GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwOpenObjectAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwOpenObjectAuditAlarm(SubsystemName,HandleId,ObjectTypeName,ObjectName,SecurityDescriptor,TokenHandle,DesiredAccess,GrantedAccess,Privileges,ObjectCreation,AccessGranted,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwOpenObjectAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCloseObjectAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, BOOLEAN GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCloseObjectAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCloseObjectAuditAlarm(SubsystemName,HandleId,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCloseObjectAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDeleteObjectAuditAlarm(PUNICODE_STRING SubsystemName, PVOID HandleId, BOOLEAN GenerateOnClose){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteObjectAuditAlarm,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteObjectAuditAlarm(SubsystemName,HandleId,GenerateOnClose);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteObjectAuditAlarm.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRequestWakeupLatency(LATENCY_TIME Latency){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRequestWakeupLatency,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRequestWakeupLatency(Latency);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRequestWakeupLatency.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRequestDeviceWakeup(HANDLE DeviceHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRequestDeviceWakeup,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRequestDeviceWakeup(DeviceHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRequestDeviceWakeup.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCancelDeviceWakeupRequest(HANDLE DeviceHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCancelDeviceWakeupRequest,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCancelDeviceWakeupRequest(DeviceHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCancelDeviceWakeupRequest.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwIsSystemResumeAutomatic(){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwIsSystemResumeAutomatic,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwIsSystemResumeAutomatic();
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwIsSystemResumeAutomatic.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetThreadExecutionState(EXECUTION_STATE ExecutionState, PEXECUTION_STATE PreviousExecutionState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetThreadExecutionState,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetThreadExecutionState(ExecutionState,PreviousExecutionState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetThreadExecutionState.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwGetDevicePowerState(HANDLE DeviceHandle, PDEVICE_POWER_STATE DevicePowerState){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwGetDevicePowerState,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwGetDevicePowerState(DeviceHandle,DevicePowerState);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwGetDevicePowerState.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetSystemPowerState(POWER_ACTION SystemAction, SYSTEM_POWER_STATE MinSystemState, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetSystemPowerState,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetSystemPowerState(SystemAction,MinSystemState,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetSystemPowerState.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwInitiatePowerAction(POWER_ACTION SystemAction, SYSTEM_POWER_STATE MinSystemState, ULONG Flags, BOOLEAN Asynchronous){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwInitiatePowerAction,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwInitiatePowerAction(SystemAction,MinSystemState,Flags,Asynchronous);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwInitiatePowerAction.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwPowerInformation(POWER_INFORMATION_LEVEL PowerInformationLevel, PVOID InputBuffer, ULONG InputBufferLength, PVOID OutputBuffer, ULONG OutputBufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwPowerInformation,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwPowerInformation(PowerInformationLevel,InputBuffer,InputBufferLength,OutputBuffer,OutputBufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwPowerInformation.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRaiseException(PEXCEPTION_RECORD ExceptionRecord, PCONTEXT Context, BOOLEAN SearchFrames){
	NTSTATUS ntStatus;
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	ntStatus = oldZwRaiseException(ExceptionRecord,Context,SearchFrames);
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRaiseException,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRaiseException.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	return ntStatus;
}
/**NTSTATUS newZwContinue(PCONTEXT Context, BOOLEAN TestAlert){

	//NTSTATUS ntStatus;
	return oldZwContinue(Context, TestAlert);
	
	WCHAR processString[150];
	WCHAR fullString[950];
	WCHAR timeBuffer[150];
	WCHAR pidBuffer[70];
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	ntStatus = oldZwContinue(Context, TestAlert);
	/**
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	RtlInitEmptyUnicodeString(&uProcess, processString, (USHORT)sizeof(processString));
	RtlInitEmptyUnicodeString(&uFullString, fullString, (USHORT)sizeof(fullString));
	RtlInitEmptyUnicodeString(&uPid, pidBuffer, (USHORT)sizeof(pidBuffer));
	/**
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	RtlInitEmptyUnicodeString(&uTime, timeBuffer, (USHORT)sizeof(timeBuffer));
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	*/
	/**
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwContinue,");
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	/////RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwContinue.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		////driverWriteFile(&uFullString, &uProcess);
	}
	
	return ntStatus;
	
}			
*/
NTSTATUS newZwCallbackReturn(PVOID Result, ULONG ResultLength, NTSTATUS Status){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCallbackReturn,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCallbackReturn(Result,ResultLength,Status);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCallbackReturn.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwLoadDriver(PUNICODE_STRING DriverServiceName){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwLoadDriver,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwLoadDriver(DriverServiceName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwLoadDriver.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwUnloadDriver(PUNICODE_STRING DriverServiceName){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwUnloadDriver,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwUnloadDriver(DriverServiceName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwUnloadDriver.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFlushWriteBuffer(){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFlushWriteBuffer,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFlushWriteBuffer();
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFlushWriteBuffer.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetDefaultLocale(BOOLEAN ThreadOrSystem, LCID Locale){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetDefaultLocale,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetDefaultLocale(ThreadOrSystem,Locale);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetDefaultLocale.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		

NTSTATUS newZwQueryDefaultUILanguage(PLANGID LanguageId){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryDefaultUILanguage,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryDefaultUILanguage(LanguageId);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryDefaultUILanguage.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetDefaultUILanguage(LANGID LanguageId){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetDefaultUILanguage,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetDefaultUILanguage(LanguageId);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetDefaultUILanguage.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInstallUILanguage(PLANGID LanguageId){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInstallUILanguage,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInstallUILanguage(LanguageId);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInstallUILanguage.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAllocateLocallyUniqueId(PLUID Luid){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAllocateLocallyUniqueId,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAllocateLocallyUniqueId(Luid);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAllocateLocallyUniqueId.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAllocateUuids(PLARGE_INTEGER UuidLastTimeAllocated, PULONG UuidDeltaTime, PULONG UuidSequenceNumber, PUCHAR UuidSeed){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAllocateUuids,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAllocateUuids(UuidLastTimeAllocated,UuidDeltaTime,UuidSequenceNumber,UuidSeed);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAllocateUuids.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetUuidSeed(PUCHAR UuidSeed){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetUuidSeed,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetUuidSeed(UuidSeed);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetUuidSeed.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwRaiseHardError(NTSTATUS Status, ULONG NumberOfArguments, ULONG StringArgumentsMask, PULONG Arguments, HARDERROR_RESPONSE_OPTION ResponseOption, PHARDERROR_RESPONSE Response){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwRaiseHardError,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwRaiseHardError(Status,NumberOfArguments,StringArgumentsMask,Arguments,ResponseOption,Response);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwRaiseHardError.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetDefaultHardErrorPort(HANDLE PortHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetDefaultHardErrorPort,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetDefaultHardErrorPort(PortHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetDefaultHardErrorPort.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDisplayString(PUNICODE_STRING String){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDisplayString,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDisplayString(String);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDisplayString.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwCreatePagingFile(PUNICODE_STRING FileName, PULARGE_INTEGER InitialSize, PULARGE_INTEGER MaximumSize, ULONG Reserved){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwCreatePagingFile,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwCreatePagingFile(FileName,InitialSize,MaximumSize,Reserved);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwCreatePagingFile.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwAddAtom(PWSTR String, ULONG StringLength, PUSHORT Atom){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwAddAtom,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwAddAtom(String,StringLength,Atom);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwAddAtom.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwFindAtom(PWSTR String, ULONG StringLength, PUSHORT Atom){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwFindAtom,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwFindAtom(String,StringLength,Atom);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwFindAtom.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwDeleteAtom(USHORT Atom){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwDeleteAtom,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwDeleteAtom(Atom);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwDeleteAtom.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwQueryInformationAtom(USHORT Atom, ATOM_INFORMATION_CLASS AtomInformationClass, PVOID AtomInformation, ULONG AtomInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwQueryInformationAtom,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwQueryInformationAtom(Atom,AtomInformationClass,AtomInformation,AtomInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwQueryInformationAtom.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwSetLdtEntries(ULONG Selector1, LDT_ENTRY LdtEntry1, ULONG Selector2, LDT_ENTRY LdtEntry2){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwSetLdtEntries,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwSetLdtEntries(Selector1,LdtEntry1,Selector2,LdtEntry2);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwSetLdtEntries.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newZwVdmControl(ULONG ControlCode, PVOID ControlData){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=ZwVdmControl,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldZwVdmControl(ControlCode,ControlData);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwVdmControl.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtSetBootEntryOrder(PULONG Ids,PULONG Count){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtSetBootEntryOrder,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtSetBootEntryOrder(Ids,Count);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtSetBootEntryOrder.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCompactKeys(ULONG NrOfKeys, HANDLE KeysArray[]){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCompactKeys,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCompactKeys(NrOfKeys,KeysArray);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCompactKeys.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCompareTokens(HANDLE FirstTokenHandle, HANDLE SecondTokenHandle, PBOOLEAN Equal){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCompareTokens,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCompareTokens(FirstTokenHandle,SecondTokenHandle,Equal);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCompareTokens.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCompressKey(HANDLE Key){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCompressKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCompressKey(Key);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCompressKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCreateDebugObject(PHANDLE DebugObjectHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCreateDebugObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCreateDebugObject(DebugObjectHandle,DesiredAccess,ObjectAttributes,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCreateDebugObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCreateJobSet(ULONG NumJob, PJOB_SET_ARRAY UserJobSet, ULONG Flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCreateJobSet,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCreateJobSet(NumJob,UserJobSet,Flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCreateJobSet.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtDebugActiveProcess(HANDLE ProcessHandle, HANDLE DebugObjectHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtDebugActiveProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtDebugActiveProcess(ProcessHandle,DebugObjectHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtDebugActiveProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtDebugContinue(HANDLE DebugObject, PCLIENT_ID AppClientId, NTSTATUS ContinueStatus){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtDebugContinue,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtDebugContinue(DebugObject, AppClientId, ContinueStatus);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtDebugContinue.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtEnumerateSystemEnvironmentValuesEx(ULONG InformationClass, PVOID Buffer, ULONG BufferLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtEnumerateSystemEnvironmentValuesEx,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtEnumerateSystemEnvironmentValuesEx(InformationClass,Buffer,BufferLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtEnumerateSystemEnvironmentValuesEx.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtIsProcessInJob(HANDLE ProcessHandle,HANDLE JobHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtIsProcessInJob,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtIsProcessInJob(ProcessHandle,JobHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtIsProcessInJob.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtLockProductActivationKeys(PULONG pPrivateVer, PULONG pSafeMode){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtLockProductActivationKeys,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtLockProductActivationKeys(pPrivateVer,pSafeMode);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtLockProductActivationKeys.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtLockRegistryKey(HANDLE KeyHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtLockRegistryKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtLockRegistryKey(KeyHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtLockRegistryKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtMakePermanentObject(HANDLE ObjectHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtMakePermanentObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtMakePermanentObject(ObjectHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtMakePermanentObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtDeleteBootEntry(ULONG Id){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtDeleteBootEntry,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtDeleteBootEntry(Id);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtDeleteBootEntry.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtQueryDebugFilterState(ULONG ComponentId, ULONG Level){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtQueryDebugFilterState,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtQueryDebugFilterState(ComponentId,Level);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtQueryDebugFilterState.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtRemoveProcessDebug(HANDLE ProcessHandle, HANDLE DebugObjectHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtRemoveProcessDebug,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtRemoveProcessDebug(ProcessHandle,DebugObjectHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtRemoveProcessDebug.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtRenameKey(HANDLE KeyHandle, PUNICODE_STRING NewName){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtRenameKey,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtRenameKey(KeyHandle,NewName);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtRenameKey.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtResumeProcess(HANDLE ProcessHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtResumeProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtResumeProcess(ProcessHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtResumeProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtSetDebugFilterState(ULONG ComponentId, ULONG Level, BOOLEAN State){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtSetDebugFilterState,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtSetDebugFilterState(ComponentId,Level,State);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtSetDebugFilterState.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtSetEventBoostPriority(HANDLE EventHandle){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtSetEventBoostPriority,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtSetEventBoostPriority(EventHandle);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtSetEventBoostPriority.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtSetInformationDebugObject(HANDLE DebugObjectHandle, DEBUGOBJECTINFOCLASS DebugObjectInformationClass, PVOID DebugInformation, ULONG DebugInformationLength, PULONG ReturnLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtSetInformationDebugObject,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtSetInformationDebugObject(DebugObjectHandle,DebugObjectInformationClass,DebugInformation,DebugInformationLength,ReturnLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtSetInformationDebugObject.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtSuspendProcess(HANDLE Process){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtSuspendProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtSuspendProcess(Process);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtSuspendProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtTraceEvent(HANDLE TraceHandle, ULONG Flags, ULONG FieldSize, PVOID Fields){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtTraceEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtTraceEvent(TraceHandle,Flags,FieldSize,Fields);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtTraceEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtTranslateFilePath(PFILE_PATH InputFilePath, ULONG OutputType, PFILE_PATH OutputFilePath, ULONG OutputFilePathLength){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtTranslateFilePath,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtTranslateFilePath(InputFilePath,OutputType,OutputFilePath,OutputFilePathLength);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtTranslateFilePath.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtWaitForDebugEvent(HANDLE DebugObjectHandle, BOOLEAN Alertable, PLARGE_INTEGER Timeout, PVOID WaitStateChange){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtWaitForDebugEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtWaitForDebugEvent(DebugObjectHandle,Alertable,Timeout,WaitStateChange);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtWaitForDebugEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtCreateKeyedEvent(PHANDLE handle, ACCESS_MASK access, POBJECT_ATTRIBUTES attr, ULONG flags){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtCreateKeyedEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtCreateKeyedEvent(handle,access,attr,flags);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtCreateKeyedEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtOpenKeyedEvent(PHANDLE handle, ACCESS_MASK access, POBJECT_ATTRIBUTES attr){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtOpenKeyedEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtOpenKeyedEvent(handle,access,attr);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtOpenKeyedEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtReleaseKeyedEvent(HANDLE handle, PVOID key, BOOLEAN alertable, PLARGE_INTEGER mstimeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtReleaseKeyedEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtReleaseKeyedEvent(handle,key,alertable,mstimeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtReleaseKeyedEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtWaitForKeyedEvent(HANDLE handle, PVOID key, BOOLEAN alertable, PLARGE_INTEGER mstimeout){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtWaitForKeyedEvent,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtWaitForKeyedEvent(handle,key,alertable,mstimeout);
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtWaitForKeyedEvent.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
NTSTATUS newNtQueryPortInformationProcess(){
	NTSTATUS ntStatus;
	PWCHAR processString;
	PWCHAR fullString;
	PWCHAR timeBuffer;
	PWCHAR pidBuffer;
	ULONG pid;
	
	LARGE_INTEGER mSec, currTimeStamp;
	ULONG timeIncrement;
	char aTime[150];
	
	PIO_STACK_LOCATION stackLoc;
	PIRP Irp;
	
	UNICODE_STRING uProcess = {0};
	UNICODE_STRING uFullString = {0};
	UNICODE_STRING uTime = {0};
	UNICODE_STRING uPid= {0};
	
	ANSI_STRING ansiTime;
	counter+=1;
	uProcess.MaximumLength = 150 * sizeof(WCHAR);
	uFullString.MaximumLength = 950 * sizeof(WCHAR);
	uPid.MaximumLength = 70 * sizeof(WCHAR);
	
	uPid.Length = 0;	
	uProcess.Length = 0;
	uFullString.Length = 0;
	
	pidBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 70, 'idpb');
	processString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'icpr');
	fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 950, 'icfs');
	if (fullString == NULL) {
		DbgPrint("I was null in newZwProtectVirtualMemory \r\n");
		fullString = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 550, 'icfs');
	}	
	
	uProcess.Buffer = processString;
	uFullString.Buffer = fullString;
	uPid.Buffer = pidBuffer;
	
	timeIncrement = KeQueryTimeIncrement();
	KeQueryTickCount(&currTimeStamp);
	mSec.QuadPart = (currTimeStamp.QuadPart * timeIncrement) / 10000;
	timeBuffer = (PWCHAR)ExAllocatePoolWithTag(PagedPool, sizeof(WCHAR) * 150, 'offb');
	uTime.Length = 0;
	uTime.MaximumLength = 150 * sizeof(WCHAR);
	uTime.Buffer = timeBuffer;
	RtlStringCbPrintfA(aTime, sizeof(char) * 150, "%llu", mSec.QuadPart);
	RtlInitAnsiString(&ansiTime, aTime);
	RtlAnsiStringToUnicodeString(&uTime, &ansiTime, TRUE);
	RtlAppendUnicodeToString(&uFullString, L"Time=");
	RtlAppendUnicodeStringToString(&uFullString, &uTime);
	RtlAppendUnicodeToString(&uFullString, L",");
	
	pid = getPIDByHandle(NtCurrentProcess());
	RtlIntegerToUnicodeString(pid, 10, &uPid);
	RtlAppendUnicodeToString(&uFullString, L"Pid=");
	RtlAppendUnicodeStringToString(&uFullString, &uPid);
	RtlAppendUnicodeToString(&uFullString, L",");	
	
	getPIDByThreadHandle(NtCurrentProcess(), &uProcess);
	RtlAppendUnicodeToString(&uFullString, L"MethodName=NtQueryPortInformationProcess,"); 
	RtlAppendUnicodeToString(&uFullString, L"ProcessName=");
	RtlAppendUnicodeStringToString(&uFullString, &uProcess);

	//ntStatus = oldZwMapViewOfSection(SectionHandle,ProcessHandle,BaseAddress,ZeroBits,CommitSize,SectionOffset,ViewSize,InheritDisposition,AllocationType,Win32Protect);
	ntStatus = oldNtQueryPortInformationProcess();
	
	RtlInitEmptyUnicodeString(&uProcess, processString, sizeof(WCHAR) * 150);
	//RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\ZwMapViewOfSection.txt");
	RtlAppendUnicodeToString(&uProcess, L"\\SystemRoot\\d\\NtQueryPortInformationProcess.txt");
	RtlAppendUnicodeToString(&uFullString, L"\r\n\0");
	
	//driverWriteFile(&uFullString, &uProcess, *oldZwOpenFile);
	if (WRITE_DIRECT == 0) {
		Irp = IoAllocateIrp((CCHAR) 1, FALSE);
		if (Irp != NULL) {
			Irp->Flags = IRP_BUFFERED_IO | IRP_WRITE_OPERATION;
			Irp->AssociatedIrp.SystemBuffer = processString;
			Irp->UserBuffer = fullString;
			stackLoc = IoGetNextIrpStackLocation(Irp);
			stackLoc->MajorFunction = IRP_MJ_WRITE;
			stackLoc->MinorFunction = 0;
			if (buddyDevice != NULL) {
				IoCallDriver(buddyDevice, Irp);
			}
			IoFreeIrp(Irp);
		}
	}
	else {
		driverWriteFile(&uFullString, &uProcess);
	}
	ExFreePool(processString);
	ExFreePool(fullString);
	ExFreePool(timeBuffer);
	ExFreePool(pidBuffer);
	return ntStatus;
}		
